<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Multi-Application Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a56db;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --bg-light: #f8fafc;
            --sidebar-width: 280px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Two-Column Layout: Sidebar + Main Content */
        .layout-wrapper {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h2 {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .sidebar-header p {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-top: 4px;
        }

        .sidebar-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 12px;
            background: var(--bg-light);
            border-bottom: 1px solid var(--border);
        }

        .mini-stat {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .mini-stat-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .mini-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .app-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .app-list-item {
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 6px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .app-list-item:hover {
            background: var(--bg-light);
            border-color: var(--border);
        }

        .app-list-item.active {
            background: #eff6ff;
            border-color: var(--primary);
        }

        .app-list-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-list-item-type {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .app-list-item-confidence {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 6px;
        }

        .conf-high {
            background: #d1fae5;
            color: var(--success);
        }

        .conf-medium {
            background: #fef3c7;
            color: var(--warning);
        }

        .conf-low {
            background: #fee2e2;
            color: var(--danger);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-dot.success {
            background: var(--success);
        }

        .status-dot.warning {
            background: var(--warning);
        }

        .status-dot.error {
            background: var(--danger);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .content-header {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .content-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .content-header-meta {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .confidence-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
        }

        .confidence-high {
            background: #d1fae5;
            color: var(--success);
        }

        .confidence-medium {
            background: #fef3c7;
            color: var(--warning);
        }

        .confidence-low {
            background: #fee2e2;
            color: var(--danger);
        }

        /* Tabs */
        .content-tabs {
            display: flex;
            gap: 4px;
            background: white;
            padding: 8px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 6px;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--bg-light);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Content Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            padding: 24px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Files Grid */
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
        }

        .file-card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 14px;
            border-left: 4px solid var(--primary);
        }

        .file-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 6px;
            word-break: break-all;
        }

        .file-role {
            display: inline-block;
            background: #dbeafe;
            color: var(--primary);
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Relationship Cards */
        .relationship-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border: 1px solid #90caf9;
            border-radius: 10px;
            padding: 18px;
            margin-bottom: 14px;
        }

        .rel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .rel-table {
            background: white;
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 600;
            border: 2px solid var(--primary);
            color: var(--primary);
            font-size: 0.85rem;
        }

        .rel-arrow {
            color: var(--primary);
            font-size: 1.1rem;
        }

        .rel-explanation {
            font-size: 0.9rem;
            color: var(--text-dark);
            line-height: 1.6;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid var(--primary-light);
        }

        .rel-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 10px;
        }

        /* Business Rules */
        .rules-file-section {
            margin-bottom: 20px;
        }

        .rules-file-header {
            font-weight: 600;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-light);
            border-radius: 6px;
        }

        .rule-item {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .rule-item.critical {
            background: #fff1f2;
            border: 1px solid #fecdd3;
        }

        .rule-item.warning {
            background: #fffbeb;
            border: 1px solid #fde68a;
        }

        .rule-item.safe {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
        }

        .rule-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .rule-label.critical {
            color: #be123c;
        }

        .rule-label.warning {
            color: #b45309;
        }

        .rule-label.safe {
            color: #15803d;
        }

        .rule-message {
            font-size: 0.85rem;
        }

        /* Purpose Section */
        .purpose-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 20px;
        }

        .purpose-point {
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .purpose-point::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: var(--primary);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .no-selection {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="layout-wrapper">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üìä Multi-App Analysis</h2>
                <p>Select an application to view details</p>
            </div>
            <div class="sidebar-stats">
                <div class="mini-stat">
                    <div class="mini-stat-value" id="total-folders">0</div>
                    <div class="mini-stat-label">Apps</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-stat-value" id="total-files">0</div>
                    <div class="mini-stat-label">Files</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-stat-value" id="total-relationships">0</div>
                    <div class="mini-stat-label">Relations</div>
                </div>
                <div class="mini-stat">
                    <div class="mini-stat-value" id="avg-confidence">0%</div>
                    <div class="mini-stat-label">Avg Conf</div>
                </div>
            </div>
            <div class="app-list" id="app-list">
                <!-- App list items will be inserted here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <div class="no-selection" id="no-selection">
                <div>
                    <div class="empty-state-icon">üìÅ</div>
                    <h3>Select an Application</h3>
                    <p>Choose a folder from the sidebar to view its analysis.</p>
                </div>
            </div>

            <div id="app-detail" style="display: none;">
                <!-- Content Header -->
                <div class="content-header">
                    <div>
                        <h1 id="detail-app-type">Application Type</h1>
                        <div class="content-header-meta" id="detail-folder-name">Folder: folder_name</div>
                    </div>
                    <div class="confidence-badge" id="detail-confidence">0% Confidence</div>
                </div>

                <!-- Tabs -->
                <div class="content-tabs">
                    <button class="tab-btn active" data-tab="overview">Overview</button>
                    <button class="tab-btn" data-tab="files">Files</button>
                    <button class="tab-btn" data-tab="relationships">Relationships</button>
                    <button class="tab-btn" data-tab="rules">Business Rules</button>
                </div>

                <!-- Tab Contents -->
                <div id="tab-overview" class="tab-content active">
                    <!-- Purpose Card -->
                    <div class="card">
                        <div class="card-title">üéØ Application Purpose</div>
                        <div class="purpose-box" id="purpose-content">
                            <div class="purpose-point">No purpose analysis available.</div>
                        </div>
                    </div>
                    <!-- Patterns Card -->
                    <div class="card">
                        <div class="card-title">üîç Patterns Detected</div>
                        <div id="patterns-content" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span style="color: var(--text-muted);">No patterns detected.</span>
                        </div>
                    </div>
                </div>

                <div id="tab-files" class="tab-content">
                    <div class="card">
                        <div class="card-title">üìÑ CSV Files</div>
                        <div class="files-grid" id="files-content">
                            <!-- File cards -->
                        </div>
                    </div>
                </div>

                <div id="tab-relationships" class="tab-content">
                    <div class="card">
                        <div class="card-title">üîó File Relationships</div>
                        <div id="relationships-content">
                            <div style="color: var(--text-muted);">No relationships detected.</div>
                        </div>
                    </div>
                </div>

                <div id="tab-rules" class="tab-content">
                    <div class="card">
                        <div class="card-title">üìè Observed Business Rules</div>
                        <div id="rules-content">
                            <div style="color: var(--text-muted);">No business rules available.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let analysisData = null;
        let selectedFolder = null;

        function loadAnalysisData() {
            console.log('Loading analysis data...');
            let data = null;

            const urlParams = new URLSearchParams(window.location.search);
            const analysisDataParam = urlParams.get('data');

            if (analysisDataParam) {
                try {
                    data = JSON.parse(decodeURIComponent(analysisDataParam));
                    console.log('Loaded data from URL parameter');
                } catch (error) {
                    console.error('Error parsing data from URL:', error);
                }
            }

            if (!data) {
                const sessionData = sessionStorage.getItem('multi_folder_analysis');
                if (sessionData) {
                    try {
                        data = JSON.parse(sessionData);
                        console.log('Loaded data from sessionStorage');
                    } catch (error) {
                        console.error('Error parsing data from sessionStorage:', error);
                    }
                }
            }

            if (data && data.folders && Object.keys(data.folders).length > 0) {
                analysisData = data;
                renderSidebar();
                // Auto-select first folder
                const firstFolder = Object.keys(data.folders)[0];
                selectFolder(firstFolder);
            } else {
                console.warn('No analysis data found');
            }
        }

        function renderSidebar() {
            const folders = analysisData.folders;
            const folderCount = Object.keys(folders).length;
            let totalFiles = 0, totalRelationships = 0, totalConfidence = 0;

            Object.values(folders).forEach(f => {
                totalFiles += f.csv_files?.length || 0;
                totalRelationships += f.file_relationships?.length || 0;
                totalConfidence += f.application_type?.confidence || 0;
            });

            const avgConfidence = folderCount > 0 ? Math.round(totalConfidence / folderCount) : 0;

            document.getElementById('total-folders').textContent = folderCount;
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('total-relationships').textContent = totalRelationships;
            document.getElementById('avg-confidence').textContent = avgConfidence + '%';

            const appList = document.getElementById('app-list');
            appList.innerHTML = '';

            Object.entries(folders).forEach(([folderName, folderData]) => {
                const appType = folderData.application_type || {};
                const confidence = appType.confidence || 0;
                const confClass = confidence >= 80 ? 'conf-high' : confidence >= 60 ? 'conf-medium' : 'conf-low';
                const statusClass = (folderData.status || 'success') === 'success' ? 'success' : 'warning';

                const item = document.createElement('div');
                item.className = 'app-list-item';
                item.dataset.folder = folderName;
                item.innerHTML = `
                    <div class="app-list-item-name">
                        <span class="status-dot ${statusClass}"></span>
                        ${folderName}
                    </div>
                    <div class="app-list-item-type">${appType.application_type || 'Unknown'}</div>
                    <span class="app-list-item-confidence ${confClass}">${confidence}%</span>
                `;
                item.onclick = () => selectFolder(folderName);
                appList.appendChild(item);
            });
        }

        function selectFolder(folderName) {
            selectedFolder = folderName;
            const folderData = analysisData.folders[folderName];
            if (!folderData) return;

            // Update sidebar active state
            document.querySelectorAll('.app-list-item').forEach(el => {
                el.classList.toggle('active', el.dataset.folder === folderName);
            });

            // Show detail panel
            document.getElementById('no-selection').style.display = 'none';
            document.getElementById('app-detail').style.display = 'block';

            const appType = folderData.application_type || {};
            const confidence = appType.confidence || 0;
            const confClass = confidence >= 80 ? 'confidence-high' : confidence >= 60 ? 'confidence-medium' : 'confidence-low';

            document.getElementById('detail-app-type').textContent = appType.application_type || 'Unknown Application';
            document.getElementById('detail-folder-name').textContent = 'üìÅ ' + folderName;
            const confBadge = document.getElementById('detail-confidence');
            confBadge.textContent = confidence + '% Confidence';
            confBadge.className = 'confidence-badge ' + confClass;

            // Render tabs content
            renderOverviewTab(folderData, appType);
            renderFilesTab(folderData);
            renderRelationshipsTab(folderData);
            renderRulesTab(folderData);

            // Reset to overview tab
            switchTab('overview');
        }

        function renderOverviewTab(folderData, appType) {
            // Purpose
            const purposeEl = document.getElementById('purpose-content');
            const purpose = folderData.application_purpose;
            if (purpose) {
                const points = purpose.explanation_points || [];
                if (points.length > 0) {
                    purposeEl.innerHTML = points.map(p => `<div class="purpose-point">${p}</div>`).join('');
                } else if (purpose.line1 || purpose.line2) {
                    let html = '';
                    if (purpose.line1) html += `<div class="purpose-point">${purpose.line1}</div>`;
                    if (purpose.line2) html += `<div class="purpose-point">${purpose.line2}</div>`;
                    purposeEl.innerHTML = html;
                } else {
                    purposeEl.innerHTML = '<div class="purpose-point">Application purpose analysis not available.</div>';
                }
            } else {
                purposeEl.innerHTML = '<div class="purpose-point">Application purpose analysis not available.</div>';
            }

            // Patterns
            const patternsEl = document.getElementById('patterns-content');
            const patterns = appType.patterns_detected || [];
            if (patterns.length > 0) {
                patternsEl.innerHTML = patterns.map(p =>
                    `<span style="background: #dbeafe; color: var(--primary); padding: 6px 14px; border-radius: 16px; font-size: 0.85rem; font-weight: 600;">${p}</span>`
                ).join('');
            } else {
                patternsEl.innerHTML = '<span style="color: var(--text-muted);">No patterns detected.</span>';
            }
        }

        function renderFilesTab(folderData) {
            const filesEl = document.getElementById('files-content');
            const files = folderData.csv_files || [];
            const roles = folderData.file_roles || {};

            if (files.length === 0) {
                filesEl.innerHTML = '<div style="color: var(--text-muted);">No CSV files found.</div>';
                return;
            }

            filesEl.innerHTML = files.map(f => `
                <div class="file-card">
                    <div class="file-name">${f}</div>
                    <span class="file-role">${roles[f] || 'Data File'}</span>
                </div>
            `).join('');
        }

        function renderRelationshipsTab(folderData) {
            const relEl = document.getElementById('relationships-content');
            const rels = folderData.file_relationships || [];

            if (rels.length === 0) {
                relEl.innerHTML = '<div style="color: var(--text-muted); padding: 20px;">No relationships detected between files.</div>';
                return;
            }

            relEl.innerHTML = rels.map(rel => {
                const file1 = rel.parent_file || rel.file1 || 'File A';
                const file2 = rel.child_file || rel.file2 || 'File B';
                const col1 = rel.parent_column || rel.column || '';
                const col2 = rel.child_column || rel.column || '';
                const shortExp = rel.short_explanation || `${file1}.${col1} links to ${file2}.${col2}`;
                const overlap = rel.overlap_info?.overlap_percentage || (rel.overlap_info?.overlap_ratio ? Math.round(rel.overlap_info.overlap_ratio * 100) : 0);

                return `
                    <div class="relationship-card">
                        <div class="rel-header">
                            <span class="rel-table">${file1}</span>
                            <span class="rel-arrow">‚Üî</span>
                            <span class="rel-table">${file2}</span>
                        </div>
                        <div class="rel-explanation">${shortExp}</div>
                        <div class="rel-meta">
                            Column: <strong>${col1}</strong> | Type: ${rel.relationship_type || 'Linked'} | Overlap: ${overlap}%
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRulesTab(folderData) {
            const rulesEl = document.getElementById('rules-content');
            const summaries = folderData.business_rules_summaries || {};

            if (Object.keys(summaries).length === 0) {
                rulesEl.innerHTML = '<div style="color: var(--text-muted); padding: 20px;">Business rules analysis not available.</div>';
                return;
            }

            let html = '';
            Object.entries(summaries).forEach(([filename, summary]) => {
                if (!summary || typeof summary !== 'object') return;

                const criticalCols = summary.critical_columns || [];
                const warningCols = summary.warning_columns || [];
                const safeCount = summary.safe_count || summary.total_columns || 0;
                const totalCols = summary.total_columns || 0;

                html += `
                    <div class="rules-file-section">
                        <div class="rules-file-header">üìÑ ${filename} <span style="font-weight: 400; color: var(--text-muted);">(${totalCols} columns)</span></div>
                `;

                criticalCols.forEach(col => {
                    html += `
                        <div class="rule-item critical">
                            <div class="rule-label critical">Critical: ${col.display_name || col.column_name || 'Unknown'}</div>
                            <div class="rule-message">${col.user_message || 'Attention required'}</div>
                        </div>
                    `;
                });

                warningCols.forEach(col => {
                    html += `
                        <div class="rule-item warning">
                            <div class="rule-label warning">Warning: ${col.display_name || col.column_name || 'Unknown'}</div>
                            <div class="rule-message">${col.user_message || 'Review suggested'}</div>
                        </div>
                    `;
                });

                if (criticalCols.length === 0 && warningCols.length === 0) {
                    html += `
                        <div class="rule-item safe">
                            <div class="rule-label safe">‚úÖ All ${safeCount} fields verified successfully</div>
                        </div>
                    `;
                }

                html += '</div>';
            });

            rulesEl.innerHTML = html || '<div style="color: var(--text-muted); padding: 20px;">Business rules analysis not available.</div>';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabId);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === 'tab-' + tabId);
            });
        }

        // Tab click handlers
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.tab));
        });

        document.addEventListener('DOMContentLoaded', loadAnalysisData);
    </script>
</body>

</html>