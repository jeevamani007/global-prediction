<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Account Number Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            border: none !important;
            outline: none !important;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #2d3748;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .header {
            text-align: center;
            padding: 30px 20px;
            margin: 0;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header p {
            font-size: 0.95rem;
            opacity: 0.9;
        }
        
        .card {
            background: white;
            border-radius: 0;
            box-shadow: none;
            padding: 24px;
            margin: 0;
            width: 100%;
        }
        
        .status-banner {
            padding: 24px;
            border-radius: 0;
            margin: 0 0 24px 0;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .status-banner.success {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .status-banner.error {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .status-banner.warning {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #744210;
        }
        
        .status-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
        }
        
        .status-content h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .status-content p {
            font-size: 0.95rem;
            opacity: 0.95;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .info-card {
            background: #f7fafc;
            padding: 18px;
            border-radius: 0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .info-card.success-bg {
            background: linear-gradient(135deg, #e6f7ff 0%, #d4edff 100%);
        }
        
        .info-card.warning-bg {
            background: linear-gradient(135deg, #fff7e6 0%, #ffe7ba 100%);
        }
        
        .info-card.error-bg {
            background: linear-gradient(135deg, #fff1f0 0%, #ffd6d6 100%);
        }
        
        .info-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .info-card-icon {
            font-size: 1.5rem;
        }
        
        .info-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.9rem;
        }
        
        .info-label {
            color: #718096;
            font-weight: 500;
        }
        
        .info-value {
            color: #2d3748;
            font-weight: 600;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge.success {
            background: #48bb78;
            color: white;
        }
        
        .badge.error {
            background: #f56565;
            color: white;
        }
        
        .badge.warning {
            background: #ed8936;
            color: white;
        }
        
        .list-clean {
            list-style: none;
            padding: 0;
        }
        
        .list-clean li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .list-clean li::before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
            margin: 24px 0;
        }
        
        .risk-assessment {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 24px;
            border-radius: 0;
            margin: 0 0 20px 0;
        }
        
        .risk-assessment.high {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            color: white;
        }
        
        .risk-assessment.low {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            color: white;
        }
        
        .action-box {
            background: #f7fafc;
            padding: 18px;
            border-radius: 0;
            margin-top: 16px;
        }
        
        .action-box h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }
        
        @media (max-width: 640px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .card {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Banking Account Validation</h1>
            <p>Comprehensive Account Analysis & Risk Assessment</p>
        </div>
        
        <div class="card">
            <div id="purposeChart" style="width:100%;height:320px;margin-bottom:24px;display:none;"></div>
            <div id="content">Loading validation results...</div>
        </div>
    </div>

    <script>
        function renderContent(data, checkData, statusData, missingData, balanceData, kycData, customerIdData, transactionData, debitCreditData, fraudData, foreignKeyData, purposeData, finalDecisionData, riskAssessmentData, columnPurposeReport) {
            // Use risk assessment and final decision from backend
            const riskLevel = riskAssessmentData?.risk_level || "HIGH";
            const decisionText = finalDecisionData?.decision || "REJECT";
            const reasonText = finalDecisionData?.reason || "Validation failed.";

            // Main status banner
            let statusBannerHtml = "";
            if (checkData) {
                const hasAccount = checkData.has_account_number_column;
                const decision = checkData.best_match_decision;
                const column = checkData.best_match_column;
                const probability = checkData.best_match_probability;
                
                if (hasAccount && decision === "match") {
                    statusBannerHtml = `
                        <div class="status-banner success">
                            <div class="status-icon">‚úÖ</div>
                            <div class="status-content">
                                <h3>Account Number Detected</h3>
                                <p><strong>Column:</strong> ${column || "-"} &nbsp;|&nbsp; <strong>Confidence:</strong> ${probability ?? "-"}%</p>
                            </div>
                        </div>
                    `;
                } else if (hasAccount && decision === "not_match") {
                    statusBannerHtml = `
                        <div class="status-banner error">
                            <div class="status-icon">‚ùå</div>
                            <div class="status-content">
                                <h3>Account Number Invalid</h3>
                                <p><strong>Column:</strong> ${column || "-"} &nbsp;|&nbsp; <strong>Confidence:</strong> ${probability ?? "-"}%</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusBannerHtml = `
                        <div class="status-banner warning">
                            <div class="status-icon">‚ö†Ô∏è</div>
                            <div class="status-content">
                                <h3>No Account Number Column Detected</h3>
                                <p>The uploaded file does not contain a valid account number column.</p>
                            </div>
                        </div>
                    `;
                }
            }

            // Purpose Detection Display
            let purposeHtml = "";
            if (purposeData && purposeData.primary_purpose) {
                purposeHtml = `
                    <div class="col-card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; margin-bottom:20px; border-left-color:#764ba2;">
                        <h3 style="color:white; margin-bottom:12px;">üéØ Dataset Purpose Detection</h3>
                        <p style="font-size:1.1rem; font-weight:600; margin-bottom:8px;"><b>Primary Purpose:</b> ${purposeData.primary_purpose}</p>
                        <p style="font-size:0.95rem; opacity:0.95; margin-bottom:8px;"><b>Confidence:</b> ${purposeData.purpose_confidence}%</p>
                        <p style="font-size:0.95rem; opacity:0.95; margin-top:12px;"><b>Purpose Statement:</b> ${purposeData.purpose_statement}</p>
                        ${purposeData.detected_purposes && purposeData.detected_purposes.length > 1 ? `
                            <p style="font-size:0.9rem; opacity:0.9; margin-top:12px;"><b>Other Detected Purposes:</b></p>
                            <ul style="margin-top:8px; padding-left:20px;">
                                ${purposeData.detected_purposes.map((p, idx) => 
                                    idx === 0 ? '' : `<li>${p} (${purposeData.confidence_scores[idx]}%)</li>`
                                ).filter(x => x).join("")}
                            </ul>
                        ` : ""}
                    </div>
                `;
            }

            // Column purpose explanations (Account / Customer / Transaction / Withdrawal‚ÄëDeposit‚ÄëTransfer)
            let columnPurposeHtml = "";
            if (columnPurposeReport && columnPurposeReport.explanations) {
                const ex = columnPurposeReport.explanations;
                columnPurposeHtml = `
                    <div class="col-card" style="background:#f7fafc;margin-bottom:20px;border-left:4px solid #667eea;">
                        <h3 style="margin-bottom:10px;">üìö Column Purpose Summary</h3>
                        <p style="font-size:0.95rem;margin-bottom:8px;"><b>Account / Customer Details:</b> ${ex.account_customer || ""}</p>
                        <p style="font-size:0.95rem;margin-bottom:8px;"><b>Transaction Columns:</b> ${ex.transaction || ""}</p>
                        <p style="font-size:0.95rem;margin-bottom:4px;"><b>Withdrawal / Deposit / Transfer:</b> ${ex.wdt || ""}</p>
                    </div>
                `;
            }

            // Account Number Validation Rules
            let accountRulesHtml = "";
            if (data && data.account_like_columns && Array.isArray(data.account_like_columns) && data.account_like_columns.length > 0) {
                data.account_like_columns.forEach((colData, idx) => {
                    const rules = colData.rules || {};
                    const digitsOnly = rules.digits_only_ratio !== undefined ? rules.digits_only_ratio : 0;
                    const lengthOk = rules.length_6_16_ratio !== undefined ? rules.length_6_16_ratio : 0;
                    const unique = rules.unique_ratio !== undefined ? rules.unique_ratio : 0;
                    const notNull = rules.not_null_ratio !== undefined ? rules.not_null_ratio : 0;
                    const noSymbols = rules.no_symbol_ratio !== undefined ? rules.no_symbol_ratio : 0;
                    const randomized = rules.randomized !== undefined ? rules.randomized : false;
                    
                    accountRulesHtml += `
                        <div class="col-card" style="background:#e6f7ff; border-left-color:#1890ff; margin-bottom:16px;">
                            <h3>üîπ STEP-2: Account Number Detection (ML + RULES) - ${colData.column || 'Unknown'}</h3>
                            <p><b>Column:</b> ${colData.column || 'N/A'}</p>
                            <p><b>Decision:</b> ${colData.decision === 'match' ? '‚úÖ MATCH' : '‚ùå NOT MATCH'}</p>
                            <p><b>Probability:</b> ${colData.probability_account_number || 0}%</p>
                            <p><b>Validation Rules:</b></p>
                            <ul class="list-clean" style="margin-top:8px;">
                                <li>‚úî Digits only: ${digitsOnly >= 0.9 ? '‚úÖ' : '‚ùå'} (${(digitsOnly * 100).toFixed(1)}%)</li>
                                <li>‚úî Length: 6‚Äì16: ${lengthOk >= 0.9 ? '‚úÖ' : '‚ùå'} (${(lengthOk * 100).toFixed(1)}%)</li>
                                <li>‚úî Unique: ${unique >= 0.85 ? '‚úÖ' : '‚ùå'} (${(unique * 100).toFixed(1)}%)</li>
                                <li>‚úî NOT NULL: ${notNull >= 0.95 ? '‚úÖ' : '‚ùå'} (${(notNull * 100).toFixed(1)}%)</li>
                                <li>‚úî No symbols: ${noSymbols >= 0.95 ? '‚úÖ' : '‚ùå'} (${(noSymbols * 100).toFixed(1)}%)</li>
                                <li>‚úî Randomized: ${randomized ? '‚úÖ' : '‚ùå'}</li>
                            </ul>
                            ${colData.sample_violations && Array.isArray(colData.sample_violations) && colData.sample_violations.length > 0 ? `
                                <p style="margin-top:12px;"><b>Sample Violations:</b></p>
                                <ul class="list-clean">
                                    ${colData.sample_violations.slice(0, 5).map(v => `<li>${v}</li>`).join("")}
                                </ul>
                            ` : ""}
                        </div>
                    `;
                });
            }

            // Info grid
            let infoGridHtml = '<div class="info-grid">';
            
            // Account Status Card
            if (statusData) {
                if (statusData.has_status_column) {
                    infoGridHtml += `
                        <div class="info-card success-bg">
                            <div class="info-card-header">
                                <span class="info-card-icon">üìä</span>
                                <span class="info-card-title">Account Status</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status Column</span>
                                <span class="info-value">${statusData.status_column}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Active Accounts</span>
                                <span class="info-value">${statusData.active_count}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Inactive Accounts</span>
                                <span class="info-value">${statusData.inactive_count}</span>
                            </div>
                        </div>
                    `;
                } else {
                    infoGridHtml += `
                        <div class="info-card warning-bg">
                            <div class="info-card-header">
                                <span class="info-card-icon">‚ö†Ô∏è</span>
                                <span class="info-card-title">Account Status Missing</span>
                            </div>
                            <p style="color: #744210; font-size: 0.9rem;">No account status column (active/inactive) found in the file.</p>
                        </div>
                    `;
                }
            }
            
            // Mandatory Columns Check (STEP-5)
            if (missingData) {
                const mandatoryMissing = missingData.missing_mandatory || [];
                const optionalMissing = missingData.missing_optional || [];
                const allMandatoryPresent = missingData.all_mandatory_present;
                const cardClass = allMandatoryPresent ? 'success-bg' : 'error-bg';
                const icon = allMandatoryPresent ? '‚úÖ' : '‚ùå';
                infoGridHtml += `
                    <div class="info-card ${cardClass}">
                        <div class="info-card-header">
                            <span class="info-card-icon">${icon}</span>
                            <span class="info-card-title">Mandatory Columns Check</span>
                        </div>
                        ${allMandatoryPresent ? `
                            <p style="color: #155724; font-size: 0.9rem;">‚úÖ All mandatory columns present</p>
                        ` : `
                            <p style="color: #721c24; font-size: 0.9rem;"><b>Missing Mandatory:</b> ${mandatoryMissing.join(", ")}</p>
                        `}
                        ${optionalMissing.length > 0 ? `
                            <p style="color: #856404; font-size: 0.85rem; margin-top:8px;"><b>Missing Optional:</b> ${optionalMissing.join(", ")}</p>
                        ` : ''}
                    </div>
                `;
            }
            
            // Balance Card
            if (balanceData?.has_balance_column) {
                infoGridHtml += `
                    <div class="info-card success-bg">
                        <div class="info-card-header">
                            <span class="info-card-icon">üí∞</span>
                            <span class="info-card-title">Balance Analysis</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Balance Column</span>
                            <span class="info-value">${balanceData.balance_column}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Zero/Negative</span>
                            <span class="info-value">${balanceData.zero_or_negative_count} / ${balanceData.total_rows}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Percentage</span>
                            <span class="info-value">${balanceData.zero_or_negative_pct}%</span>
                        </div>
                    </div>
                `;
            } else {
                infoGridHtml += `
                    <div class="info-card warning-bg">
                        <div class="info-card-header">
                            <span class="info-card-icon">‚ö†Ô∏è</span>
                            <span class="info-card-title">Balance Column Missing</span>
                        </div>
                        <p style="color: #744210; font-size: 0.9rem;">Balance is required to evaluate transaction readiness.</p>
                    </div>
                `;
            }
            
            // KYC Card
            if (kycData) {
                const cardClass = kycData.kyc_verified ? 'success-bg' : 'warning-bg';
                const icon = kycData.kyc_verified ? '‚úÖ' : '‚ö†Ô∏è';
                infoGridHtml += `
                    <div class="info-card ${cardClass}">
                        <div class="info-card-header">
                            <span class="info-card-icon">${icon}</span>
                            <span class="info-card-title">KYC Status</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">User Name</span>
                            <span class="info-value">${kycData.has_user_name ? 'Present' : 'Missing'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Completeness</span>
                            <span class="info-value">${kycData.kyc_completeness}%</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status</span>
                            <span class="badge ${kycData.kyc_verified ? 'success' : 'warning'}">${kycData.kyc_verified ? 'Verified' : 'Pending'}</span>
                        </div>
                    </div>
                `;
            }
            
            // Customer ID Card
            if (customerIdData) {
                const cardClass = customerIdData.decision === 'found' ? 'success-bg' : 'warning-bg';
                const icon = customerIdData.decision === 'found' ? '‚úÖ' : '‚ö†Ô∏è';
                infoGridHtml += `
                    <div class="info-card ${cardClass}">
                        <div class="info-card-header">
                            <span class="info-card-icon">${icon}</span>
                            <span class="info-card-title">STEP-3: Customer ID Validation (7 Rules)</span>
                        </div>
                        ${customerIdData.column_exists ? `
                            <div class="info-item">
                                <span class="info-label">Column</span>
                                <span class="info-value">${customerIdData.column_name}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Confidence</span>
                                <span class="info-value">${customerIdData.probability_customer_id}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Rules Passed</span>
                                <span class="info-value">${customerIdData.rules_passed} / ${customerIdData.rules_total}</span>
                            </div>
                        ` : '<p style="font-size: 0.9rem;">Customer ID column not found</p>'}
                    </div>
                `;
            }
            
            infoGridHtml += '</div>';

            // Foreign Key / Linking Check (STEP-4)
            let foreignKeyHtml = "";
            if (foreignKeyData && foreignKeyData.can_check) {
                const fkMismatch = foreignKeyData.fk_mismatch || false;
                const linkingStatus = foreignKeyData.linking_valid ? 'success' : (fkMismatch ? 'error' : 'warning');
                const linkingIcon = foreignKeyData.linking_valid ? '‚úÖ' : (fkMismatch ? '‚ùå' : '‚ö†Ô∏è');
                const bgColor = foreignKeyData.linking_valid ? '#d4edda' : (fkMismatch ? '#f8d7da' : '#fff3cd');
                const borderColor = foreignKeyData.linking_valid ? '#28a745' : (fkMismatch ? '#dc3545' : '#ffc107');
                foreignKeyHtml = `
                    <div class="col-card" style="background:${bgColor}; border-left-color:${borderColor}; margin-bottom:20px;">
                        <h3>üîπ STEP-4: Foreign Key / Linking Check</h3>
                        <p><b>Account Column:</b> ${foreignKeyData.account_column || 'N/A'}</p>
                        <p><b>Customer Column:</b> ${foreignKeyData.customer_column || 'N/A'}</p>
                        <p><b>Relationship Type:</b> ${foreignKeyData.relationship_type || 'UNKNOWN'}</p>
                        <p><b>Total Accounts:</b> ${foreignKeyData.total_accounts}</p>
                        <p><b>Total Customers:</b> ${foreignKeyData.total_customers}</p>
                        ${foreignKeyData.accounts_per_customer ? `<p><b>Accounts per Customer:</b> ${foreignKeyData.accounts_per_customer}</p>` : ''}
                        <p><b>Missing Links:</b> ${foreignKeyData.missing_links_count}</p>
                        <p><b>FK Mismatch:</b> ${fkMismatch ? '‚ùå YES (HIGH RISK)' : '‚úÖ NO'}</p>
                        <p><b>Linking Status:</b> ${linkingIcon} ${foreignKeyData.linking_valid ? 'VALID' : 'INVALID'}</p>
                        ${fkMismatch && foreignKeyData.violations && foreignKeyData.violations.length > 0 ? `
                            <p style="margin-top:8px; color:#721c24;"><b>Violations:</b></p>
                            <ul style="margin-top:4px;">
                                ${foreignKeyData.violations.map(v => `<li style="color:#721c24;">${v}</li>`).join("")}
                            </ul>
                        ` : ''}
                        ${!foreignKeyData.linking_valid && !fkMismatch ? '<p style="margin-top:8px; color:#856404;">‚ö†Ô∏è Some accounts or customers have missing links.</p>' : ''}
                    </div>
                `;
            } else if (foreignKeyData && !foreignKeyData.can_check) {
                foreignKeyHtml = `
                    <div class="col-card" style="background:#f8d7da; border-left-color:#dc3545; margin-bottom:20px;">
                        <h3>üîπ STEP-4: Foreign Key / Linking Check</h3>
                        <p>‚ö†Ô∏è Cannot perform linking check - account number or customer ID columns are missing.</p>
                    </div>
                `;
            }

            // Risk Assessment (STEP-7)
            const riskClass = riskLevel === 'HIGH' ? 'high' : 'low';
            const riskFactors = riskAssessmentData?.risk_factors || [];
            const riskHtml = `
                <div class="risk-assessment ${riskClass}">
                    <div class="section-title">üîç STEP-7: Risk Assessment</div>
                    <div class="info-item">
                        <span class="info-label">Risk Level</span>
                        <span class="badge ${riskLevel === 'HIGH' ? 'error' : 'success'}">${riskLevel}</span>
                    </div>
                    ${riskFactors.length > 0 ? `
                        <p style="margin-top: 12px; font-size: 0.95rem;"><b>Risk Factors:</b></p>
                        <ul style="margin-top: 8px; padding-left: 20px;">
                            ${riskFactors.map(factor => `<li>${factor}</li>`).join("")}
                        </ul>
                    ` : '<p style="margin-top: 12px; font-size: 0.95rem;">‚úÖ No risk factors identified.</p>'}
                </div>
            `;

            // Final Decision (STEP-8)
            const decisionClass = decisionText === 'APPROVE' ? 'success' : (decisionText === 'HOLD' ? 'warning' : 'error');
            const decisionHtml = `
                <div class="col-card" style="background:${decisionText === 'APPROVE' ? '#d4edda' : (decisionText === 'HOLD' ? '#fff3cd' : '#f8d7da')}; border-left-color:${decisionText === 'APPROVE' ? '#28a745' : (decisionText === 'HOLD' ? '#ffc107' : '#dc3545')}; margin-bottom:20px;">
                    <h3>üîπ STEP-8: Final Decision</h3>
                    <p><b>Decision:</b> <span class="badge ${decisionClass}">${decisionText}</span></p>
                    <p style="margin-top: 8px;"><b>Reason:</b> ${reasonText}</p>
                </div>
            `;

            // Next Action
            const missingMandatory = missingData?.missing_mandatory || [];
            const kycBelowThreshold = kycData && (!kycData.meets_threshold && kycData.kyc_completeness < 60);
            const missingItems = [];
            if (missingMandatory.includes("account_status")) missingItems.push("Account Status");
            if (missingMandatory.includes("balance")) missingItems.push("Balance");
            if (kycBelowThreshold) missingItems.push(`KYC (current: ${kycData.kyc_completeness}%, required: ‚â•60%)`);
            if (foreignKeyData?.fk_mismatch) missingItems.push("Fix Foreign Key Mismatch");
            
            const nextActionHtml = missingItems.length > 0 ? `
                <div class="action-box">
                    <h4>üìã Next Action Required</h4>
                    <ul class="list-clean">
                        ${missingItems.map(item => `<li>${item}</li>`).join("")}
                    </ul>
                </div>
            ` : decisionText === 'APPROVE' ? `
                <div class="action-box" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                    <h4>‚úÖ Approved</h4>
                    <p style="font-size: 0.9rem; color: #155724;">All validation checks passed. Dataset is ready for banking operations.</p>
                </div>
            ` : '';

            return statusBannerHtml + purposeHtml + columnPurposeHtml + accountRulesHtml + infoGridHtml + foreignKeyHtml + riskHtml + decisionHtml + nextActionHtml;
        }

        (function init() {
            const content = document.getElementById("content");
            try {
                const parsedValidation = JSON.parse(sessionStorage.getItem("accountValidation") || "null");
                const parsedCheck = JSON.parse(sessionStorage.getItem("accountNumberCheck") || "null");
                const parsedStatus = JSON.parse(sessionStorage.getItem("accountStatus") || "null");
                const parsedMissing = JSON.parse(sessionStorage.getItem("missingColumns") || "null");
                const parsedBalance = JSON.parse(sessionStorage.getItem("balanceAnalysis") || "null");
                const parsedKyc = JSON.parse(sessionStorage.getItem("kycVerification") || "null");
                const parsedCustomerId = JSON.parse(sessionStorage.getItem("customerIdValidation") || "null");
                const parsedTransaction = JSON.parse(sessionStorage.getItem("transactionValidation") || "null");
                const parsedDebitCredit = JSON.parse(sessionStorage.getItem("debitCreditValidation") || "null");
                const parsedFraud = JSON.parse(sessionStorage.getItem("fraudDetection") || "null");
                const parsedForeignKey = JSON.parse(sessionStorage.getItem("foreignKeyCheck") || "null");
                const parsedPurpose = JSON.parse(sessionStorage.getItem("purposeDetection") || "null");
                const parsedFinalDecision = JSON.parse(sessionStorage.getItem("finalDecision") || "null");
                const parsedRiskAssessment = JSON.parse(sessionStorage.getItem("riskAssessment") || "null");
                const parsedColumnPurpose = JSON.parse(sessionStorage.getItem("columnPurposeReport") || "null");
                
                if (!parsedValidation && !parsedCheck) {
                    content.innerHTML = `
                        <div class="status-banner warning">
                            <div class="status-icon">‚ö†Ô∏è</div>
                            <div class="status-content">
                                <h3>No Data Available</h3>
                                <p>Please upload a banking file first to see account validation results.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Debug logging
                console.log("Purpose Detection:", parsedPurpose);
                console.log("Foreign Key Check:", parsedForeignKey);
                console.log("Final Decision:", parsedFinalDecision);
                console.log("Risk Assessment:", parsedRiskAssessment);
                console.log("Column Purpose Report:", parsedColumnPurpose);
                
                content.innerHTML = renderContent(parsedValidation, parsedCheck, parsedStatus, parsedMissing, parsedBalance, parsedKyc, parsedCustomerId, parsedTransaction, parsedDebitCredit, parsedFraud, parsedForeignKey, parsedPurpose, parsedFinalDecision, parsedRiskAssessment, parsedColumnPurpose);

                // Render PyCharts / ECharts column‚Äëpurpose chart
                if (parsedColumnPurpose && parsedColumnPurpose.category_counts) {
                    const chartDom = document.getElementById("purposeChart");
                    chartDom.style.display = "block";
                    const chart = echarts.init(chartDom);
                    const counts = parsedColumnPurpose.category_counts;
                    const seriesData = Object.keys(counts).map(k => ({
                        name: k,
                        value: counts[k]
                    }));
                    const option = {
                        title: {
                            text: "Banking Column Purpose Distribution",
                            left: "center",
                            textStyle: { fontSize: 14 }
                        },
                        tooltip: {
                            trigger: "item",
                            formatter: "{b}: {c} cols ({d}%)"
                        },
                        legend: {
                            bottom: 0
                        },
                        series: [{
                            name: "Columns",
                            type: "pie",
                            radius: "55%",
                            center: ["50%", "50%"],
                            data: seriesData,
                            label: {
                                show: true,
                                formatter: "{b}\n{d}%"
                            },
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: "rgba(0, 0, 0, 0.5)"
                                }
                            }
                        }]
                    };
                    chart.setOption(option);
                }
            } catch (e) {
                console.error("Error:", e);
                content.innerHTML = `
                    <div class="status-banner error">
                        <div class="status-icon">‚ùå</div>
                        <div class="status-content">
                            <h3>Error Loading Data</h3>
                            <p>${e.message}</p>
                        </div>
                    </div>
                `;
            }
        })();
    </script>
</body>
</html>