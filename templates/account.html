<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Account Number Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            border: none !important;
            outline: none !important;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #2d3748;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .header {
            text-align: center;
            padding: 40px 20px;
            margin: 0;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            letter-spacing: -0.5px;
        }
        
        .header p {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 400;
            letter-spacing: 0.3px;
        }
        
        .card {
            background: white;
            border-radius: 0;
            box-shadow: none;
            padding: 32px;
            margin: 0;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .status-banner {
            padding: 24px;
            border-radius: 12px;
            margin: 0 0 32px 0;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .status-banner.success {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .status-banner.error {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .status-banner.warning {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #744210;
        }
        
        .status-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
        }
        
        .status-content h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.3px;
        }
        
        .status-content p {
            font-size: 1rem;
            opacity: 0.95;
            line-height: 1.6;
        }
        
        .status-content strong {
            font-weight: 600;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .info-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e2e8f0;
        }
        
        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        
        .info-card.success-bg {
            background: linear-gradient(135deg, #e6f7ff 0%, #d4edff 100%);
        }
        
        .info-card.warning-bg {
            background: linear-gradient(135deg, #fff7e6 0%, #ffe7ba 100%);
        }
        
        .info-card.error-bg {
            background: linear-gradient(135deg, #fff1f0 0%, #ffd6d6 100%);
        }
        
        .info-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .info-card-icon {
            font-size: 1.5rem;
        }
        
        .info-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            font-size: 0.95rem;
            border-bottom: 1px solid rgba(226, 232, 240, 0.5);
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #718096;
            font-weight: 500;
        }
        
        .info-value {
            color: #2d3748;
            font-weight: 600;
            text-align: right;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge.success {
            background: #48bb78;
            color: white;
        }
        
        .badge.error {
            background: #f56565;
            color: white;
        }
        
        .badge.warning {
            background: #ed8936;
            color: white;
        }
        
        .list-clean {
            list-style: none;
            padding: 0;
        }
        
        .list-clean li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .list-clean li::before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
            margin: 24px 0;
        }
        
        .risk-assessment {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 24px;
            border-radius: 12px;
            margin: 0 0 24px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .risk-assessment.high {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            color: white;
        }
        
        .risk-assessment.low {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            color: white;
        }
        
        .action-box {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-top: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .action-box h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }
        
        .col-card {
            margin-bottom: 24px;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .col-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .col-card h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #2d3748;
            line-height: 1.4;
        }

        .col-card p {
            margin: 10px 0;
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.7;
        }

        .col-card b {
            color: #2d3748;
            font-weight: 600;
        }

        .col-card ul {
            margin: 12px 0;
            padding-left: 24px;
        }

        .col-card li {
            margin: 8px 0;
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.6;
        }

        .col-card code {
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            .card {
                padding: 24px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header {
                padding: 24px 16px;
            }
            
            .status-banner {
                padding: 20px;
                flex-direction: column;
                text-align: center;
            }
            
            .col-card {
                padding: 16px;
            }
            
            .col-card h3 {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .status-banner {
                padding: 16px;
            }
            
            .info-card {
                padding: 16px;
            }
            
            .col-card {
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Banking Account Validation</h1>
            <p>Comprehensive Account Analysis & Risk Assessment</p>
        </div>
        
        <div class="card">
            <div id="purposeChart" style="width:100%;height:320px;margin-bottom:24px;display:none;"></div>
            <div id="content">Loading validation results...</div>
        </div>
    </div>

    <script>
        function renderContent(data, checkData, statusData, missingData, balanceData, kycData, branchCodeData, customerIdData, transactionData, transactionTypeData, panData, debitCreditData, fraudData, foreignKeyData, purposeData, finalDecisionData, riskAssessmentData, columnPurposeReport, probabilityExplanationsData, bankingTransactionRulesData, validatorData) {
            // Use risk assessment and final decision from backend
            const riskLevel = riskAssessmentData?.risk_level || "HIGH";
            const decisionText = finalDecisionData?.decision || "REJECT";
            const reasonText = finalDecisionData?.reason || "Validation failed.";

            // Main status banner
            let statusBannerHtml = "";
            if (checkData) {
                const hasAccount = checkData.has_account_number_column;
                const decision = checkData.best_match_decision;
                const column = checkData.best_match_column;
                const probability = checkData.best_match_probability;
                
                if (hasAccount && decision === "match") {
                    statusBannerHtml = `
                        <div class="status-banner success">
                            <div class="status-icon">‚úÖ</div>
                            <div class="status-content">
                                <h3>Account Number Detected</h3>
                                <p><strong>Column:</strong> ${column || "-"} &nbsp;|&nbsp; <strong>Confidence:</strong> ${probability ?? "-"}%</p>
                            </div>
                        </div>
                    `;
                } else if (hasAccount && decision === "not_match") {
                    statusBannerHtml = `
                        <div class="status-banner error">
                            <div class="status-icon">‚ùå</div>
                            <div class="status-content">
                                <h3>Account Number Invalid</h3>
                                <p><strong>Column:</strong> ${column || "-"} &nbsp;|&nbsp; <strong>Confidence:</strong> ${probability ?? "-"}%</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusBannerHtml = `
                        <div class="status-banner warning">
                            <div class="status-icon">‚ö†Ô∏è</div>
                            <div class="status-content">
                                <h3>No Account Number Column Detected</h3>
                                <p>The uploaded file does not contain a valid account number column.</p>
                            </div>
                        </div>
                    `;
                }
            }

            // Purpose Detection Display
            let purposeHtml = "";
            if (purposeData && purposeData.primary_purpose) {
                purposeHtml = `
                    <div class="col-card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; margin-bottom:20px; border-left-color:#764ba2;">
                        <h3 style="color:white; margin-bottom:12px;">üéØ Dataset Purpose Detection</h3>
                        <p style="font-size:1.1rem; font-weight:600; margin-bottom:8px;"><b>Primary Purpose:</b> ${purposeData.primary_purpose}</p>
                        <p style="font-size:0.95rem; opacity:0.95; margin-bottom:8px;"><b>Confidence:</b> ${purposeData.purpose_confidence}%</p>
                        <p style="font-size:0.95rem; opacity:0.95; margin-top:12px;"><b>Purpose Statement:</b> ${purposeData.purpose_statement}</p>
                        ${purposeData.detected_purposes && purposeData.detected_purposes.length > 1 ? `
                            <p style="font-size:0.9rem; opacity:0.9; margin-top:12px;"><b>Other Detected Purposes:</b></p>
                            <ul style="margin-top:8px; padding-left:20px;">
                                ${purposeData.detected_purposes.map((p, idx) => 
                                    idx === 0 ? '' : `<li>${p} (${purposeData.confidence_scores[idx]}%)</li>`
                                ).filter(x => x).join("")}
                            </ul>
                        ` : ""}
                    </div>
                `;
            }

            // Column purpose explanations (Account / Customer / Transaction / Withdrawal‚ÄëDeposit‚ÄëTransfer)
            let columnPurposeHtml = "";
            if (columnPurposeReport && columnPurposeReport.explanations) {
                const ex = columnPurposeReport.explanations;
                columnPurposeHtml = `
                    <div class="col-card" style="background:#f7fafc;margin-bottom:20px;border-left:4px solid #667eea;">
                        <h3 style="margin-bottom:10px;">üìö Column Purpose Summary</h3>
                        <p style="font-size:0.95rem;margin-bottom:8px;"><b>Account / Customer Details:</b> ${ex.account_customer || ""}</p>
                        <p style="font-size:0.95rem;margin-bottom:8px;"><b>Transaction Columns:</b> ${ex.transaction || ""}</p>
                        <p style="font-size:0.95rem;margin-bottom:4px;"><b>Withdrawal / Deposit / Transfer:</b> ${ex.wdt || ""}</p>
                    </div>
                `;
            }

            // Account Number Validation Rules
            let accountRulesHtml = "";
            if (data && data.account_like_columns && Array.isArray(data.account_like_columns) && data.account_like_columns.length > 0) {
                data.account_like_columns.forEach((colData, idx) => {
                    const rules = colData.rules || {};
                    const digitsOnly = rules.digits_only_ratio !== undefined ? rules.digits_only_ratio : 0;
                    const lengthOk = rules.length_6_16_ratio !== undefined ? rules.length_6_16_ratio : 0;
                    const unique = rules.unique_ratio !== undefined ? rules.unique_ratio : 0;
                    const notNull = rules.not_null_ratio !== undefined ? rules.not_null_ratio : 0;
                    const noSymbols = rules.no_symbol_ratio !== undefined ? rules.no_symbol_ratio : 0;
                    const randomized = rules.randomized !== undefined ? rules.randomized : false;
                    
                    accountRulesHtml += `
                        <div class="col-card" style="background:#e6f7ff; border-left-color:#1890ff; margin-bottom:16px;">
                            <h3>üîπ STEP-2: Account Number Detection (ML + RULES) - ${colData.column || 'Unknown'}</h3>
                            <p><b>Column:</b> ${colData.column || 'N/A'}</p>
                            <p><b>Decision:</b> ${colData.decision === 'match' ? '‚úÖ MATCH' : '‚ùå NOT MATCH'}</p>
                            <p><b>Probability:</b> ${colData.probability_account_number || 0}%</p>
                            <p><b>Validation Rules:</b></p>
                            <ul class="list-clean" style="margin-top:8px;">
                                <li>‚úî Digits only: ${digitsOnly >= 0.9 ? '‚úÖ' : '‚ùå'} (${(digitsOnly * 100).toFixed(1)}%)</li>
                                <li>‚úî Length: 6‚Äì16: ${lengthOk >= 0.9 ? '‚úÖ' : '‚ùå'} (${(lengthOk * 100).toFixed(1)}%)</li>
                                <li>‚úî Unique: ${unique >= 0.85 ? '‚úÖ' : '‚ùå'} (${(unique * 100).toFixed(1)}%)</li>
                                <li>‚úî NOT NULL: ${notNull >= 0.95 ? '‚úÖ' : '‚ùå'} (${(notNull * 100).toFixed(1)}%)</li>
                                <li>‚úî No symbols: ${noSymbols >= 0.95 ? '‚úÖ' : '‚ùå'} (${(noSymbols * 100).toFixed(1)}%)</li>
                                <li>‚úî Randomized: ${randomized ? '‚úÖ' : '‚ùå'}</li>
                            </ul>
                            ${colData.sample_violations && Array.isArray(colData.sample_violations) && colData.sample_violations.length > 0 ? `
                                <p style="margin-top:12px;"><b>Sample Violations:</b></p>
                                <ul class="list-clean">
                                    ${colData.sample_violations.slice(0, 5).map(v => `<li>${v}</li>`).join("")}
                                </ul>
                            ` : ""}
                        </div>
                    `;
                });
            }

            // Info grid
            let infoGridHtml = '<div class="info-grid">';
            
            // Account Status Card
            if (statusData) {
                if (statusData.has_status_column) {
                    infoGridHtml += `
                        <div class="info-card success-bg">
                            <div class="info-card-header">
                                <span class="info-card-icon">üìä</span>
                                <span class="info-card-title">Account Status</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status Column</span>
                                <span class="info-value">${statusData.status_column}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Active Accounts</span>
                                <span class="info-value">${statusData.active_count}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Inactive Accounts</span>
                                <span class="info-value">${statusData.inactive_count}</span>
                            </div>
                        </div>
                    `;
                } else {
                    infoGridHtml += `
                        <div class="info-card warning-bg">
                            <div class="info-card-header">
                                <span class="info-card-icon">‚ö†Ô∏è</span>
                                <span class="info-card-title">Account Status Missing</span>
                            </div>
                            <p style="color: #744210; font-size: 0.9rem;">No account status column (active/inactive) found in the file.</p>
                        </div>
                    `;
                }
            }
            
            // Mandatory Columns Check (STEP-5)
            if (missingData) {
                const mandatoryMissing = missingData.missing_mandatory || [];
                const optionalMissing = missingData.missing_optional || [];
                const allMandatoryPresent = missingData.all_mandatory_present;
                const cardClass = allMandatoryPresent ? 'success-bg' : 'error-bg';
                const icon = allMandatoryPresent ? '‚úÖ' : '‚ùå';
                infoGridHtml += `
                    <div class="info-card ${cardClass}">
                        <div class="info-card-header">
                            <span class="info-card-icon">${icon}</span>
                            <span class="info-card-title">Mandatory Columns Check</span>
                        </div>
                        ${allMandatoryPresent ? `
                            <p style="color: #155724; font-size: 0.9rem;">‚úÖ All mandatory columns present</p>
                        ` : `
                            <p style="color: #721c24; font-size: 0.9rem;"><b>Missing Mandatory:</b> ${mandatoryMissing.join(", ")}</p>
                        `}
                        ${optionalMissing.length > 0 ? `
                            <p style="color: #856404; font-size: 0.85rem; margin-top:8px;"><b>Missing Optional:</b> ${optionalMissing.join(", ")}</p>
                        ` : ''}
                    </div>
                `;
            }
            
            // Balance Card
            if (balanceData?.has_balance_column) {
                infoGridHtml += `
                    <div class="info-card success-bg">
                        <div class="info-card-header">
                            <span class="info-card-icon">üí∞</span>
                            <span class="info-card-title">Balance Analysis</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Balance Column</span>
                            <span class="info-value">${balanceData.balance_column}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Zero/Negative</span>
                            <span class="info-value">${balanceData.zero_or_negative_count} / ${balanceData.total_rows}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Percentage</span>
                            <span class="info-value">${balanceData.zero_or_negative_pct}%</span>
                        </div>
                    </div>
                `;
            } else {
                infoGridHtml += `
                    <div class="info-card warning-bg">
                        <div class="info-card-header">
                            <span class="info-card-icon">‚ö†Ô∏è</span>
                            <span class="info-card-title">Balance Column Missing</span>
                        </div>
                        <p style="color: #744210; font-size: 0.9rem;">Balance is required to evaluate transaction readiness.</p>
                    </div>
                `;
            }
            
            // KYC Card - REMOVED (KYC rules removed)
            
            // Customer ID Card
            if (customerIdData) {
                const cardClass = customerIdData.decision === 'found' ? 'success-bg' : 'warning-bg';
                const icon = customerIdData.decision === 'found' ? '‚úÖ' : '‚ö†Ô∏è';
                infoGridHtml += `
                    <div class="info-card ${cardClass}">
                        <div class="info-card-header">
                            <span class="info-card-icon">${icon}</span>
                            <span class="info-card-title">STEP-3: Customer ID Validation (7 Rules)</span>
                        </div>
                        ${customerIdData.column_exists ? `
                            <div class="info-item">
                                <span class="info-label">Column</span>
                                <span class="info-value">${customerIdData.column_name}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Confidence</span>
                                <span class="info-value">${customerIdData.probability_customer_id}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Rules Passed</span>
                                <span class="info-value">${customerIdData.rules_passed} / ${customerIdData.rules_total}</span>
                            </div>
                        ` : '<p style="font-size: 0.9rem;">Customer ID column not found</p>'}
                    </div>
                `;
            }
            
            infoGridHtml += '</div>';

            // Foreign Key / Linking Check (STEP-4)
            let foreignKeyHtml = "";
            if (foreignKeyData && foreignKeyData.can_check) {
                const fkMismatch = foreignKeyData.fk_mismatch || false;
                const linkingStatus = foreignKeyData.linking_valid ? 'success' : (fkMismatch ? 'error' : 'warning');
                const linkingIcon = foreignKeyData.linking_valid ? '‚úÖ' : (fkMismatch ? '‚ùå' : '‚ö†Ô∏è');
                const bgColor = foreignKeyData.linking_valid ? '#d4edda' : (fkMismatch ? '#f8d7da' : '#fff3cd');
                const borderColor = foreignKeyData.linking_valid ? '#28a745' : (fkMismatch ? '#dc3545' : '#ffc107');
                foreignKeyHtml = `
                    <div class="col-card" style="background:${bgColor}; border-left-color:${borderColor}; margin-bottom:20px;">
                        <h3>üîπ STEP-4: Foreign Key / Linking Check</h3>
                        <p><b>Account Column:</b> ${foreignKeyData.account_column || 'N/A'}</p>
                        <p><b>Customer Column:</b> ${foreignKeyData.customer_column || 'N/A'}</p>
                        <p><b>Relationship Type:</b> ${foreignKeyData.relationship_type || 'UNKNOWN'}</p>
                        <p><b>Total Accounts:</b> ${foreignKeyData.total_accounts}</p>
                        <p><b>Total Customers:</b> ${foreignKeyData.total_customers}</p>
                        ${foreignKeyData.accounts_per_customer ? `<p><b>Accounts per Customer:</b> ${foreignKeyData.accounts_per_customer}</p>` : ''}
                        <p><b>Missing Links:</b> ${foreignKeyData.missing_links_count}</p>
                        <p><b>FK Mismatch:</b> ${fkMismatch ? '‚ùå YES (HIGH RISK)' : '‚úÖ NO'}</p>
                        <p><b>Linking Status:</b> ${linkingIcon} ${foreignKeyData.linking_valid ? 'VALID' : 'INVALID'}</p>
                        ${fkMismatch && foreignKeyData.violations && foreignKeyData.violations.length > 0 ? `
                            <p style="margin-top:8px; color:#721c24;"><b>Violations:</b></p>
                            <ul style="margin-top:4px;">
                                ${foreignKeyData.violations.map(v => `<li style="color:#721c24;">${v}</li>`).join("")}
                            </ul>
                        ` : ''}
                        ${!foreignKeyData.linking_valid && !fkMismatch ? '<p style="margin-top:8px; color:#856404;">‚ö†Ô∏è Some accounts or customers have missing links.</p>' : ''}
                    </div>
                `;
            } else if (foreignKeyData && !foreignKeyData.can_check) {
                foreignKeyHtml = `
                    <div class="col-card" style="background:#f8d7da; border-left-color:#dc3545; margin-bottom:20px;">
                        <h3>üîπ STEP-4: Foreign Key / Linking Check</h3>
                        <p>‚ö†Ô∏è Cannot perform linking check - account number or customer ID columns are missing.</p>
                    </div>
                `;
            }

            // Transaction Type Validation
            let transactionTypeHtml = "";
            if (transactionTypeData) {
                const columnFound = transactionTypeData.column_found || false;
                const columnName = transactionTypeData.column_name || "N/A";
                const probability = transactionTypeData.probability_percentage || 0;
                const overallConfidence = transactionTypeData.overall_confidence || transactionTypeData.confidence_percentage || 0;
                const isValid = transactionTypeData.is_valid || false;
                const decision = transactionTypeData.decision || "unknown";
                const validCount = transactionTypeData.valid_count || 0;
                const invalidCount = transactionTypeData.invalid_count || 0;
                const totalRows = transactionTypeData.total_rows || 0;
                const validTypes = transactionTypeData.valid_types_found || [];
                const invalidTypes = transactionTypeData.invalid_types_found || [];
                
                    // Only show if confidence is above threshold (70%) or if it's a valid match
                if (columnFound && overallConfidence >= 70) {
                    const bgColor = isValid ? '#d4edda' : (probability >= 50 ? '#fff3cd' : '#f8d7da');
                    const borderColor = isValid ? '#28a745' : (probability >= 50 ? '#ffc107' : '#dc3545');
                    const icon = isValid ? '‚úÖ' : (probability >= 50 ? '‚ö†Ô∏è' : '‚ùå');
                    const statusText = isValid ? 'VALID' : (probability >= 50 ? 'PARTIAL' : 'INVALID');
                    
                    transactionTypeHtml = `
                        <div class="col-card" style="background:${bgColor}; border-left-color:${borderColor}; margin-bottom:20px;">
                            <h3>üîπ Transaction Type Validation</h3>
                            <p><b>Column:</b> ${columnName}</p>
                            <p><b>Status:</b> ${icon} ${statusText}</p>
                            <p><b>Probability:</b> <span style="font-size:1.2rem; font-weight:bold; color:${isValid ? '#28a745' : (probability >= 50 ? '#856404' : '#dc3545')};">${probability}%</span></p>
                            <p><b>Total Rows:</b> ${totalRows}</p>
                            <p><b>Valid Values:</b> ${validCount} (${validTypes.length > 0 ? validTypes.join(", ") : "None"})</p>
                            <p><b>Invalid Values:</b> ${invalidCount}</p>
                            ${validTypes.length > 0 ? `
                                <p style="margin-top:8px;"><b>Valid Types Found:</b></p>
                                <ul style="margin-top:4px; padding-left:20px;">
                                    ${validTypes.map(t => `<li style="color:#155724;">‚úÖ ${t}</li>`).join("")}
                                </ul>
                            ` : ''}
                            ${invalidTypes.length > 0 ? `
                                <p style="margin-top:8px; color:#721c24;"><b>Invalid Types Found (sample):</b></p>
                                <ul style="margin-top:4px; padding-left:20px;">
                                    ${invalidTypes.map(t => `<li style="color:#721c24;">‚ùå ${t}</li>`).join("")}
                                </ul>
                            ` : ''}
                            <p style="margin-top:12px; font-size:0.9rem; color:#495057;">
                                <b>Note:</b> Valid transaction types are: <b>deposit</b>, <b>withdraw</b>, <b>withdrawal</b>, and <b>transfer</b> (case-insensitive).
                            </p>
                        </div>
                    `;
                } else if (columnFound && overallConfidence < 70) {
                    // Show a muted message when confidence is too low
                    transactionTypeHtml = `
                        <div class="col-card" style="background:#f8f9fa; border-left-color:#6c757d; margin-bottom:20px; opacity: 0.7;">
                            <h3>üîπ Transaction Type Validation</h3>
                            <p>‚ö†Ô∏è Low confidence match for column: ${columnName}</p>
                            <p>Overall confidence: ${overallConfidence}% (below 70% threshold)</p>
                            <p>This match was filtered out due to low confidence.</p>
                        </div>
                    `;
                } else {
                    transactionTypeHtml = `
                        <div class="col-card" style="background:#fff3cd; border-left-color:#ffc107; margin-bottom:20px;">
                            <h3>üîπ Transaction Type Validation</h3>
                            <p>‚ö†Ô∏è Transaction type column not found in the dataset.</p>
                            <p style="margin-top:8px; font-size:0.9rem; color:#856404;">
                                Expected column names: transaction_type, txn_type, trans_type, or type
                            </p>
                        </div>
                    `;
                }
            }

            // Branch Code Detection - REMOVED
            let branchCodeHtml = "";

            // PAN Number Validation - Only show if PAN data exists and column is found
            let panHtml = "";
            if (panData && panData.column_found) {
                const columnName = panData.column_name || "N/A";
                const probability = panData.probability_percentage || 0;
                const isValid = panData.is_valid || false;
                const validPanCount = panData.valid_pan_count || 0;
                const invalidPanCount = panData.invalid_pan_count || 0;
                const totalPanFound = panData.total_pan_found || 0;
                const totalRows = panData.total_rows || 0;
                const panList = panData.pan_list || [];
                const invalidPanList = panData.invalid_pan_list || [];
                
                const bgColor = isValid ? '#d4edda' : (probability >= 50 ? '#fff3cd' : '#f8d7da');
                const borderColor = isValid ? '#28a745' : (probability >= 50 ? '#ffc107' : '#dc3545');
                const icon = isValid ? '‚úÖ' : (probability >= 50 ? '‚ö†Ô∏è' : '‚ùå');
                const statusText = isValid ? 'VALID' : (probability >= 50 ? 'PARTIAL' : 'INVALID');
                
                panHtml = `
                    <div class="col-card" style="background:${bgColor}; border-left-color:${borderColor}; margin-bottom:20px;">
                        <h3>üîπ PAN Number Validation</h3>
                        <p><b>Column:</b> ${columnName}</p>
                        <p><b>Status:</b> ${icon} ${statusText}</p>
                        <p><b>Probability:</b> <span style="font-size:1.2rem; font-weight:bold; color:${isValid ? '#28a745' : (probability >= 50 ? '#856404' : '#dc3545')};">${probability}%</span></p>
                        <p><b>Total Rows:</b> ${totalRows}</p>
                        <p><b>Valid PAN Count:</b> <span style="font-size:1.1rem; font-weight:bold; color:#28a745;">${validPanCount}</span></p>
                        <p><b>Invalid PAN Count:</b> <span style="color:#dc3545;">${invalidPanCount}</span></p>
                        <p><b>Total PAN Found:</b> <span style="font-size:1.1rem; font-weight:bold;">${totalPanFound}</span></p>
                        
                        ${panList.length > 0 ? `
                            <div style="margin-top:16px;">
                                <p style="font-weight:600; margin-bottom:8px;"><b>Valid PAN Numbers Found (${panList.length}${panList.length >= 50 ? '+' : ''}):</b></p>
                                <div style="background:#f7fafc; padding:12px; border-radius:4px; max-height:300px; overflow-y:auto;">
                                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:8px; font-family:monospace; font-size:0.9rem;">
                                        ${panList.map(pan => `<div style="padding:4px; background:white; border:1px solid #d4edda; border-radius:3px; text-align:center;">${pan}</div>`).join("")}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${invalidPanList.length > 0 ? `
                            <div style="margin-top:16px;">
                                <p style="font-weight:600; margin-bottom:8px; color:#721c24;"><b>Invalid PAN Numbers (Sample - ${invalidPanList.length}${invalidPanList.length >= 20 ? '+' : ''}):</b></p>
                                <div style="background:#fff5f5; padding:12px; border-radius:4px; max-height:200px; overflow-y:auto;">
                                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:8px; font-family:monospace; font-size:0.9rem;">
                                        ${invalidPanList.map(pan => `<div style="padding:4px; background:white; border:1px solid #f8d7da; border-radius:3px; text-align:center; color:#721c24;">${pan}</div>`).join("")}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top:16px; padding:12px; background:#e6f7ff; border-left:4px solid #1890ff; border-radius:4px;">
                            <p style="font-weight:600; margin-bottom:8px; color:#0050b3;"><b>PAN Format Specification:</b></p>
                            <ul style="margin:0; padding-left:20px; color:#0050b3; font-size:0.9rem;">
                                <li>Total 10 characters</li>
                                <li>First 5 = letters (A-Z)</li>
                                <li>Next 4 = digits (0-9)</li>
                                <li>Last 1 = letter (A-Z)</li>
                                <li>Pattern: <code style="background:white; padding:2px 6px; border-radius:3px;">[A-Z]{5}[0-9]{4}[A-Z]{1}</code></li>
                                <li>Example: <code style="background:white; padding:2px 6px; border-radius:3px; font-weight:bold;">ABCDE1234F</code> ‚úÖ</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            const riskHtml = ``;

            // Final Decision - REMOVED
            const decisionHtml = ``;

            // Next Action
            const missingMandatory = missingData?.missing_mandatory || [];
            const missingItems = [];
            if (missingMandatory.includes("account_status")) missingItems.push("Account Status");
            if (missingMandatory.includes("balance")) missingItems.push("Balance");
            if (foreignKeyData?.fk_mismatch) missingItems.push("Fix Foreign Key Mismatch");
            
            const nextActionHtml = missingItems.length > 0 ? `
                <div class="action-box">
                    <h4>üìã Next Action Required</h4>
                    <ul class="list-clean">
                        ${missingItems.map(item => `<li>${item}</li>`).join("")}
                    </ul>
                </div>
            ` : decisionText === 'APPROVE' ? `
                <div class="action-box" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                    <h4>‚úÖ Approved</h4>
                    <p style="font-size: 0.9rem; color: #155724;">All validation checks passed. Dataset is ready for banking operations.</p>
                </div>
            ` : '';

            // Column Purpose Explanations Section (for matched columns with predefined patterns)
            let columnPurposeExplanationsHtml = "";
            if (probabilityExplanationsData && Object.keys(probabilityExplanationsData).length > 0) {
                // Create chart container
                const chartContainer = `
                    <div id="probabilityChart" style="width:100%;height:400px;margin-bottom:20px;"></div>
                `;
                // Filter for purpose explanations (columns that match predefined patterns)
                const purposeExplanations = {};
                const generalExplanations = {};
                
                for (const [key, explanationObj] of Object.entries(probabilityExplanationsData)) {
                    if (key.startsWith('purpose_')) {
                        purposeExplanations[key] = explanationObj;
                    } else {
                        generalExplanations[key] = explanationObj;
                    }
                }
                
                // Show purpose explanations (matched column patterns) in a dedicated section
                // Only show if confidence is high enough (threshold of 0.5 or 50%)
                if (Object.keys(purposeExplanations).length > 0) {
                    columnPurposeExplanationsHtml = `
                        <div class="col-card" style="background:white; border-left: 4px solid #007bff; margin-bottom:20px;">
                            <h3>üîç Column Purposes (Predefined Patterns)</h3>
                            <p style="color: #666; margin-top: 10px; margin-bottom: 15px;">The following columns were matched against predefined banking patterns:</p>
                            <div style="margin-top: 15px;">
                    `;
                    
                    for (const [key, explanationObj] of Object.entries(purposeExplanations)) {
                        // Skip if confidence is too low (less than 0.7 or 70%) - only show high confidence matches
                        if (explanationObj.confidence < 0.7) {
                            continue;
                        }
                        
                        const explanation = explanationObj.explanation || "No explanation available";
                        
                        // Extract column name from key (remove 'purpose_' prefix)
                        const columnName = key.replace('purpose_', '');
                        
                        // Extract the column type from the explanation (first word before colon)
                        const columnTypeMatch = explanation.match(/^([^:]+)/);
                        const columnType = columnTypeMatch ? columnTypeMatch[1].trim() : 'unknown';
                        
                        // Split the explanation into parts by commas and create bullet points
                        const explanationParts = explanation.split(',').map(part => part.trim());
                        
                        let explanationList = '';
                        for (const part of explanationParts) {
                            if (part) {
                                explanationList += `<li style="margin-bottom: 5px; font-size: 0.85rem; color: #555; line-height: 1.4;">‚Ä¢ ${part}</li>`;
                            }
                        }
                        
                        columnPurposeExplanationsHtml += `
                            <div style="margin-bottom: 15px; border: 1px solid #eee; border-radius: 6px; padding: 12px; background: white;">
                                <div style="margin-bottom: 8px;">
                                    <strong style="font-size: 1.0rem; color: #333;">Column: ${columnName}</strong>
                                    <div style="font-size: 0.9rem; color: #007bff; margin-top: 4px; font-weight: 500;">${columnType}</div>
                                </div>
                                <ul style="padding-left: 20px; margin: 10px 0 0 0;">${explanationList}</ul>
                            </div>
                        `;
                    }
                    
                    columnPurposeExplanationsHtml += `</div></div>`;
                }
                
                // Combine sections without general explanations
                probabilityExplanationsHtml = columnPurposeExplanationsHtml;
            }
            
            // If no specific purpose explanations, show general section
            if (!probabilityExplanationsHtml && probabilityExplanationsData && Object.keys(probabilityExplanationsData).length > 0) {
                probabilityExplanationsHtml = `
                    <div class="col-card" style="background:white; border-left: 4px solid #6c757d; margin-bottom:20px;">
                        <h3>üìä Data Points</h3>
                        <div style="margin-top: 15px;">
                `;
                
                for (const [key, explanationObj] of Object.entries(probabilityExplanationsData)) {
                    // Skip if confidence is too low (less than 0.7 or 70%) - only show high confidence matches
                    if (explanationObj.confidence < 0.7) {
                        continue;
                    }
                    
                    const explanation = explanationObj.explanation || "No explanation available";
                    
                        // Split the explanation into parts by commas and create bullet points
                        const explanationParts = explanation.split(',').map(part => part.trim());
                        
                        let explanationList = '';
                        for (const part of explanationParts) {
                            if (part) {
                                explanationList += `<li style="margin-bottom: 5px; font-size: 0.85rem; color: #555; line-height: 1.4;">‚Ä¢ ${part}</li>`;
                            }
                        }
                        
                        probabilityExplanationsHtml += `
                            <div style="margin-bottom: 12px; border: 1px solid #eee; border-radius: 4px; padding: 10px; background: #fafafa;">
                                <div style="margin-bottom: 5px;">
                                    <strong style="font-size: 0.95rem; color: #333;">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong>
                                </div>
                                <ul style="padding-left: 20px; margin: 10px 0 0 0;">${explanationList}</ul>
                            </div>
                        `;
                }
                
                probabilityExplanationsHtml += `</div></div>`;
            }
            
            // Banking Dataset Validator Results
            let validatorHtml = "";
            if (validatorData && !validatorData.error) {
                const decisionColor = validatorData.final_decision === 'PASS' ? '#28a745' : validatorData.final_decision === 'REVIEW' ? '#ffc107' : '#dc3545';
                const decisionBg = validatorData.final_decision === 'PASS' ? '#d4edda' : validatorData.final_decision === 'REVIEW' ? '#fff3cd' : '#f8d7da';
                
                validatorHtml = `
                    <div class="col-card" style="background:${decisionBg}; border-left-color:${decisionColor}; margin-bottom:20px;">
                        <h3>üîπ Banking Dataset Validator Results</h3>
                        <p><b>Final Decision:</b> <span class="badge ${validatorData.final_decision === 'PASS' ? 'success' : validatorData.final_decision === 'REVIEW' ? 'warning' : 'error'}">${validatorData.final_decision}</span></p>
                        <p><b>Dataset Confidence:</b> <span style="font-size:1.2rem; font-weight:bold; color:${decisionColor};">${validatorData.dataset_confidence}%</span></p>
                        <p style="margin-top:8px;"><b>Explanation:</b> ${validatorData.explanation || 'N/A'}</p>
                        <p style="margin-top:12px;"><b>Columns Validated:</b> ${validatorData.columns ? validatorData.columns.length : 0}</p>
                        <p><b>Relationships Validated:</b> ${validatorData.relationships ? validatorData.relationships.length : 0}</p>
                        
                        ${validatorData.columns && validatorData.columns.length > 0 ? `
                            <div style="margin-top:16px;">
                                <p style="font-weight:600; margin-bottom:8px;"><b>Column Validation Details:</b></p>
                                <div style="background:#f7fafc; padding:12px; border-radius:4px; max-height:400px; overflow-y:auto;">
                                    ${validatorData.columns.map(col => {
                                        const colStatusColor = col.status === 'MATCH' ? '#28a745' : col.status === 'WARNING' ? '#ffc107' : '#dc3545';
                                        return `
                                            <div style="margin:8px 0; padding:10px; background:white; border-radius:4px; border-left:3px solid ${colStatusColor};">
                                                <p style="font-weight:600; margin-bottom:4px;"><b>${col.name}</b> - ${col.meaning || 'N/A'}</p>
                                                <p style="font-size:0.9rem; margin-bottom:4px;">Confidence: ${col.confidence}% | Rules: ${col.rules_passed}/${col.rules_total} | Status: <span style="color:${colStatusColor}; font-weight:bold;">${col.status}</span></p>
                                                ${col.failures && col.failures.length > 0 ? `<p style="color:#dc3545; font-size:0.85rem; margin-top:4px;">‚ö†Ô∏è Issues: ${col.failures.slice(0, 3).join(', ')}</p>` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${validatorData.relationships && validatorData.relationships.length > 0 ? `
                            <div style="margin-top:16px;">
                                <p style="font-weight:600; margin-bottom:8px;"><b>Relationship Validations:</b></p>
                                <ul class="list-clean">
                                    ${validatorData.relationships.map(rel => {
                                        const relKey = Object.keys(rel)[0];
                                        const relValue = rel[relKey];
                                        const relIcon = relValue === 'PASS' ? '‚úÖ' : relValue === 'FAIL' ? '‚ùå' : '‚ö†Ô∏è';
                                        return `<li>${relIcon} ${relKey}: ${relValue}</li>`;
                                    }).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            return statusBannerHtml + purposeHtml + columnPurposeHtml + accountRulesHtml + infoGridHtml + foreignKeyHtml + transactionTypeHtml + branchCodeHtml + panHtml + riskHtml + decisionHtml + probabilityExplanationsHtml + validatorHtml + nextActionHtml;
        }

        (function init() {
            const content = document.getElementById("content");
            try {
                const parsedValidation = JSON.parse(sessionStorage.getItem("accountValidation") || "null");
                const parsedCheck = JSON.parse(sessionStorage.getItem("accountNumberCheck") || "null");
                const parsedStatus = JSON.parse(sessionStorage.getItem("accountStatus") || "null");
                const parsedMissing = JSON.parse(sessionStorage.getItem("missingColumns") || "null");
                const parsedBalance = JSON.parse(sessionStorage.getItem("balanceAnalysis") || "null");
                // KYC and Branch Code removed - no longer used
                const parsedKyc = null;
                const parsedBranchCode = null;
                const parsedCustomerId = JSON.parse(sessionStorage.getItem("customerIdValidation") || "null");
                const parsedTransaction = JSON.parse(sessionStorage.getItem("transactionValidation") || "null");
                const parsedTransactionType = JSON.parse(sessionStorage.getItem("transactionTypeValidation") || "null");
                const parsedPan = JSON.parse(sessionStorage.getItem("panValidation") || "null");
                const parsedDebitCredit = JSON.parse(sessionStorage.getItem("debitCreditValidation") || "null");
                const parsedFraud = JSON.parse(sessionStorage.getItem("fraudDetection") || "null");
                const parsedForeignKey = JSON.parse(sessionStorage.getItem("foreignKeyCheck") || "null");
                const parsedPurpose = JSON.parse(sessionStorage.getItem("purposeDetection") || "null");
                const parsedFinalDecision = JSON.parse(sessionStorage.getItem("finalDecision") || "null");
                const parsedRiskAssessment = JSON.parse(sessionStorage.getItem("riskAssessment") || "null");
                const parsedColumnPurpose = JSON.parse(sessionStorage.getItem("columnPurposeReport") || "null");
                const parsedDatasetValidator = JSON.parse(sessionStorage.getItem("bankingDatasetValidator") || "null");
                
                if (!parsedValidation && !parsedCheck) {
                    content.innerHTML = `
                        <div class="status-banner warning">
                            <div class="status-icon">‚ö†Ô∏è</div>
                            <div class="status-content">
                                <h3>No Data Available</h3>
                                <p>Please upload a banking file first to see account validation results.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Debug logging
                console.log("Purpose Detection:", parsedPurpose);
                console.log("Foreign Key Check:", parsedForeignKey);
                console.log("Final Decision:", parsedFinalDecision);
                console.log("Risk Assessment:", parsedRiskAssessment);
                console.log("Column Purpose Report:", parsedColumnPurpose);
                
                const parsedProbabilityExplanations = JSON.parse(sessionStorage.getItem("probabilityExplanations") || "null");
                const parsedBankingTransactionRules = JSON.parse(sessionStorage.getItem("bankingTransactionRules") || "null");
                
                // Pass validator data to renderContent function
                const validatorData = parsedDatasetValidator;
                
                content.innerHTML = renderContent(parsedValidation, parsedCheck, parsedStatus, parsedMissing, parsedBalance, parsedKyc, parsedBranchCode, parsedCustomerId, parsedTransaction, parsedTransactionType, parsedPan, parsedDebitCredit, parsedFraud, parsedForeignKey, parsedPurpose, parsedFinalDecision, parsedRiskAssessment, parsedColumnPurpose, parsedProbabilityExplanations, parsedBankingTransactionRules, validatorData);

                // Render PyCharts / ECharts column‚Äëpurpose chart
                if (parsedColumnPurpose && parsedColumnPurpose.category_counts) {
                    const chartDom = document.getElementById("purposeChart");
                    const counts = parsedColumnPurpose.category_counts;
                    
                    // Filter out zero values but keep them for percentage calculation
                    const seriesData = Object.keys(counts)
                        .map(k => ({
                            name: k,
                            value: counts[k] || 0  // Ensure value is a number, not undefined
                        }))
                        .filter(item => item.value > 0);  // Only show non-zero in chart
                    
                    // Calculate total for percentage display
                    const total = Object.values(counts).reduce((sum, val) => sum + (val || 0), 0);
                    
                    // Always show chart if we have category_counts data
                    if (total > 0 || Object.keys(counts).length > 0) {
                        chartDom.style.display = "block";
                        const chart = echarts.init(chartDom);
                        
                        const option = {
                            title: {
                                text: "Banking Column Purpose Distribution",
                                left: "center",
                                textStyle: { fontSize: 14 }
                            },
                            tooltip: {
                                trigger: "item",
                                formatter: function(params) {
                                    const value = params.value || 0;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${params.name}: ${value} cols (${percentage}%)`;
                                }
                            },
                            legend: {
                                bottom: 0,
                                data: Object.keys(counts).map(k => k)
                            },
                            series: [{
                                name: "Columns",
                                type: "pie",
                                radius: "55%",
                                center: ["50%", "50%"],
                                data: seriesData.length > 0 ? seriesData : Object.keys(counts).map(k => ({
                                    name: k,
                                    value: counts[k] || 0
                                })),
                                label: {
                                    show: true,
                                    formatter: function(params) {
                                        const value = params.value || 0;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${params.name}\n${percentage}%`;
                                    }
                                },
                                labelLine: {
                                    show: true
                                },
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: "rgba(0, 0, 0, 0.5)"
                                    }
                                }
                            }]
                        };
                        chart.setOption(option);
                    } else {
                        chartDom.style.display = "none";
                    }
                }
                
                // Render probability explanations chart
                if (parsedProbabilityExplanations && Object.keys(parsedProbabilityExplanations).length > 0) {
                    const probChartDom = document.getElementById("probabilityChart");
                    if (probChartDom) {
                        probChartDom.style.display = "block";
                        const probChart = echarts.init(probChartDom);
                        
                        // Prepare data for the chart
                        const probData = Object.entries(parsedProbabilityExplanations).map(([key, obj]) => ({
                            name: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            value: obj.probability || 0
                        }));
                        
                        const probOption = {
                            title: {
                                text: "Probability Distribution",
                                left: "center",
                                textStyle: { fontSize: 16 }
                            },
                            tooltip: {
                                trigger: "axis",
                                axisPointer: {
                                    type: "shadow"
                                },
                                formatter: function(params) {
                                    const param = params[0];
                                    return `${param.name}: ${param.value}%`;
                                }
                            },
                            xAxis: {
                                type: "category",
                                data: probData.map(item => item.name),
                                axisLabel: {
                                    rotate: 45,
                                    fontSize: 12
                                }
                            },
                            yAxis: {
                                type: "value",
                                name: "Probability %",
                                min: 0,
                                max: 100
                            },
                            series: [{
                                data: probData.map(item => item.value),
                                type: "bar",
                                itemStyle: {
                                    color: function(params) {
                                        const value = params.value;
                                        if (value >= 70) return '#27ae60';
                                        if (value >= 50) return '#f39c12';
                                        return '#e74c3c';
                                    }
                                },
                                label: {
                                    show: true,
                                    position: "top",
                                    formatter: "{c}%"
                                }
                            }]
                        };
                        
                        probChart.setOption(probOption);
                        
                        // Make chart responsive
                        window.addEventListener('resize', function() {
                            probChart.resize();
                        });
                    }
                } else {
                    const probChartDom = document.getElementById("probabilityChart");
                    if (probChartDom) {
                        probChartDom.style.display = "none";
                    }
                }
            } catch (e) {
                console.error("Error:", e);
                content.innerHTML = `
                    <div class="status-banner error">
                        <div class="status-icon">‚ùå</div>
                        <div class="status-content">
                            <h3>Error Loading Data</h3>
                            <p>${e.message}</p>
                        </div>
                    </div>
                `;
            }
        })();
    </script>
</body>
</html>