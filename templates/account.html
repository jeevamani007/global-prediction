<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Banking Application Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Detailed banking dataset analysis with business rules and application detection">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #1a56db;
            --primary-dark: #1e40af;
            --primary-light: #3b82f6;
            --success: #059669;
            --success-light: #d1fae5;
            --warning: #d97706;
            --warning-light: #fef3c7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --bg-light: #f8fafc;
            --border: #e5e7eb;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
            padding: 24px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            transition: max-width 0.3s ease;
        }

        /* Full width container for Business Rules */
        .container.full-width {
            max-width: 100% !important;
            padding-left: 20px;
            padding-right: 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 32px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.05rem;
            color: var(--text-muted);
        }

        /* Application Type Banner */
        .app-type-banner {
            background: linear-gradient(135deg, #1976D2 0%, #0D47A1 100%);
            color: white;
            padding: 28px 32px;
            border-radius: var(--border-radius);
            margin-bottom: 24px;
            box-shadow: 0 8px 24px rgba(25, 118, 210, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
        }

        .app-type-banner .app-info h2 {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .app-type-banner .app-name {
            font-size: 1.75rem;
            font-weight: 700;
        }

        .app-type-banner .confidence-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 16px 24px;
            border-radius: 12px;
            text-align: center;
        }

        .app-type-banner .confidence-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .app-type-banner .confidence-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: white;
            border-radius: var(--border-radius);
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            overflow-x: auto;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: var(--bg-light);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 28px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success-light);
            color: var(--success);
        }

        .badge-warning {
            background: var(--warning-light);
            color: var(--warning);
        }

        .badge-danger {
            background: var(--danger-light);
            color: var(--danger);
        }

        .badge-primary {
            background: #dbeafe;
            color: var(--primary);
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .step-number {
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .step-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* File Analysis Card */
        .file-card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .file-card.banking {
            border-left: 4px solid var(--primary);
        }

        .file-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .file-name {
            font-weight: 600;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-app-tag {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .file-reason {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.7;
        }

        /* Grids */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        /* Stats */
        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Relationship Diagram */
        .relationship-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border: 1px solid #90caf9;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .relationship-arrow {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 0.95rem;
            flex-wrap: wrap;
        }

        .table-box {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .arrow {
            color: var(--primary);
            font-size: 1.5rem;
        }



        /* Decision Box */
        .decision-box {
            border-radius: 10px;
            padding: 24px;
            margin-top: 20px;
        }

        .decision-box.single {
            background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
            border-left: 5px solid var(--success);
        }

        .decision-box.multiple {
            background: linear-gradient(135deg, #fef3c7 0%, #fffbeb 100%);
            border-left: 5px solid var(--warning);
        }

        .decision-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .decision-subtitle {
            font-size: 1rem;
            color: var(--text-muted);
        }

        /* Simple Explanation */
        .explanation-box {
            background: linear-gradient(135deg, #f0f5ff 0%, #ffffff 100%);
            border: 1px solid #c7d2fe;
            border-radius: 10px;
            padding: 24px;
            margin-top: 20px;
        }

        .explanation-box h4 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .explanation-box p {
            color: var(--text-dark);
            font-size: 1rem;
            line-height: 1.8;
        }

        /* Business Rules */
        .business-rule-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 24px;
            margin-bottom: 16px;
            border-left: 4px solid var(--primary);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .business-rule-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }

        .rule-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .rule-icon {
            font-size: 1.5rem;
        }

        .rule-title {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 1.1rem;
        }

        .rule-content {
            color: var(--text-muted);
            line-height: 1.8;
        }

        .rule-content strong {
            color: var(--text-dark);
        }

        .rule-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .rule-tag {
            background: var(--bg-light);
            border: 1px solid var(--border);
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .rule-tag.pass {
            background: var(--success-light);
            border-color: var(--success);
            color: var(--success);
        }

        .rule-tag.fail {
            background: var(--danger-light);
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Account Verification Result (Two Panel) */
        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            align-items: start;
        }

        .result-panel {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
            background: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06);
        }

        .result-panel .panel-header {
            padding: 18px 20px;
            color: white;
            font-weight: 700;
            font-size: 1.05rem;
            letter-spacing: 0.2px;
        }

        .result-panel .panel-body {
            padding: 18px 20px;
            color: var(--text-dark);
            line-height: 1.7;
        }

        .result-panel.valid .panel-header {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
        }

        .result-panel.issues .panel-header {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }

        .issue-row {
            border: 1px solid #fecaca;
            background: #fff;
            border-radius: 10px;
            padding: 14px 14px;
            margin-top: 12px;
        }

        .issue-row .issue-title {
            font-weight: 700;
            color: #7f1d1d;
            margin-bottom: 8px;
        }

        .issue-row .issue-msg {
            color: #991b1b;
            font-size: 0.95rem;
        }

        .issue-row .issue-meta {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .result-actions {
            margin-top: 18px;
            display: flex;
            justify-content: flex-end;
        }

        .submit-btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid #1d4ed8;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(37, 99, 235, 0.25);
        }

        /* Business Rules Table (Multi-file) */
        .rules-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .rules-table th {
            background: var(--bg-light);
            padding: 12px 12px;
            text-align: left;
            font-weight: 700;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border);
            font-size: 0.92rem;
            white-space: nowrap;
        }

        .rules-table td {
            padding: 12px 12px;
            vertical-align: top;
            border-bottom: 1px solid var(--border);
            color: var(--text-dark);
            font-size: 0.92rem;
        }

        .rules-table tr:last-child td {
            border-bottom: none;
        }

        .analysis-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.8rem;
            border: 1px solid transparent;
            margin-bottom: 8px;
        }

        .analysis-pill.valid {
            background: #ecfdf5;
            color: #065f46;
            border-color: #bbf7d0;
        }

        .analysis-pill.warning {
            background: #fffbeb;
            color: #92400e;
            border-color: #fde68a;
        }

        .analysis-pill.invalid {
            background: #fef2f2;
            color: #991b1b;
            border-color: #fecaca;
        }

        .mini-points {
            margin: 8px 0 0 18px;
            padding: 0;
        }

        .mini-points li {
            margin: 3px 0;
        }

        .action-block {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 10px;
            margin-top: 8px;
        }

        .action-block.valid {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }

        .action-block.invalid {
            background: #fef2f2;
            border-color: #fecaca;
        }

        .action-block .label {
            font-weight: 800;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .action-block.valid .label {
            color: #065f46;
        }

        .action-block.invalid .label {
            color: #991b1b;
        }

        @media (max-width: 900px) {
            .result-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Business Rules Layout */
        .column-rule-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            transition: box-shadow 0.2s ease;
        }

        .column-rule-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .column-rule-card.valid {
            border-left-color: var(--success);
        }

        .column-rule-card.warning {
            border-left-color: var(--warning);
        }

        .column-rule-card.invalid {
            border-left-color: var(--danger);
        }

        .column-rule-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--bg-light);
        }

        .column-rule-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 6px;
        }

        .column-rule-field {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .column-rule-section {
            margin-bottom: 18px;
        }

        .column-rule-section-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .column-rule-section-content {
            color: var(--text-dark);
            line-height: 1.7;
            font-size: 0.95rem;
            padding-left: 24px;
        }

        .column-rule-points {
            margin: 8px 0 0 0;
            padding-left: 20px;
        }

        .column-rule-points li {
            margin: 6px 0;
            line-height: 1.6;
        }

        .why-valid-box {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-left: 4px solid var(--success);
            border-radius: 8px;
            padding: 14px 16px;
            margin-top: 12px;
        }

        .why-invalid-box {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-left: 4px solid var(--danger);
            border-radius: 8px;
            padding: 14px 16px;
            margin-top: 12px;
        }

        .why-box-title {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .why-valid-box .why-box-title {
            color: #065f46;
        }

        .why-invalid-box .why-box-title {
            color: #991b1b;
        }

        .compact-structure-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: var(--bg-light);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .compact-relationship-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            background: var(--bg-light);
            border-radius: 6px;
            font-size: 0.8rem;
            border-left: 3px solid var(--primary);
        }

        /* Business Rules Full Screen Optimization */
        #business-rules.tab-content {
            max-width: 100% !important;
            width: 100%;
            padding: 0;
            margin: 0;
        }


        #business-rules .tab-content>div[style*="grid-template-columns"] {
            grid-template-columns: 1fr 420px !important;
            gap: 16px !important;
        }

        @media (max-width: 1400px) {
            #business-rules .tab-content>div[style*="grid-template-columns"] {
                grid-template-columns: 1fr 380px !important;
                gap: 16px !important;
            }
        }

        @media (max-width: 1200px) {
            #business-rules .tab-content>div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* Reduce spacing in Business Rules cards */
        #business-rules .card {
            margin-bottom: 16px !important;
        }

        #business-rules .card:first-of-type {
            margin-top: 0 !important;
        }

        /* Optimize sidebar cards height */
        #business-rules .card[style*="max-height"] {
            max-height: 450px !important;
        }

        /* Reduce padding in empty states */
        #business-rules .empty-state {
            padding: 20px !important;
        }

        /* Reduce card padding in Business Rules */
        #business-rules .card-header {
            padding: 16px 20px !important;
        }

        #business-rules .card {
            padding: 0 !important;
        }

        #business-rules .card>div:not(.card-header) {
            padding: 16px 20px;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .data-table th {
            background: var(--bg-light);
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 2px solid var(--border);
        }

        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-dark);
        }

        .data-table tr:hover td {
            background: var(--bg-light);
        }

        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-dark);
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            margin-bottom: 24px;
        }

        .back-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Module Tags */
        .module-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
        }

        .module-tag {
            background: #e0e7ff;
            color: var(--primary-dark);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .header {
                padding: 24px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 20px;
            }

            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .tab-btn {
                flex: none;
                padding: 10px 16px;
                font-size: 0.85rem;
            }

            .grid-2,
            .grid-3,
            .grid-4 {
                grid-template-columns: 1fr;
            }

            .app-type-banner {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <a href="/" class="back-btn">‚Üê Back to Upload</a>

        <div class="header">
            <h1>üè¶ Banking Application Analysis</h1>
            <p>File-wise analysis, application prediction, relationship detection, and business rules explanation</p>
        </div>

        <!-- Application Type Banner -->
        <div id="appTypeBanner" class="app-type-banner" style="display: none;">
            <div class="app-info">
                <h2>Detected Banking Application</h2>
                <div class="app-name" id="appName">Core Banking System</div>
            </div>
            <div class="confidence-box">
                <div class="confidence-value" id="appConfidence">85%</div>
                <div class="confidence-label">Confidence</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('file-analysis')">üìÅ File Analysis</button>
            <button class="tab-btn" onclick="switchTab('account-verification')">‚úî Account Verification</button>
            <button class="tab-btn" onclick="switchTab('relationships')">üîó Relationships</button>
            <button class="tab-btn" onclick="switchTab('final-decision')">‚úÖ Final Decision</button>
            <button class="tab-btn" onclick="switchTab('business-rules')">üìã Business Rules</button>
            <button class="tab-btn" onclick="switchTab('column-details')">üìä Column Details</button>
            <button class="tab-btn" onclick="switchTab('app-structure')">üèóÔ∏è Application Structure</button>
        </div>

        <!-- Tab: File Analysis (STEP 1 & 2) -->
        <div id="file-analysis" class="tab-content active">
            <div class="card">
                <div class="step-indicator">
                    <span class="step-number">1</span>
                    <span class="step-title">File Level Analysis</span>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Each uploaded file is analyzed to identify column patterns and business meaning.
                </p>
                <div id="fileAnalysisContent">
                    <div class="empty-state">
                        <div class="icon">üìÅ</div>
                        <p>Loading file analysis...</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="step-indicator">
                    <span class="step-number">2</span>
                    <span class="step-title">Application Tagging</span>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Each file is tagged with its primary banking application based on column patterns.
                </p>
                <div id="appTaggingContent">
                    <div class="empty-state">
                        <div class="icon">üè∑Ô∏è</div>
                        <p>Loading application tags...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Relationships (STEP 3) -->
        <div id="relationships" class="tab-content">
            <div class="card">
                <div class="step-indicator">
                    <span class="step-number">3</span>
                    <span class="step-title">Multi-File Relationship Check</span>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Checking if files share common keys and form a single operational workflow.
                </p>

                <div class="grid-4" style="margin-bottom: 24px;">
                    <div class="stat-card">
                        <div class="stat-value" id="commonKeysValue" style="font-size:1.5rem;">-</div>
                        <div class="stat-label">Common Keys</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="workflowValue" style="font-size:1.5rem;">-</div>
                        <div class="stat-label">Business Flow</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="pkCount" style="font-size:1.5rem;">-</div>
                        <div class="stat-label">Primary Keys</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="fkCount" style="font-size:1.5rem;">-</div>
                        <div class="stat-label">Foreign Keys</div>
                    </div>
                </div>



                <h4 style="margin: 24px 0 16px; color: var(--text-dark);">üîó Detected Relationships</h4>
                <div id="relationshipsContent">
                    <div class="empty-state">
                        <div class="icon">üîó</div>
                        <p>No relationships detected yet.</p>
                    </div>
                </div>

                <!-- Primary Domain Details Section -->
                <h4
                    style="margin: 32px 0 16px; color: var(--text-dark); border-top: 2px solid var(--border); padding-top: 24px;">
                    üè∑Ô∏è Primary Domain Details
                </h4>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Overview of primary domains identified for each file, including domain type, confidence score, and
                    key characteristics.
                </p>
                <div id="primaryDomainDetailsContent">
                    <div class="empty-state">
                        <div class="icon">üè∑Ô∏è</div>
                        <p>Loading primary domain details...</p>
                    </div>
                </div>

                <h4
                    style="margin: 32px 0 16px; color: var(--text-dark); border-top: 2px solid var(--border); padding-top: 24px;">
                    üìã File-to-File Connections with Detailed Explanations
                </h4>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Detailed analysis of how your uploaded files are connected, why they are linked, and their business
                    purpose.
                </p>
                <div id="fileRelationshipsContent">
                    <div class="empty-state">
                        <div class="icon">üìÅ</div>
                        <p>Loading file relationship analysis...</p>
                    </div>
                </div>

                <h4
                    style="margin: 32px 0 16px; color: var(--text-dark); border-top: 2px solid var(--border); padding-top: 24px;">
                    üè¶ Banking Domain & Column Relationship Analysis
                </h4>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Identify what kind of banking domain each file belongs to and see how columns relate between files
                    with detailed explanations.
                </p>

                <!-- File Banking Domains -->
                <h5 style="margin: 24px 0 16px; color: var(--primary); font-size: 1.1rem;">üìä File Banking Domains</h5>
                <div id="fileDomainsContent">
                    <div class="empty-state">
                        <div class="icon">üìÅ</div>
                        <p>Analyzing file banking domains...</p>
                    </div>
                </div>

                <!-- Column Relationships -->
                <h5
                    style="margin: 32px 0 16px; color: var(--primary); font-size: 1.1rem; border-top: 2px solid var(--border); padding-top: 24px;">
                    üîó Column-to-Column Relationships
                </h5>
                <p style="color: var(--text-muted); margin-bottom: 20px;">
                    Detailed explanations of how columns in different files are connected and their banking purpose.
                </p>
                <div id="columnRelationshipsContent">
                    <div class="empty-state">
                        <div class="icon">üîó</div>
                        <p>Analyzing column relationships...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Final Decision (STEP 4 & 5) -->
        <div id="final-decision" class="tab-content">
            <div class="card">
                <div class="step-indicator">
                    <span class="step-number">4</span>
                    <span class="step-title">Final Application Decision</span>
                </div>

                <div id="finalDecisionContent">
                    <div class="decision-box single" id="decisionBox">
                        <div class="decision-title" id="decisionTitle">‚è≥ Analyzing...</div>
                        <div class="decision-subtitle" id="decisionSubtitle">Loading decision data...</div>
                    </div>
                </div>

                <div class="explanation-box" id="explanationBox">
                    <h4>üí° Simple Explanation (For Non-Technical Users)</h4>
                    <p id="simpleExplanation">
                        Loading explanation...
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="step-indicator">
                    <span class="step-number">5</span>
                    <span class="step-title">Summary Report</span>
                </div>

                <div class="grid-4" style="margin-bottom: 20px;" id="summaryStats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalFiles">-</div>
                        <div class="stat-label">Files Analyzed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalColumns">-</div>
                        <div class="stat-label">Total Columns</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalRows">-</div>
                        <div class="stat-label">Total Rows</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="domainConfidence">-</div>
                        <div class="stat-label">Confidence</div>
                    </div>
                </div>

                <div id="modulesIncluded">
                    <h4 style="margin-bottom: 12px; color: var(--text-dark);">üì¶ Detected Modules</h4>
                    <div class="module-tags" id="modulesList"></div>
                </div>
            </div>
        </div>

        <!-- Tab: Account Verification (Banking UI Explanation) -->
        <div id="account-verification" class="tab-content">
            <div id="accountVerificationContent">
                <!-- Banking UI Explanation will be inserted here -->
            </div>
        </div>

        <!-- Tab: Business Rules -->
        <div id="business-rules" class="tab-content">
            <!-- Application Type Banner (Top, Full Width) -->
            <div id="businessRulesAppTypeBanner" style="display: none; margin-bottom: 16px;">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Main Content Area -->
            <div style="display: grid; grid-template-columns: 1fr 420px; gap: 16px; align-items: start;">
                <!-- Left: Column Business Rules (One by One) -->
                <div style="min-width: 0;">
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-header">
                            <h3 class="card-title">üìã Column Business Rules</h3>
                        </div>
                        <p style="color: var(--text-muted); margin-bottom: 16px;">
                            Each column is analyzed with its <strong>Definition</strong>, <strong>Condition</strong>, and <strong>Action</strong> (why valid/invalid).
                            <strong style="color: var(--primary);">All rules are dynamically generated from your uploaded file data - no hardcoded assumptions.</strong>
                            Review each rule below.
                        </p>
                        <!-- Search and Filter Controls -->
                        <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                            <input type="text" id="businessRulesSearch" placeholder="üîç Search columns..." 
                                style="flex: 1; min-width: 200px; padding: 10px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem;">
                            <select id="businessRulesFilter" 
                                style="padding: 10px 16px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; cursor: pointer;">
                                <option value="all">All Status</option>
                                <option value="VALID">‚úÖ Valid</option>
                                <option value="WARNING">‚ö†Ô∏è Warning</option>
                                <option value="INVALID">üö© Invalid</option>
                            </select>
                        </div>
                        <div id="businessRulesContent">
                            <!-- Dynamic business rules will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Right: Application Structure & Column Relationships (Small, Bottom) -->
                <div style="display: flex; flex-direction: column; gap: 16px;">
                    <!-- Primary Domain Details (Compact) -->
                    <div class="card" style="max-height: 450px; overflow-y: auto; margin-bottom: 0;">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 1rem;">üè∑Ô∏è Primary Domain Details</h3>
                        </div>
                        <div id="businessRulesPrimaryDomainDetails">
                            <div class="empty-state" style="padding: 20px;">
                                <div class="icon" style="font-size: 2rem;">üè∑Ô∏è</div>
                                <p style="font-size: 0.85rem;">Loading domain details...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Application Structure (Compact) -->
                    <div class="card" style="max-height: 450px; overflow-y: auto; margin-bottom: 0;">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 1rem;">üèóÔ∏è Application Structure</h3>
                        </div>
                        <div id="businessRulesAppStructure">
                            <div class="empty-state" style="padding: 20px;">
                                <div class="icon" style="font-size: 2rem;">üèóÔ∏è</div>
                                <p style="font-size: 0.85rem;">Loading structure...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Column Relationship Analysis (Compact) -->
                    <div class="card" style="max-height: 450px; overflow-y: auto; margin-bottom: 0;">
                        <div class="card-header">
                            <h3 class="card-title" style="font-size: 1rem;">üîó Column Relationships</h3>
                        </div>
                        <div id="businessRulesColumnRelationships">
                            <div class="empty-state" style="padding: 20px;">
                                <div class="icon" style="font-size: 2rem;">üîó</div>
                                <p style="font-size: 0.85rem;">Loading relationships...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Analysis Section -->
            <div class="card" style="margin-top: 16px; margin-bottom: 16px;">
                <div class="step-indicator">
                    <span class="step-number">1</span>
                    <span class="step-title">File Level Analysis</span>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 16px;">
                    Each uploaded file is analyzed to identify column patterns and business meaning.
                </p>
                <div id="businessRulesFileAnalysisContent">
                    <div class="empty-state">
                        <div class="icon">üìÅ</div>
                        <p>Loading file analysis...</p>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 16px; margin-bottom: 16px;">
                <div class="step-indicator">
                    <span class="step-number">2</span>
                    <span class="step-title">Application Tagging</span>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 16px;">
                    Each file is tagged with its primary banking application based on column patterns.
                </p>
                <div id="businessRulesAppTaggingContent">
                    <div class="empty-state">
                        <div class="icon">üè∑Ô∏è</div>
                        <p>Loading application tags...</p>
                    </div>
                </div>
            </div>

            <!-- Column Details Section -->
            <div class="card" style="margin-top: 16px; margin-bottom: 16px;">
                <div class="card-header">
                    <h3 class="card-title">üìä Column-Level Analysis</h3>
                </div>
                <div id="businessRulesColumnDetailsContent">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Column Name</th>
                                <th>Business Meaning</th>
                                <th>Category</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="businessRulesColumnTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--text-muted); padding: 40px;">
                                    Loading column details...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Account Verification Section -->
            <div class="card" style="margin-top: 16px; margin-bottom: 16px;">
                <div class="card-header">
                    <h3 class="card-title">‚úî Account Verification</h3>
                </div>
                <div id="businessRulesAccountVerificationContent">
                    <div class="empty-state">
                        <div class="icon">‚úî</div>
                        <p>Loading account verification...</p>
                    </div>
                </div>
            </div>

            <!-- Full Application Structure Section -->
            <div class="card" style="margin-top: 16px; margin-bottom: 16px;">
                <div class="card-header">
                    <h3 class="card-title">üèóÔ∏è Banking Application Structure</h3>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 16px;">
                    Dynamically generated banking application structure based on uploaded files. Shows modules, columns,
                    relationships, and business rules.
                </p>
                <div id="businessRulesApplicationStructureContent">
                    <div class="empty-state">
                        <div class="icon">üèóÔ∏è</div>
                        <p>Loading application structure...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Column Details -->
        <div id="column-details" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìä Column-Level Analysis</h3>
                </div>

                <div id="columnDetailsContent">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Column Name</th>
                                <th>Business Meaning</th>
                                <th>Category</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="columnTableBody">
                            <tr>
                                <td colspan="4" style="text-align: center; color: var(--text-muted); padding: 40px;">
                                    Loading column details...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab: Application Structure -->
        <div id="app-structure" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üèóÔ∏è Banking Application Structure</h3>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 24px;">
                    Dynamically generated banking application structure based on uploaded files. Shows modules, columns,
                    relationships, and business rules.
                </p>
                <div id="applicationStructureContent">
                    <div class="empty-state">
                        <div class="icon">üèóÔ∏è</div>
                        <p>Loading application structure...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>


        // Tab switching
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.currentTarget.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // Handle full-width for Business Rules tab
            const container = document.querySelector('.container');
            if (tabId === 'business-rules') {
                container.classList.add('full-width');
            } else {
                container.classList.remove('full-width');
            }
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadAnalysisData();
        });

        function loadAnalysisData() {
            const isMultiFile = sessionStorage.getItem('multiFileMode') === 'true';

            // Application Type
            loadApplicationType();

            // Multi-file or single file data
            if (isMultiFile) {
                loadMultiFileData();
            } else {
                loadSingleFileData();
            }

            // Load validation data
            loadValidationData();

            // Load final decision
            loadFinalDecision();

            // Load dynamic business rules
            loadBusinessRules();

            // Load application structure
            loadApplicationStructure();

            // Load banking UI explanation (user-friendly verification screen)
            loadAccountVerificationUI();
        }

        function loadApplicationType() {
            // Priority order: 1. Dynamic prediction, 2. Blueprint, 3. Banking result, 4. Other sources
            const appTypePrediction = JSON.parse(sessionStorage.getItem('applicationTypePrediction') || 'null');
            const blueprint = JSON.parse(sessionStorage.getItem('bankingBlueprint') || 'null');
            const appType = JSON.parse(sessionStorage.getItem('bankingApplicationType') || 'null');
            const bankingResult = JSON.parse(sessionStorage.getItem('bankingResult') || 'null');

            const banner = document.getElementById('appTypeBanner');

            // Priority 1: Dynamic Business Rules Validator Application Type Prediction (NEW)
            if (appTypePrediction && appTypePrediction.application_type && appTypePrediction.application_type !== 'Unknown') {
                banner.style.display = 'flex';
                document.getElementById('appName').textContent = appTypePrediction.application_type;
                document.getElementById('appConfidence').textContent = `${appTypePrediction.confidence || 0}%`;

                // Add reasoning tooltip if available
                if (appTypePrediction.reasoning) {
                    banner.title = appTypePrediction.reasoning;
                    banner.style.cursor = 'help';
                }
                return;
            }

            // Priority 2: Banking Blueprint
            if (blueprint && blueprint.application) {
                banner.style.display = 'flex';
                document.getElementById('appName').textContent = blueprint.application || 'Core Banking System';
                document.getElementById('appConfidence').textContent = `${blueprint.application_confidence || 0}%`;
                return;
            }

            // Priority 3: Banking Application Type
            if (appType && appType.predicted_application) {
                banner.style.display = 'flex';
                document.getElementById('appName').textContent = appType.predicted_application;
                document.getElementById('appConfidence').textContent = `${appType.confidence || 0}%`;
                return;
            }

            // Priority 4: Banking Result
            if (bankingResult && bankingResult.banking_application_type) {
                const at = bankingResult.banking_application_type;
                banner.style.display = 'flex';
                document.getElementById('appName').textContent = at.predicted_application || 'Core Banking System';
                document.getElementById('appConfidence').textContent = `${at.confidence || 0}%`;
                return;
            }
        }

        function loadMultiFileData() {
            const relationships = JSON.parse(sessionStorage.getItem('multiFileRelationships') || '[]');
            const primaryKeys = JSON.parse(sessionStorage.getItem('multiFilePrimaryKeys') || '{}');
            const foreignKeys = JSON.parse(sessionStorage.getItem('multiFileForeignKeys') || '[]');
            const tableResults = JSON.parse(sessionStorage.getItem('multiFileTableResults') || '[]');

            // Update stats
            const hasCommonKeys = Object.keys(primaryKeys).length > 0 || foreignKeys.length > 0;
            document.getElementById('commonKeysValue').textContent = hasCommonKeys ? 'Yes ‚úÖ' : 'No ‚ùå';
            document.getElementById('commonKeysValue').style.color = hasCommonKeys ? 'var(--success)' : 'var(--danger)';

            const hasWorkflow = relationships.length > 0 || foreignKeys.length > 0;
            document.getElementById('workflowValue').textContent = hasWorkflow ? 'Yes ‚úÖ' : 'No ‚ùå';
            document.getElementById('workflowValue').style.color = hasWorkflow ? 'var(--success)' : 'var(--danger)';

            document.getElementById('pkCount').textContent = Object.keys(primaryKeys).length;
            document.getElementById('fkCount').textContent = foreignKeys.length;

            // File Analysis
            if (tableResults.length > 0) {
                let fileHtml = '';
                let appTagHtml = '';

                tableResults.forEach((table, idx) => {
                    const appTag = detectApplicationTag(table.columns || []);
                    const appReason = getApplicationReason(appTag, table.columns || []);

                    fileHtml += `
                        <div class="file-card banking">
                            <div class="file-header">
                                <span class="file-name">üìÑ ${table.table_name || `File ${idx + 1}`}</span>
                                <span class="badge badge-primary">${(table.columns || []).length} columns</span>
                            </div>
                            <div class="file-reason">
                                <strong>Columns:</strong> ${(table.columns || []).slice(0, 10).join(', ')}${(table.columns || []).length > 10 ? '...' : ''}<br>
                                <strong>Rows:</strong> ${(table.total_rows || 0).toLocaleString()}
                            </div>
                        </div>
                    `;

                    appTagHtml += `
                        <div class="file-card banking">
                            <div class="file-header">
                                <span class="file-name">üìÑ ${table.table_name || `File ${idx + 1}`}</span>
                                <span class="file-app-tag">${appTag}</span>
                            </div>
                            <div class="file-reason">
                                <strong>Reason:</strong> ${appReason}
                            </div>
                        </div>
                    `;
                });

                document.getElementById('fileAnalysisContent').innerHTML = fileHtml;
                document.getElementById('appTaggingContent').innerHTML = appTagHtml;

                // Update summary
                document.getElementById('totalFiles').textContent = tableResults.length;

                let totalCols = 0, totalRows = 0;
                tableResults.forEach(t => {
                    totalCols += (t.columns || []).length;
                    totalRows += t.total_rows || 0;
                });
                document.getElementById('totalColumns').textContent = totalCols;
                document.getElementById('totalRows').textContent = totalRows.toLocaleString();


            }

            // Display relationships
            displayRelationships(relationships, foreignKeys);

            // Display file-to-file relationships with detailed explanations
            displayFileRelationships();

            // Display banking domains and column relationships
            displayColumnRelationshipAnalysis();

            // Display primary domain details
            loadPrimaryDomainDetails();
        }

        function loadSingleFileData() {
            const bankingResult = JSON.parse(sessionStorage.getItem('bankingResult') || 'null');

            if (bankingResult) {
                const columns = bankingResult.matched_columns || [];
                const appTag = detectApplicationTag(columns);

                document.getElementById('fileAnalysisContent').innerHTML = `
                    <div class="file-card banking">
                        <div class="file-header">
                            <span class="file-name">üìÑ Uploaded File</span>
                            <span class="badge badge-primary">${bankingResult.total_columns || 0} columns</span>
                        </div>
                        <div class="file-reason">
                            <strong>Matched Columns:</strong> ${columns.slice(0, 10).join(', ') || 'N/A'}<br>
                            <strong>Domain:</strong> ${bankingResult.domain || 'Banking'} | 
                            <strong>Confidence:</strong> ${bankingResult.confidence_percentage || 0}%
                        </div>
                    </div>
                `;

                document.getElementById('appTaggingContent').innerHTML = `
                    <div class="file-card banking">
                        <div class="file-header">
                            <span class="file-name">üìÑ Uploaded File</span>
                            <span class="file-app-tag">${appTag}</span>
                        </div>
                        <div class="file-reason">
                            <strong>Reason:</strong> ${getApplicationReason(appTag, columns)}
                        </div>
                    </div>
                `;

                document.getElementById('totalFiles').textContent = '1';
                document.getElementById('totalColumns').textContent = bankingResult.total_columns || 0;
                document.getElementById('totalRows').textContent = '-';
                document.getElementById('domainConfidence').textContent = `${bankingResult.confidence_percentage || 0}%`;
            }
        }

        function detectApplicationTag(columns) {
            const colLower = columns.map(c => c.toLowerCase());

            const rules = [
                { keywords: ['customer_id', 'customer_name', 'dob', 'gender', 'phone', 'email', 'kyc'], tag: 'Customer Management' },
                { keywords: ['account_number', 'account_type', 'branch', 'ifsc', 'opened_date', 'account_status'], tag: 'Core Banking - Account' },
                { keywords: ['transaction_id', 'transaction_date', 'transaction_amount', 'transaction_type', 'balance_after'], tag: 'Core Banking - Transaction' },
                { keywords: ['loan_id', 'loan_amount', 'interest_rate', 'tenure', 'credit_score', 'eligibility'], tag: 'Loan Management' },
                { keywords: ['card_number', 'card_type', 'expiry_date', 'limit_amount', 'card_status'], tag: 'Card Management' },
                { keywords: ['fraud_flag', 'device_type', 'location', 'transaction_time'], tag: 'Fraud Detection' }
            ];

            for (const rule of rules) {
                const matches = rule.keywords.filter(kw => colLower.some(c => c.includes(kw)));
                if (matches.length >= 2) return rule.tag;
            }

            return 'Banking Module';
        }

        function getApplicationReason(appTag, columns) {
            const reasons = {
                'Customer Management': 'Contains customer identification and KYC-related columns like customer_id, name, email, phone.',
                'Core Banking - Account': 'Contains core account management columns like account_number, account_type, branch, IFSC.',
                'Core Banking - Transaction': 'Contains transaction processing columns like transaction_id, transaction_date, amount, type.',
                'Loan Management': 'Contains loan-related columns like loan_id, loan_amount, interest_rate, tenure, credit_score.',
                'Card Management': 'Contains card management columns like card_number, card_type, expiry_date, limit.',
                'Fraud Detection': 'Contains fraud monitoring columns like fraud_flag, device_type, location, transaction patterns.',
                'Banking Module': 'Contains general banking-related columns.'
            };
            return reasons[appTag] || 'Identified based on column pattern matching.';
        }

        function displayRelationships(relationships, foreignKeys) {
            // üî• NEW: Try comprehensive analysis first, fallback to legacy
            const comprehensiveAnalysis = JSON.parse(sessionStorage.getItem('comprehensiveAnalysis') || 'null');

            if (comprehensiveAnalysis && comprehensiveAnalysis.step7_final_relationships) {
                displayComprehensiveRelationships(comprehensiveAnalysis);
                return;
            }

            // Legacy display
            const rels = relationships.length > 0 ? relationships : foreignKeys;

            if (rels.length > 0) {
                let html = '';
                rels.forEach(rel => {
                    html += `
                        <div class="relationship-box">
                            <div class="relationship-arrow">
                                <span class="table-box">üìã ${rel.parent_table || rel.parent_file}</span>
                                <span class="arrow">‚Üí</span>
                                <span class="table-box">üìã ${rel.child_table || rel.child_file}</span>
                            </div>
                            <p style="margin-top: 12px; color: var(--text-muted);">
                                <strong>Link:</strong> ${rel.parent_column || 'PK'} ‚Üí ${rel.child_column || 'FK'}
                                ${rel.overlap_ratio ? ` | <strong>Match Rate:</strong> ${(rel.overlap_ratio * 100).toFixed(1)}%` : ''}
                            </p>
                        </div>
                    `;
                });
                document.getElementById('relationshipsContent').innerHTML = html;
            }
        }

        function displayComprehensiveRelationships(comprehensiveAnalysis) {
            const finalRelationships = comprehensiveAnalysis.step7_final_relationships || [];
            const errorReport = comprehensiveAnalysis.step9_error_report || {};
            const rejectedRelations = errorReport.rejected_relationships || [];

            let html = '';

            // Display valid relationships
            if (finalRelationships.length > 0) {
                html += '<h4 style="margin-bottom: 16px; color: var(--primary);">‚úÖ Valid Banking Relationships</h4>';

                finalRelationships.forEach((rel, index) => {
                    const confidenceColor = rel.confidence_level === 'STRONG' ? 'var(--success)' :
                        rel.confidence_level === 'WEAK' ? 'var(--warning)' : 'var(--danger)';
                    const matchRate = (rel.match_rate || 0) * 100;

                    html += `
                        <div class="card" style="margin-bottom: 20px; border-left: 5px solid ${confidenceColor};">
                            <div class="card-header">
                                <h4 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">
                                    üîó Relationship ${index + 1}: ${rel.parent_file} ‚Üí ${rel.child_file}
                                </h4>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span class="badge" style="background: ${confidenceColor}; color: white;">
                                        ${rel.confidence_level}
                                    </span>
                                    <span class="badge badge-primary">
                                        ${matchRate.toFixed(1)}% Match
                                    </span>
                                </div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-top: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid var(--primary);">
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Parent File</div>
                                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">${rel.parent_file}</div>
                                        <div style="font-size: 1rem; font-weight: 600; color: var(--text-dark); margin-top: 8px;">
                                            PK: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${rel.parent_column}</code>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid var(--success);">
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">Child File</div>
                                        <div style="font-weight: 600; color: var(--success); margin-bottom: 4px;">${rel.child_file}</div>
                                        <div style="font-size: 1rem; font-weight: 600; color: var(--text-dark); margin-top: 8px;">
                                            FK: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${rel.child_column}</code>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 16px;">
                                    <strong style="color: var(--primary); display: block; margin-bottom: 8px;">Relationship Type:</strong>
                                    <div style="font-size: 1rem; font-weight: 600; color: var(--text-dark);">
                                        ${rel.relationship_type}
                                    </div>
                                </div>
                                
                                <div style="background: linear-gradient(135deg, #f0f5ff 0%, #ffffff 100%); padding: 20px; border-radius: 8px; border: 1px solid #c7d2fe;">
                                    <h5 style="color: var(--primary); margin-bottom: 12px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                                        üí° Banking Justification
                                    </h5>
                                    <p style="color: #1f2937; line-height: 1.8; font-size: 0.95rem; margin: 0;">
                                        ${rel.banking_justification}
                                    </p>
                                </div>
                                
                                <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${rel.overlap_count || 0}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Matching Values</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div class="empty-state"><div class="icon">üîó</div><p>No valid relationships detected.</p></div>';
            }

            // Display rejected relationships
            if (rejectedRelations.length > 0) {
                html += '<h4 style="margin: 32px 0 16px; color: var(--danger); border-top: 2px solid var(--border); padding-top: 24px;">‚ùå Rejected Relationships (Invalid)</h4>';

                rejectedRelations.forEach((rel, index) => {
                    html += `
                        <div class="card" style="margin-bottom: 16px; border-left: 5px solid var(--danger); background: #fef2f2;">
                            <div style="padding: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <strong style="color: var(--danger);">Rejected: ${rel.parent_file}.${rel.parent_column} ‚Üí ${rel.child_file}.${rel.child_column}</strong>
                                    <span class="badge badge-danger">INVALID</span>
                                </div>
                                <p style="color: var(--text-muted); margin: 0; font-size: 0.9rem;">
                                    <strong>Reason:</strong> ${rel.rejection_reason || 'Invalid relationship'}
                                </p>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('relationshipsContent').innerHTML = html;
        }

        function displayFileRelationships() {
            // Get file relationships from sessionStorage or from the API response
            const fileRelationships = JSON.parse(sessionStorage.getItem('fileRelationships') || '[]');

            console.log('File Relationships from sessionStorage:', fileRelationships);

            if (fileRelationships && fileRelationships.length > 0) {
                let html = '';

                fileRelationships.forEach((rel, index) => {
                    const overlapPercent = (rel.overlap_info?.overlap_ratio || 0) * 100;
                    const overlapColor = overlapPercent >= 70 ? 'var(--success)' : overlapPercent >= 40 ? 'var(--warning)' : 'var(--danger)';

                    html += `
                        <div class="card" style="margin-bottom: 24px; border-left: 5px solid ${overlapColor};">
                            <div class="card-header">
                                <h3 class="card-title" style="font-size: 1.1rem;">
                                    üîó Connection ${index + 1}: ${rel.parent_file} ‚Üî ${rel.child_file}
                                </h3>
                                <span class="badge" style="background: ${overlapColor}; color: white;">
                                    ${overlapPercent.toFixed(1)}% Match
                                </span>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div>
                                        <strong style="color: var(--primary); display: block; margin-bottom: 4px;">Parent File:</strong>
                                        <span>${rel.parent_file}</span>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                            Entity: ${rel.parent_entity} | Column: ${rel.parent_column} (${rel.parent_column_type})
                                        </div>
                                    </div>
                                    <div>
                                        <strong style="color: var(--primary); display: block; margin-bottom: 4px;">Child File:</strong>
                                        <span>${rel.child_file}</span>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                            Entity: ${rel.child_entity} | Column: ${rel.child_column} (${rel.child_column_type})
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary);">
                                    <strong style="color: var(--primary); display: block; margin-bottom: 8px;">Relationship Type:</strong>
                                    <span style="font-size: 1rem; font-weight: 600;">${rel.relationship_type}</span>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #f0f5ff 0%, #ffffff 100%); padding: 20px; border-radius: 8px; border: 1px solid #c7d2fe;">
                                <h4 style="color: var(--primary); margin-bottom: 12px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                                    üí° Detailed Explanation
                                </h4>
                                <div style="line-height: 1.8; color: #1f2937; font-size: 0.95rem;">
                                    ${rel.detailed_explanation || rel.purpose || 'Relationship detected between files.'}
                                </div>
                            </div>
                            
                            ${rel.overlap_info ? `
                            <div style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                <div style="background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${rel.overlap_info.overlap_count}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Matching Values</div>
                                </div>
                                <div style="background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${rel.overlap_info.total_unique_file1}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Unique in ${rel.parent_file}</div>
                                </div>
                                <div style="background: #f8fafc; padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${rel.overlap_info.total_unique_file2}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Unique in ${rel.child_file}</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });

                document.getElementById('fileRelationshipsContent').innerHTML = html;
            } else {
                document.getElementById('fileRelationshipsContent').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìÅ</div>
                        <p>No file-to-file relationships detected. Upload multiple files to see connections.</p>
                    </div>
                `;
            }
        }

        function displayColumnRelationshipAnalysis() {
            // Get column relationship analysis from sessionStorage
            const columnAnalysis = JSON.parse(sessionStorage.getItem('columnRelationshipAnalysis') || 'null');

            if (!columnAnalysis || !columnAnalysis.file_domains) {
                document.getElementById('fileDomainsContent').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìä</div>
                        <p>No banking domain analysis available. Upload multiple files to see domain information.</p>
                    </div>
                `;
                document.getElementById('columnRelationshipsContent').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîó</div>
                        <p>No column relationship analysis available.</p>
                    </div>
                `;
                return;
            }

            // Display File Banking Domains
            const fileDomains = columnAnalysis.file_domains || [];
            if (fileDomains.length > 0) {
                let domainsHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">';

                fileDomains.forEach(fileInfo => {
                    const confidenceColor = fileInfo.domain_confidence >= 70 ? 'var(--success)' :
                        fileInfo.domain_confidence >= 40 ? 'var(--warning)' : 'var(--danger)';

                    domainsHtml += `
                        <div class="card" style="border-left: 5px solid ${confidenceColor};">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <span style="font-size: 2rem;">${fileInfo.domain_icon}</span>
                                <div>
                                    <h4 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">${fileInfo.file_name}</h4>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                        ${fileInfo.total_columns} columns ‚Ä¢ ${fileInfo.total_rows.toLocaleString()} rows
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: var(--primary);">Primary Domain:</strong>
                                    <span style="background: ${confidenceColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                        ${fileInfo.domain_confidence.toFixed(0)}%
                                    </span>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">
                                    ${fileInfo.primary_domain}
                                </div>
                                <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; margin: 0;">
                                    ${fileInfo.domain_description}
                                </p>
                            </div>
                            
                            ${fileInfo.matched_columns && fileInfo.matched_columns.length > 0 ? `
                                <div style="margin-top: 12px;">
                                    <strong style="color: var(--text-dark); font-size: 0.9rem; display: block; margin-bottom: 8px;">
                                        Key Columns (${fileInfo.matched_columns.length}):
                                    </strong>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${fileInfo.matched_columns.slice(0, 8).map(col => `
                                            <span style="background: #e0e7ff; color: var(--primary-dark); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem;">
                                                ${col}
                                            </span>
                                        `).join('')}
                                        ${fileInfo.matched_columns.length > 8 ? `<span style="color: var(--text-muted); font-size: 0.8rem;">+${fileInfo.matched_columns.length - 8} more</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                domainsHtml += '</div>';
                document.getElementById('fileDomainsContent').innerHTML = domainsHtml;
            }

            // Display Column Relationships
            const columnRelationships = columnAnalysis.column_relationships || [];
            if (columnRelationships.length > 0) {
                let relationshipsHtml = '';

                columnRelationships.forEach((rel, index) => {
                    const strengthColor = rel.connection_strength === 'Strong' ? 'var(--success)' :
                        rel.connection_strength === 'Moderate' ? 'var(--warning)' : 'var(--danger)';
                    const overlapPercent = rel.overlap_info.overlap_percentage || 0;

                    relationshipsHtml += `
                        <div class="card" style="margin-bottom: 24px; border-left: 5px solid ${strengthColor};">
                            <div class="card-header">
                                <h4 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">
                                    üîó Relationship ${index + 1}: ${rel.file1_column} ‚Üî ${rel.file2_column}
                                </h4>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span class="badge" style="background: ${strengthColor}; color: white;">
                                        ${rel.connection_strength}
                                    </span>
                                    <span class="badge badge-primary">
                                        ${overlapPercent}% Match
                                    </span>
                                </div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid var(--primary);">
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">File 1</div>
                                        <div style="font-weight: 600; color: var(--primary); margin-bottom: 4px;">${rel.file1}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">
                                            ${rel.file1_domain}
                                        </div>
                                        <div style="font-size: 1rem; font-weight: 600; color: var(--text-dark);">
                                            Column: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${rel.file1_column}</code>
                                        </div>
                                    </div>
                                    <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid var(--success);">
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 4px;">File 2</div>
                                        <div style="font-weight: 600; color: var(--success); margin-bottom: 4px;">${rel.file2}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">
                                            ${rel.file2_domain}
                                        </div>
                                        <div style="font-size: 1rem; font-weight: 600; color: var(--text-dark);">
                                            Column: <code style="background: #f3f4f6; padding: 2px 6px; border-radius: 4px;">${rel.file2_column}</code>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary); margin-bottom: 16px;">
                                    <strong style="color: var(--primary); display: block; margin-bottom: 8px;">Relationship Type:</strong>
                                    <div style="font-size: 1rem; font-weight: 600; color: var(--text-dark);">
                                        ${rel.relationship_type}
                                    </div>
                                </div>
                                
                                <div style="background: linear-gradient(135deg, #f0f5ff 0%, #ffffff 100%); padding: 20px; border-radius: 8px; border: 1px solid #c7d2fe; margin-bottom: 16px;">
                                    <h5 style="color: var(--primary); margin-bottom: 12px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                                        üí° Explanation
                                    </h5>
                                    <p style="color: #1f2937; line-height: 1.8; font-size: 0.95rem; margin-bottom: 12px;">
                                        ${rel.explanation}
                                    </p>
                                    <div style="background: #e0f2fe; padding: 12px; border-radius: 6px; border-left: 3px solid #0284c7; margin-top: 12px;">
                                        <strong style="color: #0c4a6e; display: block; margin-bottom: 4px;">Business Value:</strong>
                                        <p style="color: #075985; line-height: 1.6; font-size: 0.9rem; margin: 0;">
                                            ${rel.business_value}
                                        </p>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${rel.overlap_info.overlap_count}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Matching Values</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${rel.overlap_info.total_unique_file1}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Unique in ${rel.file1}</div>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${rel.overlap_info.total_unique_file2}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">Unique in ${rel.file2}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('columnRelationshipsContent').innerHTML = relationshipsHtml;
            } else {
                document.getElementById('columnRelationshipsContent').innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üîó</div>
                        <p>No column relationships detected between the uploaded files.</p>
                    </div>
                `;
            }
        }

        // Function to load Primary Domain Details in Relationships tab
        function loadPrimaryDomainDetails() {
            const container = document.getElementById('primaryDomainDetailsContent');
            if (!container) return;

            try {
                const columnAnalysis = JSON.parse(sessionStorage.getItem('columnRelationshipAnalysis') || 'null');

                if (!columnAnalysis || !columnAnalysis.file_domains || columnAnalysis.file_domains.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üè∑Ô∏è</div>
                            <p>No primary domain details available. Upload files to see domain information.</p>
                        </div>
                    `;
                    return;
                }

                const fileDomains = columnAnalysis.file_domains || [];
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px;">';

                fileDomains.forEach(fileInfo => {
                    const confidenceColor = fileInfo.domain_confidence >= 70 ? 'var(--success)' :
                        fileInfo.domain_confidence >= 40 ? 'var(--warning)' : 'var(--danger)';

                    html += `
                        <div class="card" style="border-left: 5px solid ${confidenceColor};">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                <span style="font-size: 2rem;">${fileInfo.domain_icon || 'üè¶'}</span>
                                <div style="flex: 1;">
                                    <h4 style="margin: 0; color: var(--text-dark); font-size: 1.1rem;">${fileInfo.file_name || 'Unknown File'}</h4>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                                        ${fileInfo.total_columns || 0} columns ‚Ä¢ ${(fileInfo.total_rows || 0).toLocaleString()} rows
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: var(--primary);">Primary Domain:</strong>
                                    <span style="background: ${confidenceColor}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                        ${(fileInfo.domain_confidence || 0).toFixed(0)}%
                                    </span>
                                </div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">
                                    ${fileInfo.primary_domain || 'Not Detected'}
                                </div>
                                <p style="color: var(--text-muted); font-size: 0.9rem; line-height: 1.6; margin: 0;">
                                    ${fileInfo.domain_description || 'No description available.'}
                                </p>
                            </div>
                            
                            ${fileInfo.matched_columns && fileInfo.matched_columns.length > 0 ? `
                                <div style="margin-top: 12px;">
                                    <strong style="color: var(--text-dark); font-size: 0.9rem; display: block; margin-bottom: 8px;">
                                        Key Columns (${fileInfo.matched_columns.length}):
                                    </strong>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                        ${fileInfo.matched_columns.slice(0, 6).map(col => `
                                            <span style="background: #e0e7ff; color: var(--primary-dark); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem;">
                                                ${col}
                                            </span>
                                        `).join('')}
                                        ${fileInfo.matched_columns.length > 6 ? `<span style="color: var(--text-muted); font-size: 0.8rem;">+${fileInfo.matched_columns.length - 6} more</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            } catch (e) {
                console.error('Error loading primary domain details:', e);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <p>Error loading primary domain details. Please try again.</p>
                    </div>
                `;
            }
        }

        function loadValidationData() {
            const validator = JSON.parse(sessionStorage.getItem('bankingDatasetValidator') || 'null');

            if (validator && validator.columns) {
                let tableHtml = '';
                validator.columns.forEach(col => {
                    const status = col.status || 'UNKNOWN';
                    const statusClass = status === 'MATCH' ? 'badge-success' : status === 'WARNING' ? 'badge-warning' : 'badge-danger';
                    tableHtml += `
                        <tr>
                            <td><strong>${col.name}</strong></td>
                            <td>${col.meaning || 'N/A'}</td>
                            <td>${col.category || detectColumnCategory(col.name)}</td>
                            <td><span class="badge ${statusClass}">${status}</span></td>
                        </tr>
                    `;
                });
                document.getElementById('columnTableBody').innerHTML = tableHtml;
            }
        }

        function detectColumnCategory(colName) {
            const lower = colName.toLowerCase();
            if (lower.includes('customer') || lower.includes('name') || lower.includes('email')) return 'Customer';
            if (lower.includes('account') || lower.includes('balance')) return 'Account';
            if (lower.includes('transaction') || lower.includes('txn')) return 'Transaction';
            if (lower.includes('loan') || lower.includes('interest')) return 'Loan';
            if (lower.includes('card')) return 'Card';
            return 'General';
        }

        function loadFinalDecision() {
            const blueprint = JSON.parse(sessionStorage.getItem('bankingBlueprint') || 'null');
            const isMultiFile = sessionStorage.getItem('multiFileMode') === 'true';
            const tableResults = JSON.parse(sessionStorage.getItem('multiFileTableResults') || '[]');
            const overallVerdict = JSON.parse(sessionStorage.getItem('overallVerdict') || 'null');

            const decisionBox = document.getElementById('decisionBox');
            const decisionTitle = document.getElementById('decisionTitle');
            const decisionSubtitle = document.getElementById('decisionSubtitle');
            const simpleExplanation = document.getElementById('simpleExplanation');

            let appName = blueprint?.application || 'Core Banking System';
            let moduleList = [];

            if (blueprint && blueprint.multi_file_metadata && blueprint.multi_file_metadata.column_distribution) {
                moduleList = Object.keys(blueprint.multi_file_metadata.column_distribution);
            } else {
                const modules = new Set();
                tableResults.forEach(table => {
                    modules.add(detectApplicationTag(table.columns || []));
                });
                moduleList = Array.from(modules);
            }

            const isSingleApp = (blueprint && blueprint.application_confidence > 70) ||
                overallVerdict === 'SINGLE_APPLICATION';

            if (isSingleApp) {
                decisionBox.className = 'decision-box single';
                decisionTitle.textContent = '‚úÖ ONE Application Detected';
                decisionSubtitle.innerHTML = `<strong>Application:</strong> ${appName}`;

                simpleExplanation.innerHTML = `
                    <strong>What does this mean?</strong><br><br>
                    Integrated analysis of your data confirms it belongs to a <strong>single banking system</strong>: ${appName}. 
                    The column patterns across all files align with the ${blueprint?.app_description || 'standard banking system'} architecture.<br><br>
                    <strong>In simple terms:</strong> Your data is highly connected and forms a complete operational workflow. 
                    This is ideal for system migration or auditing as it shows a consistent domain structure.
                `;
            } else {
                decisionBox.className = 'decision-box multiple';
                decisionTitle.textContent = '‚ö†Ô∏è Separate Banking Modules Detected';
                decisionSubtitle.innerHTML = `Found <strong>${moduleList.length}</strong> distinct file groups`;

                simpleExplanation.innerHTML = `
                    <strong>What does this mean?</strong><br><br>
                    Your files appear to represent <strong>different functional modules</strong> within a banking environment. 
                    While all are banking-related, they may be parts of separate subsystems or different stages of a project.<br><br>
                    <strong>Modules Found:</strong> ${moduleList.join(', ') || 'N/A'}<br><br>
                    <strong>In simple terms:</strong> You have uploaded components that serve different purposes (e.g., some for Accounts, some for Loans). 
                    They are all part of the bank, but may not be directly linked in a single operational table.
                `;
            }

            // Update confidence
            document.getElementById('domainConfidence').textContent = `${blueprint?.application_confidence || 0}%`;

            // Show modules
            document.getElementById('modulesList').innerHTML = moduleList.map(m =>
                `<span class="module-tag">${m}</span>`
            ).join('');
        }

        function loadBusinessRules() {
            const standardRules = JSON.parse(sessionStorage.getItem('standardBusinessRules') || 'null');
            const container = document.getElementById('businessRulesContent');

            // Load Application Type Banner at top
            loadBusinessRulesAppType();

            // Load compact panels
            loadBusinessRulesPrimaryDomainDetails();
            loadBusinessRulesAppStructure();
            loadBusinessRulesColumnRelationships();

            // Load all required sections
            loadBusinessRulesFileAnalysis();
            loadBusinessRulesAppTagging();
            loadBusinessRulesColumnDetails();
            loadBusinessRulesAccountVerification();
            loadBusinessRulesApplicationStructure();

            if (!standardRules) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align:center; padding:48px; color: var(--text-muted);">
                        <div style="font-size:3rem; margin-bottom:16px;">üìã</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px;">No Business Rules Available</h3>
                        <p style="font-size:0.95rem;">Upload a banking dataset to generate field-level business rules with Definition, Condition, and Action.</p>
                    </div>
                `;
                return;
            }

            const isMulti = !!standardRules.multi_file;

            // Check if we have data: for single-file check columns, for multi-file check files
            if (isMulti) {
                const files = standardRules.files || {};
                const fileNames = Object.keys(files);
                if (fileNames.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align:center; padding:48px; color: var(--text-muted);">
                            <div style="font-size:3rem; margin-bottom:16px;">üìã</div>
                            <h3 style="color: var(--primary); margin-bottom: 8px;">No Business Rules Available</h3>
                            <p style="font-size:0.95rem;">Upload a banking dataset to generate field-level business rules with Definition, Condition, and Action.</p>
                        </div>
                    `;
                    return;
                }
            } else {
                if (!standardRules.columns || standardRules.columns.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="text-align:center; padding:48px; color: var(--text-muted);">
                            <div style="font-size:3rem; margin-bottom:16px;">üìã</div>
                            <h3 style="color: var(--primary); margin-bottom: 8px;">No Business Rules Available</h3>
                            <p style="font-size:0.95rem;">Upload a banking dataset to generate field-level business rules with Definition, Condition, and Action.</p>
                        </div>
                    `;
                    return;
                }
            }

            const statusBadge = (status) => {
                const s = (status || 'UNKNOWN').toUpperCase();
                if (s === 'VALID') return '<span class="badge badge-success">VALID</span>';
                if (s === 'WARNING') return '<span class="badge badge-warning">WARNING</span>';
                if (s === 'INVALID') return '<span class="badge badge-danger">INVALID</span>';
                return '<span class="badge badge-primary">UNKNOWN</span>';
            };

            const escapeHtml = (v) => {
                const s = String(v ?? '');
                return s
                    .replaceAll('&', '&amp;')
                    .replaceAll('<', '&lt;')
                    .replaceAll('>', '&gt;')
                    .replaceAll('"', '&quot;')
                    .replaceAll("'", '&#039;');
            };

            const renderIssues = (issues) => {
                const list = Array.isArray(issues) ? issues.filter(Boolean) : [];
                if (list.length === 0) return '';
                return `
                    <div style="margin-top:10px; font-size:0.85rem; color: var(--danger);">
                        <strong>Issue:</strong>
                        <ul style="margin:6px 0 0 18px; padding:0;">
                            ${list.slice(0, 3).map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                `;
            };

            const renderTwoPoints = (points, fallbackText) => {
                const pts = Array.isArray(points) ? points.filter(Boolean) : [];
                const p = pts.length ? pts.slice(0, 2) : (fallbackText ? [fallbackText] : []);
                if (p.length === 0) return '';
                return `<ul style="margin:6px 0 0 18px; padding:0;">${p.map(x => `<li>${x}</li>`).join('')}</ul>`;
            };

            const renderColumnCard = (col, sourceFileLabel) => {
                const displayName = col.display_name || col.original_column_name || col.column_name;
                const isSensitive = !!col.is_sensitive;
                const status = col.status || 'UNKNOWN';
                const issues = Array.isArray(col.issues) ? col.issues.filter(Boolean) : (Array.isArray(col.issues) ? col.issues : []);
                const isInvalid = status === 'INVALID';
                const isWarning = status === 'WARNING';

                return `
                    <div class="business-rule-card" style="margin-bottom:0; border-left-width:5px; ${isInvalid
                        ? 'border-left-color: var(--danger);'
                        : isWarning
                            ? 'border-left-color: var(--warning);'
                            : 'border-left-color: var(--success);'
                    }">
                        <div class="rule-header" style="justify-content:space-between; align-items:flex-start;">
                            <div>
                                <span class="rule-title">${displayName}</span>
                                <div style="font-size:0.8rem; color: var(--text-muted); margin-top:4px;">
                                    ${sourceFileLabel ? `<span style="margin-right:10px;"><strong>File:</strong> ${sourceFileLabel}</span>` : ''}
                                    <span><strong>Field:</strong> <code style="background:#f3f4f6; padding:2px 6px; border-radius:4px;">${col.original_column_name || col.column_name}</code></span>
                                </div>
                            </div>
                            <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
                                ${statusBadge(status)}
                                ${isSensitive ? '<span class="badge badge-warning" style="font-size:0.75rem;">SENSITIVE (MASKED)</span>' : ''}
                            </div>
                        </div>

                        <div class="rule-content">
                            <p style="margin-bottom:8px;"><strong>Definition:</strong> ${col.definition || '‚Äî'}</p>
                            <p style="margin-bottom:8px;"><strong>Condition:</strong> ${col.condition || '‚Äî'}</p>

                            <div style="margin-top:10px; background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:10px;">
                                <strong style="color:#065f46;">If VALID (used by bank):</strong>
                                ${renderTwoPoints(col.action_valid_points, col.action_valid)}
                            </div>

                            ${(isInvalid || isWarning || issues.length > 0) ? `
                            <div style="margin-top:10px; background:#fef2f2; border:1px solid #fecaca; border-radius:8px; padding:10px;">
                                <strong style="color:#991b1b;">If INVALID (fix this field):</strong>
                                ${col.ui_issue_message ? `<div style="margin-top:6px;"><strong>Message:</strong> ${col.ui_issue_message}</div>` : ''}
                                ${renderTwoPoints(col.action_invalid_points, col.action_invalid)}
                                ${renderIssues(issues)}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            };

            const renderFailedColumnCard = renderColumnCard; // Keep for backward compatibility

            // Decide status and message
            const globalAllValid = isMulti
                ? !!(standardRules.summary && standardRules.summary.all_valid)
                : !!(standardRules.summary && standardRules.summary.all_valid);

            let html = '';
            if (globalAllValid) {
                html = `
                    <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 1.5rem;">‚úî</span>
                            <h3 style="color: #166534; margin: 0; font-size: 1.25rem; font-weight: 700;">All Details Valid</h3>
                        </div>
                        <p style="color: #166534; font-size: 1rem; margin-bottom: 0;">
                            Your banking data has been verified against core business rules. All mandatory fields and formats are correct, and no critical issues were found.
                        </p>
                    </div>
                `;
            } else {
                html = `
                    <div style="background: #fffbeb; border: 1px solid #fde68a; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                            <h3 style="color: #92400e; margin: 0; font-size: 1.25rem; font-weight: 700;">Some Details Need Attention</h3>
                        </div>
                        <p style="color: #92400e; font-size: 1rem; margin-bottom: 0;">
                            We identified some fields that require review or correction based on banking rules. Please address the issues listed below to ensure full processing.
                        </p>
                    </div>
                `;
            }

            // Helper function to render a single column rule card with full details
            const renderColumnRuleCard = (col, fileLabel) => {
                const status = (col.status || 'UNKNOWN').toUpperCase();
                const displayName = col.display_name || col.column_name || 'Column';
                const field = col.original_column_name || col.column_name || '';
                const isSensitive = !!col.is_sensitive;
                const fieldDisplay = isSensitive ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : field;
                
                // Get definition, condition, and actions
                const definition = col.definition || 'No definition available.';
                const condition = col.condition || 'No condition specified.';
                const actionValid = col.action_valid || (Array.isArray(col.action_valid_points) && col.action_valid_points.length > 0 
                    ? col.action_valid_points.join('. ') 
                    : 'Field is valid and ready for banking processes.');
                const actionInvalid = col.ui_issue_message || col.action_invalid || (Array.isArray(col.action_invalid_points) && col.action_invalid_points.length > 0 
                    ? col.action_invalid_points.join('. ') 
                    : 'Fix this field to proceed.');
                const actionValidPoints = Array.isArray(col.action_valid_points) && col.action_valid_points.length > 0 
                    ? col.action_valid_points 
                    : (actionValid ? [actionValid] : []);
                const actionInvalidPoints = Array.isArray(col.action_invalid_points) && col.action_invalid_points.length > 0 
                    ? col.action_invalid_points 
                    : (actionInvalid ? [actionInvalid] : []);
                const issues = Array.isArray(col.issues) ? col.issues.filter(Boolean) : [];

                // Determine border color based on status
                const borderColor = status === 'VALID' ? '#10b981' : (status === 'WARNING' ? '#f59e0b' : '#ef4444');

                return `
                    <div class="column-rule-card ${status.toLowerCase()}" 
                         data-status="${status}" 
                         data-column-name="${escapeHtml(displayName.toLowerCase())}"
                         data-field-name="${escapeHtml(field.toLowerCase())}"
                         style="border-left: 5px solid ${borderColor}; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px;">
                            <div style="flex: 1;">
                                <div class="column-rule-title" style="font-weight: 700; color: var(--text-dark); font-size: 1.1rem; margin-bottom: 8px;">
                                    ${escapeHtml(displayName)}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">
                                    ${fileLabel ? `<span style="margin-right: 12px;"><strong>File:</strong> ${escapeHtml(fileLabel)}</span>` : ''}
                                    <span><strong>Column:</strong> <code style="background:#f3f4f6; padding:2px 8px; border-radius:4px; font-family: monospace; font-size: 0.9rem;">${escapeHtml(fieldDisplay)}</code></span>
                                    ${isSensitive ? ' <span style="color: #f59e0b; margin-left: 8px; font-weight: 600;">üîí SENSITIVE</span>' : ''}
                                </div>
                            </div>
                            <div style="margin-left: 16px;">
                                ${statusBadge(status)}
                            </div>
                        </div>

                        <div style="font-size: 0.95rem; line-height: 1.7; color: var(--text-dark);">
                            <!-- Definition Section -->
                            <div style="margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 3px solid var(--primary);">
                                <div style="font-weight: 700; color: var(--primary); margin-bottom: 6px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    üìñ Definition
                                </div>
                                <div style="color: var(--text-dark);">
                                    ${escapeHtml(definition)}
                                </div>
                            </div>

                            <!-- Condition Section -->
                            <div style="margin-bottom: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 3px solid #6366f1;">
                                <div style="font-weight: 700; color: #6366f1; margin-bottom: 6px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    üîç Condition
                                </div>
                                <div style="color: var(--text-dark);">
                                    ${escapeHtml(condition)}
                                </div>
                            </div>

                            <!-- Action: Valid Case - ALWAYS SHOWN -->
                            <div class="action-block valid" style="margin-bottom: 16px;">
                                <div class="label" style="font-weight: 700; color: #065f46; margin-bottom: 8px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ‚úÖ Action (Valid Case)
                                </div>
                                <div style="color: #064e3b; line-height: 1.7;">
                                    ${actionValidPoints.length > 0 
                                        ? `<ul style="margin: 0; padding-left: 20px; color: #065f46;">${actionValidPoints.map(p => `<li style="margin-bottom: 6px;">${escapeHtml(p)}</li>`).join('')}</ul>`
                                        : `<div>${escapeHtml(actionValid)}</div>`}
                                </div>
                            </div>

                            <!-- Action: Invalid Case - SHOWN FOR ALL STATUSES -->
                            <div class="action-block invalid" style="margin-bottom: 12px;">
                                <div class="label" style="font-weight: 700; color: #991b1b; margin-bottom: 8px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ‚ö†Ô∏è Action (Invalid Case)
                                </div>
                                <div style="color: #7f1d1d; line-height: 1.7;">
                                    ${actionInvalidPoints.length > 0 
                                        ? `<ul style="margin: 0; padding-left: 20px; color: #991b1b;">${actionInvalidPoints.map(p => `<li style="margin-bottom: 6px;">${escapeHtml(p)}</li>`).join('')}</ul>`
                                        : `<div>${escapeHtml(actionInvalid)}</div>`}
                                </div>
                                ${issues.length > 0 ? `
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #fecaca;">
                                    <div style="font-weight: 600; color: #991b1b; margin-bottom: 6px; font-size: 0.85rem;">Issues Detected:</div>
                                    <ul style="margin: 0; padding-left: 20px; color: #7f1d1d;">
                                        ${issues.slice(0, 5).map(i => `<li style="margin-bottom: 4px;">${escapeHtml(i)}</li>`).join('')}
                                    </ul>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            };


            // Collect all columns (from all files if multi-file)
            let allColumns = [];
            if (isMulti) {
                const files = standardRules.files || {};
                const fileNames = Object.keys(files);
                if (fileNames.length === 0) {
                    container.innerHTML = html + `<div class="empty-state"><div class="icon">üìÑ</div><p>No per-file rule data found.</p></div>`;
                    return;
                }
                fileNames.forEach(fname => {
                    const fr = files[fname] || {};
                    const cols = fr.columns || [];
                    cols.forEach(col => {
                        allColumns.push({ ...col, source_file: fname });
                    });
                });
            } else {
                allColumns = standardRules.columns || [];
            }

            if (allColumns.length === 0) {
                container.innerHTML = html + `<div class="empty-state"><div class="icon">üìã</div><p>No business rules data available.</p></div>`;
                return;
            }

            // Calculate summary statistics for all columns
            const validCount = allColumns.filter(c => (c.status || '').toUpperCase() === 'VALID').length;
            const warningCount = allColumns.filter(c => (c.status || '').toUpperCase() === 'WARNING').length;
            const invalidCount = allColumns.filter(c => (c.status || '').toUpperCase() === 'INVALID').length;
            const unknownCount = allColumns.filter(c => {
                const s = (c.status || '').toUpperCase();
                return s !== 'VALID' && s !== 'WARNING' && s !== 'INVALID';
            }).length;

            // Show summary statistics
            html += `
                <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 12px; border: 1px solid var(--border);">
                    ${validCount > 0 ? `<div style="background: #d1fae5; color: #065f46; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;"><strong>‚úÖ ${validCount}</strong> Valid Field${validCount > 1 ? 's' : ''}</div>` : ''}
                    ${warningCount > 0 ? `<div style="background: #fef3c7; color: #92400e; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;"><strong>‚ö†Ô∏è ${warningCount}</strong> Warning${warningCount > 1 ? 's' : ''}</div>` : ''}
                    ${invalidCount > 0 ? `<div style="background: #fee2e2; color: #991b1b; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;"><strong>üö© ${invalidCount}</strong> Critical Issue${invalidCount > 1 ? 's' : ''}</div>` : ''}
                    ${unknownCount > 0 ? `<div style="background: #e5e7eb; color: #4b5563; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600;"><strong>‚ùì ${unknownCount}</strong> Unknown Status</div>` : ''}
                    <div style="background: #e0e7ff; color: #3730a3; padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; margin-left: auto;">
                        <strong>üìä Total:</strong> ${allColumns.length} Field${allColumns.length > 1 ? 's' : ''}
                    </div>
                </div>
            `;

            // Render ALL columns (including valid ones)
            allColumns.forEach(col => {
                html += renderColumnRuleCard(col, col.source_file || null);
            });

            container.innerHTML = html;

            // Store all columns for filtering
            window.allBusinessRuleColumns = allColumns;
            window.allBusinessRuleCards = container.querySelectorAll('.column-rule-card');

            // Add search and filter functionality
            setupBusinessRulesSearchAndFilter();

            // Add "What Happens Next" section
            const nextSteps = document.createElement('div');
            nextSteps.className = 'next-steps-section';
            nextSteps.style.marginTop = '24px';
            nextSteps.style.padding = '24px';
            nextSteps.style.background = '#f9fafb';
            nextSteps.style.border = '1px solid #e5e7eb';
            nextSteps.style.borderRadius = '12px';

            if (globalAllValid) {
                nextSteps.innerHTML = `
                    <h3 style="color: var(--text-dark); font-size: 1.15rem; font-weight: 700; margin-bottom: 12px;">What Happens Next?</h3>
                    <ul style="color: var(--text-muted); font-size: 0.95rem; line-height: 1.8; padding-left: 20px;">
                        <li><strong>Step 1:</strong> The validated dataset will be queued for application-level processing.</li>
                        <li><strong>Step 2:</strong> Sensitive fields will be automatically encrypted and stored securely.</li>
                        <li><strong>Step 3:</strong> You can now proceed to the "Column Relationships" and "Application Structure" tabs to explore your data.</li>
                    </ul>
                `;
            } else {
                nextSteps.innerHTML = `
                    <h3 style="color: var(--text-dark); font-size: 1.15rem; font-weight: 700; margin-bottom: 12px;">What Happens Next?</h3>
                    <ul style="color: var(--text-muted); font-size: 0.95rem; line-height: 1.8; padding-left: 20px;">
                        <li><strong>Step 1:</strong> Identify the fields marked as üö© <strong>INVALID</strong> or ‚ö†Ô∏è <strong>WARNING</strong> in the list above.</li>
                        <li><strong>Step 2:</strong> Download the file, correct the identified values, and re-upload the dataset.</li>
                        <li><strong>Step 3:</strong> If you are unsure about a rule, consult your bank manager or domain administrator for clarification.</li>
                    </ul>
                `;
            }
            container.appendChild(nextSteps);
        }

        // Helper function to load Application Type banner in Business Rules tab
        function loadBusinessRulesAppType() {
            const banner = document.getElementById('businessRulesAppTypeBanner');
            if (!banner) return;

            const appTypePrediction = JSON.parse(sessionStorage.getItem('applicationTypePrediction') || 'null');
            const blueprint = JSON.parse(sessionStorage.getItem('bankingBlueprint') || 'null');
            const appType = JSON.parse(sessionStorage.getItem('bankingApplicationType') || 'null');
            const bankingResult = JSON.parse(sessionStorage.getItem('bankingResult') || 'null');

            let appName = 'Core Banking System';
            let confidence = 0;

            if (appTypePrediction && appTypePrediction.application_type && appTypePrediction.application_type !== 'Unknown') {
                appName = appTypePrediction.application_type;
                confidence = appTypePrediction.confidence || 0;
            } else if (blueprint && blueprint.application) {
                appName = blueprint.application;
                confidence = blueprint.application_confidence || 0;
            } else if (appType && appType.predicted_application) {
                appName = appType.predicted_application;
                confidence = appType.confidence || 0;
            } else if (bankingResult && bankingResult.banking_application_type) {
                const at = bankingResult.banking_application_type;
                appName = at.predicted_application || 'Core Banking System';
                confidence = at.confidence || 0;
            }

            if (appName && confidence > 0) {
                banner.style.display = 'block';
                banner.innerHTML = `
                    <div class="app-type-banner">
                        <div class="app-info">
                            <h2>Detected Banking Application</h2>
                            <div class="app-name">${appName}</div>
                        </div>
                        <div class="confidence-box">
                            <div class="confidence-value">${confidence}%</div>
                            <div class="confidence-label">Confidence</div>
                        </div>
                    </div>
                `;
            }
        }

        // Helper function to load compact Application Structure in Business Rules tab
        function loadBusinessRulesAppStructure() {
            const container = document.getElementById('businessRulesAppStructure');
            if (!container) return;

            try {
                // Try multiple sources
                let appStructure = null;

                // Source 1: Direct sessionStorage
                const appStructureStr = sessionStorage.getItem('applicationStructure');
                if (appStructureStr) {
                    try {
                        appStructure = JSON.parse(appStructureStr);
                    } catch (e) {
                        console.warn('Failed to parse applicationStructure from sessionStorage:', e);
                    }
                }

                // Source 2: Multi-file result
                if (!appStructure || appStructure.error) {
                    const isMultiFile = sessionStorage.getItem('multiFileMode') === 'true';
                    if (isMultiFile) {
                        try {
                            const multiFileResult = sessionStorage.getItem('multiFileResult');
                            if (multiFileResult) {
                                const result = JSON.parse(multiFileResult);
                                appStructure = result.application_structure;
                            }
                        } catch (e) {
                            console.warn('Failed to get application_structure from multiFileResult:', e);
                        }
                    }
                }

                // Source 3: Single-file upload result
                if (!appStructure || appStructure.error) {
                    try {
                        const uploadResult = sessionStorage.getItem('uploadResult');
                        if (uploadResult) {
                            const result = JSON.parse(uploadResult);
                            appStructure = result.application_structure;
                        }
                    } catch (e) {
                        console.warn('Failed to get application_structure from uploadResult:', e);
                    }
                }

                if (!appStructure || appStructure.error) {
                    container.innerHTML = `<div style="padding: 16px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">No structure available${appStructure && appStructure.error ? ': ' + appStructure.error : ''}</div>`;
                    return;
                }

                let html = '';

                // Get application type
                const appType = appStructure.application_type || appStructure.structure_tree?.application_type || 'Banking Application';
                const appTypeInfo = appStructure.application_type;
                const appTypeName = (appTypeInfo && appTypeInfo.application_type) ? appTypeInfo.application_type :
                    (typeof appType === 'string' ? appType : 'Banking Application');
                const appTypeConfidence = (appTypeInfo && appTypeInfo.confidence) ? appTypeInfo.confidence : 0;

                // Build tree diagram
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 4px;">${appTypeName}</div>
                        ${appTypeConfidence > 0 ? `<div style="font-size: 0.75rem; opacity: 0.9;">Confidence: ${appTypeConfidence}%</div>` : ''}
                    </div>
                `;

                // Collect modules from both sources
                let modulesList = [];

                // Source 1: appStructure.modules (dictionary)
                if (appStructure.modules && Object.keys(appStructure.modules).length > 0) {
                    for (const [moduleName, moduleInfo] of Object.entries(appStructure.modules)) {
                        if (moduleInfo && typeof moduleInfo === 'object' && moduleInfo.confidence >= 30) {
                            modulesList.push({
                                name: moduleName,
                                confidence: moduleInfo.confidence || 0,
                                status: moduleInfo.status || 'UNKNOWN',
                                columns: moduleInfo.matched_columns || []
                            });
                        }
                    }
                }

                // Source 2: structure_tree.modules (array) as fallback
                if (modulesList.length === 0 && appStructure.structure_tree && appStructure.structure_tree.modules) {
                    const treeModules = appStructure.structure_tree.modules || [];
                    treeModules.forEach((module) => {
                        if (module && module.name) {
                            modulesList.push({
                                name: module.name,
                                confidence: module.confidence || 0,
                                status: module.status || 'UNKNOWN',
                                columns: module.columns || []
                            });
                        }
                    });
                }

                // Render tree diagram
                if (modulesList.length > 0) {
                    html += '<div style="font-family: \'Courier New\', monospace; font-size: 0.75rem; line-height: 1.6; background: #f8fafc; padding: 12px; border-radius: 6px; border: 1px solid var(--border);">';

                    modulesList.forEach((module, idx) => {
                        const isLast = idx === modulesList.length - 1;
                        const connector = isLast ? '‚îî‚îÄ‚îÄ' : '‚îú‚îÄ‚îÄ';
                        const subConnector = isLast ? '    ' : '‚îÇ   ';

                        const statusColor = module.status === 'COMPLETE' ? '#10b981' :
                            module.status === 'PARTIAL' ? '#f59e0b' : '#ef4444';
                        const statusIcon = module.status === 'COMPLETE' ? '‚úÖ' :
                            module.status === 'PARTIAL' ? '‚ö†Ô∏è' : '‚ùå';

                        html += `
                            <div style="margin-bottom: 8px;">
                                <div style="color: var(--text-dark); font-weight: 600;">
                                    ${connector} <span style="color: ${statusColor}; margin-right: 4px;">${statusIcon}</span>${module.name}
                                    <span style="color: ${statusColor}; margin-left: 8px; font-size: 0.7rem;">${module.confidence}%</span>
                                </div>
                        `;

                        // Show columns (max 5)
                        if (module.columns && Array.isArray(module.columns) && module.columns.length > 0) {
                            const colsToShow = module.columns.slice(0, 5);
                            colsToShow.forEach((col, colIdx) => {
                                const isLastCol = colIdx === colsToShow.length - 1 && module.columns.length <= 5;
                                const colConnector = isLastCol ? '‚îî‚îÄ‚îÄ' : '‚îú‚îÄ‚îÄ';
                                const colName = (typeof col === 'string' && col.includes('.')) ? col.split('.').pop() :
                                    (typeof col === 'object' && col.name) ? col.name : col;
                                html += `
                                    <div style="color: var(--text-muted); margin-left: 20px; font-size: 0.7rem;">
                                        ${subConnector}${colConnector} <code style="background:#e5e7eb; padding:1px 4px; border-radius:3px;">${colName}</code>
                                    </div>
                                `;
                            });

                            if (module.columns.length > 5) {
                                html += `
                                    <div style="color: var(--text-muted); margin-left: 20px; font-size: 0.7rem;">
                                        ${subConnector}‚îî‚îÄ‚îÄ <span style="font-style: italic;">+${module.columns.length - 5} more columns</span>
                                    </div>
                                `;
                            }
                        }

                        html += `</div>`;
                    });

                    html += '</div>';
                } else {
                    html += '<div style="padding: 16px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">No modules detected. Upload files to generate application structure.</div>';
                }

                container.innerHTML = html;
            } catch (e) {
                console.error('Error loading application structure:', e);
                container.innerHTML = `<div style="padding: 16px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">Error loading structure: ${e.message}</div>`;
            }
        }

        // Helper function to load compact Primary Domain Details in Business Rules tab
        function loadBusinessRulesPrimaryDomainDetails() {
            const container = document.getElementById('businessRulesPrimaryDomainDetails');
            if (!container) return;

            try {
                // Try multiple sources
                let columnAnalysis = null;

                // Source 1: Direct sessionStorage
                const columnAnalysisStr = sessionStorage.getItem('columnRelationshipAnalysis');
                if (columnAnalysisStr) {
                    try {
                        columnAnalysis = JSON.parse(columnAnalysisStr);
                    } catch (e) {
                        console.warn('Failed to parse columnRelationshipAnalysis from sessionStorage:', e);
                    }
                }

                // Source 2: Multi-file result
                if (!columnAnalysis || !columnAnalysis.file_domains) {
                    const isMultiFile = sessionStorage.getItem('multiFileMode') === 'true';
                    if (isMultiFile) {
                        try {
                            const multiFileResult = sessionStorage.getItem('multiFileResult');
                            if (multiFileResult) {
                                const result = JSON.parse(multiFileResult);
                                columnAnalysis = result.column_relationship_analysis;
                            }
                        } catch (e) {
                            console.warn('Failed to get column_relationship_analysis from multiFileResult:', e);
                        }
                    }
                }

                // Source 3: Single-file upload result
                if (!columnAnalysis || !columnAnalysis.file_domains) {
                    try {
                        const uploadResult = sessionStorage.getItem('uploadResult');
                        if (uploadResult) {
                            const result = JSON.parse(uploadResult);
                            columnAnalysis = result.column_relationship_analysis;
                        }
                    } catch (e) {
                        console.warn('Failed to get column_relationship_analysis from uploadResult:', e);
                    }
                }

                if (!columnAnalysis || !columnAnalysis.file_domains || !Array.isArray(columnAnalysis.file_domains) || columnAnalysis.file_domains.length === 0) {
                    container.innerHTML = `<div style="padding: 16px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">No primary domain details available. Upload files to analyze domains.</div>`;
                    return;
                }

                let html = '';
                const fileDomains = columnAnalysis.file_domains.slice(0, 3); // Show max 3 in compact view

                fileDomains.forEach((fileInfo, idx) => {
                    const confidenceColor = fileInfo.domain_confidence >= 70 ? 'var(--success)' :
                        fileInfo.domain_confidence >= 40 ? 'var(--warning)' : 'var(--danger)';

                    html += `
                        <div class="compact-relationship-item" style="border-left-color: ${confidenceColor}; margin-bottom: ${idx < fileDomains.length - 1 ? '12px' : '0'};">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                <span style="font-size: 1.2rem;">${fileInfo.domain_icon || 'üè¶'}</span>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 700; color: var(--text-dark); font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${fileInfo.file_name || 'Unknown File'}
                                    </div>
                                </div>
                                <span style="background: ${confidenceColor}; color: white; padding: 2px 8px; border-radius: 8px; font-size: 0.7rem; font-weight: 600;">
                                    ${(fileInfo.domain_confidence || 0).toFixed(0)}%
                                </span>
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-dark); font-weight: 600; margin-bottom: 4px;">
                                ${fileInfo.primary_domain || 'Not Detected'}
                            </div>
                            <div style="font-size: 0.7rem; color: var(--text-muted); line-height: 1.4;">
                                ${(fileInfo.domain_description || 'No description').substring(0, 80)}${(fileInfo.domain_description || '').length > 80 ? '...' : ''}
                            </div>
                            ${fileInfo.total_columns ? `
                                <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 4px;">
                                    ${fileInfo.total_columns} columns ‚Ä¢ ${(fileInfo.total_rows || 0).toLocaleString()} rows
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                if (columnAnalysis.file_domains.length > 3) {
                    html += `<div style="padding: 8px; text-align: center; font-size: 0.75rem; color: var(--text-muted); margin-top: 8px;">+${columnAnalysis.file_domains.length - 3} more domains</div>`;
                }

                container.innerHTML = html;
            } catch (e) {
                console.error('Error loading primary domain details:', e);
                container.innerHTML = `<div style="padding: 16px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">Error loading domain details: ${e.message}</div>`;
            }
        }

        // Helper function to load compact Column Relationships in Business Rules tab
        function loadBusinessRulesColumnRelationships() {
            const container = document.getElementById('businessRulesColumnRelationships');
            if (!container) return;

            try {
                // Try multiple sources
                let columnAnalysis = null;

                // Source 1: Direct sessionStorage
                const columnAnalysisStr = sessionStorage.getItem('columnRelationshipAnalysis');
                if (columnAnalysisStr) {
                    try {
                        columnAnalysis = JSON.parse(columnAnalysisStr);
                    } catch (e) {
                        console.warn('Failed to parse columnRelationshipAnalysis from sessionStorage:', e);
                    }
                }

                // Source 2: Multi-file result
                if (!columnAnalysis || (!columnAnalysis.column_relationships && !columnAnalysis.file_domains)) {
                    const isMultiFile = sessionStorage.getItem('multiFileMode') === 'true';
                    if (isMultiFile) {
                        try {
                            const multiFileResult = sessionStorage.getItem('multiFileResult');
                            if (multiFileResult) {
                                const result = JSON.parse(multiFileResult);
                                columnAnalysis = result.column_relationship_analysis;
                            }
                        } catch (e) {
                            console.warn('Failed to get column_relationship_analysis from multiFileResult:', e);
                        }
                    }
                }

                // Source 3: Single-file upload result
                if (!columnAnalysis || (!columnAnalysis.column_relationships && !columnAnalysis.file_domains)) {
                    try {
                        const uploadResult = sessionStorage.getItem('uploadResult');
                        if (uploadResult) {
                            const result = JSON.parse(uploadResult);
                            columnAnalysis = result.column_relationship_analysis;
                        }
                    } catch (e) {
                        console.warn('Failed to get column_relationship_analysis from uploadResult:', e);
                    }
                }

                if (!columnAnalysis) {
                    container.innerHTML = `<div style="padding: 16px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">No relationship data available. Upload files to analyze relationships.</div>`;
                    return;
                }

                let html = '';

                // Show column relationships if available
                if (columnAnalysis.column_relationships && Array.isArray(columnAnalysis.column_relationships) && columnAnalysis.column_relationships.length > 0) {
                    const relationships = columnAnalysis.column_relationships.slice(0, 5); // Show max 5
                    relationships.forEach((rel, idx) => {
                        if (rel && rel.file1_column && rel.file2_column) {
                            const strengthColor = rel.connection_strength === 'Strong' ? 'var(--success)' :
                                rel.connection_strength === 'Moderate' ? 'var(--warning)' : 'var(--danger)';
                            html += `
                                <div class="compact-relationship-item" style="border-left-color: ${strengthColor};">
                                    <div style="font-weight: 700; color: var(--text-dark); margin-bottom: 4px; font-size: 0.85rem;">
                                        ${rel.file1_column} ‚Üî ${rel.file2_column}
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                                        <span style="color: ${strengthColor}; font-weight: 700;">${rel.connection_strength || 'Unknown'}</span> | 
                                        ${rel.file1 || 'File1'} ‚Üí ${rel.file2 || 'File2'}
                                    </div>
                                </div>
                            `;
                        }
                    });

                    if (columnAnalysis.column_relationships.length > 5) {
                        html += `<div style="padding: 8px; text-align: center; font-size: 0.8rem; color: var(--text-muted);">+${columnAnalysis.column_relationships.length - 5} more relationships</div>`;
                    }
                }

                // Show file domains if no relationships but domains exist
                if (!html && columnAnalysis.file_domains && Array.isArray(columnAnalysis.file_domains) && columnAnalysis.file_domains.length > 0) {
                    columnAnalysis.file_domains.forEach((domain, idx) => {
                        if (domain && domain.file_name) {
                            html += `
                                <div class="compact-relationship-item">
                                    <div style="font-weight: 700; color: var(--text-dark); margin-bottom: 4px; font-size: 0.85rem;">
                                        ${domain.domain_icon || 'üìÑ'} ${domain.file_name}
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                                        ${domain.primary_domain || 'Banking'} | ${domain.total_columns || 0} columns
                                    </div>
                                </div>
                            `;
                        }
                    });
                }

                if (!html) {
                    html = '<div style="padding: 16px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">No relationships detected. Upload multiple files to see column relationships.</div>';
                }

                container.innerHTML = html;
            } catch (e) {
                console.error('Error loading column relationships:', e);
                container.innerHTML = `<div style="padding: 16px; color: var(--text-muted); font-size: 0.85rem; text-align: center;">Error loading relationships: ${e.message}</div>`;
            }
        }

        // Function to load File Analysis in Business Rules tab
        function loadBusinessRulesFileAnalysis() {
            const container = document.getElementById('businessRulesFileAnalysisContent');
            if (!container) return;

            try {
                const isMultiFile = sessionStorage.getItem('multiFileMode') === 'true';
                const tableResults = JSON.parse(sessionStorage.getItem('multiFileTableResults') || '[]');
                const bankingResult = JSON.parse(sessionStorage.getItem('bankingResult') || 'null');

                if (isMultiFile && tableResults.length > 0) {
                    let fileHtml = '';
                    tableResults.forEach((table, idx) => {
                        fileHtml += `
                            <div class="file-card banking">
                                <div class="file-header">
                                    <span class="file-name">üìÑ ${table.table_name || `File ${idx + 1}`}</span>
                                    <span class="badge badge-primary">${(table.columns || []).length} columns</span>
                                </div>
                                <div class="file-reason">
                                    <strong>Columns:</strong> ${(table.columns || []).slice(0, 10).join(', ')}${(table.columns || []).length > 10 ? '...' : ''}<br>
                                    <strong>Rows:</strong> ${(table.total_rows || 0).toLocaleString()}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = fileHtml;
                } else if (bankingResult) {
                    const columns = bankingResult.matched_columns || [];
                    container.innerHTML = `
                        <div class="file-card banking">
                            <div class="file-header">
                                <span class="file-name">üìÑ Uploaded File</span>
                                <span class="badge badge-primary">${bankingResult.total_columns || 0} columns</span>
                            </div>
                            <div class="file-reason">
                                <strong>Matched Columns:</strong> ${columns.slice(0, 10).join(', ') || 'N/A'}<br>
                                <strong>Domain:</strong> ${bankingResult.domain || 'Banking'} | 
                                <strong>Confidence:</strong> ${bankingResult.confidence_percentage || 0}%
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="empty-state"><div class="icon">üìÅ</div><p>No file analysis data available.</p></div>`;
                }
            } catch (e) {
                console.error('Error loading file analysis:', e);
                container.innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error loading file analysis.</p></div>`;
            }
        }

        // Function to load Application Tagging in Business Rules tab
        function loadBusinessRulesAppTagging() {
            const container = document.getElementById('businessRulesAppTaggingContent');
            if (!container) return;

            try {
                const isMultiFile = sessionStorage.getItem('multiFileMode') === 'true';
                const tableResults = JSON.parse(sessionStorage.getItem('multiFileTableResults') || '[]');
                const bankingResult = JSON.parse(sessionStorage.getItem('bankingResult') || 'null');

                if (isMultiFile && tableResults.length > 0) {
                    let appTagHtml = '';
                    tableResults.forEach((table, idx) => {
                        const appTag = detectApplicationTag(table.columns || []);
                        const appReason = getApplicationReason(appTag, table.columns || []);
                        appTagHtml += `
                            <div class="file-card banking">
                                <div class="file-header">
                                    <span class="file-name">üìÑ ${table.table_name || `File ${idx + 1}`}</span>
                                    <span class="file-app-tag">${appTag}</span>
                                </div>
                                <div class="file-reason">
                                    <strong>Reason:</strong> ${appReason}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = appTagHtml;
                } else if (bankingResult) {
                    const columns = bankingResult.matched_columns || [];
                    const appTag = detectApplicationTag(columns);
                    const appReason = getApplicationReason(appTag, columns);
                    container.innerHTML = `
                        <div class="file-card banking">
                            <div class="file-header">
                                <span class="file-name">üìÑ Uploaded File</span>
                                <span class="file-app-tag">${appTag}</span>
                            </div>
                            <div class="file-reason">
                                <strong>Reason:</strong> ${appReason}
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="empty-state"><div class="icon">üè∑Ô∏è</div><p>No application tagging data available.</p></div>`;
                }
            } catch (e) {
                console.error('Error loading application tagging:', e);
                container.innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error loading application tagging.</p></div>`;
            }
        }

        // Function to load Column Details in Business Rules tab
        function loadBusinessRulesColumnDetails() {
            const container = document.getElementById('businessRulesColumnTableBody');
            if (!container) return;

            try {
                const validator = JSON.parse(sessionStorage.getItem('bankingDatasetValidator') || 'null');
                if (validator && validator.columns) {
                    let tableHtml = '';
                    validator.columns.forEach(col => {
                        const status = col.status || 'UNKNOWN';
                        const statusClass = status === 'MATCH' ? 'badge-success' : status === 'WARNING' ? 'badge-warning' : 'badge-danger';
                        tableHtml += `
                            <tr>
                                <td><strong>${col.name}</strong></td>
                                <td>${col.meaning || 'N/A'}</td>
                                <td>${col.category || detectColumnCategory(col.name)}</td>
                                <td><span class="badge ${statusClass}">${status}</span></td>
                            </tr>
                        `;
                    });
                    container.innerHTML = tableHtml;
                } else {
                    container.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 40px;">No column details available.</td></tr>`;
                }
            } catch (e) {
                console.error('Error loading column details:', e);
                container.innerHTML = `<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 40px;">Error loading column details.</td></tr>`;
            }
        }

        // Function to load Account Verification in Business Rules tab
        function loadBusinessRulesAccountVerification() {
            const container = document.getElementById('businessRulesAccountVerificationContent');
            if (!container) return;

            try {
                // Wait a bit for account verification to load, then copy
                setTimeout(() => {
                    const accountVerificationContent = document.getElementById('accountVerificationContent');
                    if (accountVerificationContent && accountVerificationContent.innerHTML.trim() &&
                        accountVerificationContent.innerHTML.indexOf('empty-state') === -1) {
                        container.innerHTML = accountVerificationContent.innerHTML;
                    } else {
                        // Try to load directly using the same logic
                        const standardRules = JSON.parse(sessionStorage.getItem('standardBusinessRules') || 'null');
                        if (!standardRules) {
                            container.innerHTML = `<div class="empty-state"><div class="icon">‚úî</div><p>No account verification data available. Upload files to see verification details.</p></div>`;
                        } else {
                            // Generate verification content inline
                            loadAccountVerificationUI();
                            setTimeout(() => {
                                const content = document.getElementById('accountVerificationContent');
                                if (content && content.innerHTML.trim()) {
                                    container.innerHTML = content.innerHTML;
                                }
                            }, 500);
                        }
                    }
                }, 200);
            } catch (e) {
                console.error('Error loading account verification:', e);
                container.innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error loading account verification.</p></div>`;
            }
        }

        // Function to load Full Application Structure in Business Rules tab
        function loadBusinessRulesApplicationStructure() {
            const container = document.getElementById('businessRulesApplicationStructureContent');
            if (!container) return;

            try {
                // Wait a bit for application structure to load, then copy
                setTimeout(() => {
                    const applicationStructureContent = document.getElementById('applicationStructureContent');
                    if (applicationStructureContent && applicationStructureContent.innerHTML.trim() &&
                        applicationStructureContent.innerHTML.indexOf('Loading') === -1 &&
                        applicationStructureContent.innerHTML.indexOf('empty-state') === -1) {
                        container.innerHTML = applicationStructureContent.innerHTML;
                    } else {
                        // Generate structure content inline
                        loadApplicationStructure();
                        setTimeout(() => {
                            const content = document.getElementById('applicationStructureContent');
                            if (content && content.innerHTML.trim() && content.innerHTML.indexOf('Loading') === -1) {
                                container.innerHTML = content.innerHTML;
                            } else {
                                container.innerHTML = `<div class="empty-state"><div class="icon">üèóÔ∏è</div><p>No application structure data available. Upload files to see structure details.</p></div>`;
                            }
                        }, 500);
                    }
                }, 200);
            } catch (e) {
                console.error('Error loading application structure:', e);
                container.innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div><p>Error loading application structure.</p></div>`;
            }
        }

        /**
         * Banking Domain Validation & User Explanation Engine
         * 
         * NON-NEGOTIABLE RULES:
         * - ALL columns validated internally using observed banking business rules
         * - NO hard-coded column names or business rules
         * - Importance determined dynamically from validation results ONLY
         * - UI shows ONLY Critical and Warning items (SAFE columns hidden)
         * - User-friendly banking language (NO technical terms)
         */
        function loadAccountVerificationUI() {
            const standardRules = JSON.parse(sessionStorage.getItem('standardBusinessRules') || 'null');
            const dynamicRules = JSON.parse(sessionStorage.getItem('dynamicBusinessRules') || 'null');
            const container = document.getElementById('accountVerificationContent');

            if (!standardRules && !dynamicRules) {
                container.innerHTML = `
                    <div class="empty-state" style="text-align:center; padding:48px; color: var(--text-muted);">
                        <div style="font-size:3rem; margin-bottom:16px;">üè¶</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px;">Data Validation</h3>
                        <p style="font-size:0.95rem;">Upload a banking dataset to view validation results.</p>
                    </div>
                `;
                return;
            }

            // Use dynamicRules if available, fallback to standardRules
            const rules = dynamicRules || standardRules;
            const isMulti = !!(rules.multi_file);

            // ============================================================
            // INTERNAL PROCESS: Validate ALL columns silently
            // Apply Definition ‚Üí Condition ‚Üí Action for every column
            // ============================================================
            let allColumns = [];
            
            if (isMulti) {
                const files = rules.files || {};
                Object.keys(files).forEach(fname => {
                    const fr = files[fname] || {};
                    const cols = fr.columns || [];
                    cols.forEach(col => {
                        allColumns.push({ ...col, source_file: fname });
                    });
                });
            } else {
                allColumns = rules.columns || [];
            }

            // ============================================================
            // DYNAMIC IMPORTANCE DETECTION (NO HARD CODING)
            // Classify based on validation results ONLY:
            // - Processing failure risk
            // - Data inconsistency 
            // - Rule violations observed
            // ============================================================
            const classifyImportance = (col) => {
                const status = (col.status || 'UNKNOWN').toUpperCase();
                const issues = col.issues || [];
                const nullPct = col.null_percentage || 0;
                const uniqueRatio = col.unique_ratio || 0;
                
                // CRITICAL: Blocks processing or causes failure
                if (status === 'INVALID') return 'CRITICAL';
                if (nullPct > 50) return 'CRITICAL'; // More than half missing
                if (issues.some(i => /duplicate.*id|missing.*required|invalid.*format/i.test(i))) return 'CRITICAL';
                
                // WARNING: May affect results or reliability
                if (status === 'WARNING') return 'WARNING';
                if (nullPct > 10 && nullPct <= 50) return 'WARNING';
                if (issues.length > 0) return 'WARNING';
                
                // SAFE: No user action required
                return 'SAFE';
            };

            // Classify all columns dynamically
            const classifiedColumns = allColumns.map(col => ({
                ...col,
                importance: classifyImportance(col)
            }));

            // Separate by importance
            const criticalItems = classifiedColumns.filter(c => c.importance === 'CRITICAL');
            const warningItems = classifiedColumns.filter(c => c.importance === 'WARNING');
            const safeItems = classifiedColumns.filter(c => c.importance === 'SAFE');

            const totalColumns = classifiedColumns.length;
            const criticalCount = criticalItems.length;
            const warningCount = warningItems.length;
            const safeCount = safeItems.length;

            // Helper: Escape HTML
            const esc = (v) => {
                const s = String(v ?? '');
                return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
            };

            // Helper: Convert technical text to user-friendly banking language
            const toBankingLanguage = (text) => {
                if (!text) return '';
                return text
                    .replace(/null|NULL/gi, 'missing information')
                    .replace(/duplicate/gi, 'repeated entry')
                    .replace(/unique.*ratio/gi, 'uniqueness level')
                    .replace(/validation/gi, 'verification')
                    .replace(/invalid/gi, 'needs attention')
                    .replace(/pattern/gi, 'format')
                    .replace(/regex|regexp/gi, '')
                    .replace(/SQL|database|column|field/gi, '')
                    .replace(/percentage|%/gi, 'portion')
                    .replace(/integer|float|numeric/gi, 'number')
                    .replace(/string/gi, 'text')
                    .replace(/boolean/gi, 'yes/no value')
                    .trim();
            };

            // Helper: Generate user-friendly impact description
            const getBusinessImpact = (col) => {
                const issues = col.issues || [];
                const nullPct = col.null_percentage || 0;
                const displayName = col.display_name || col.column_name || 'This field';
                
                if (col.importance === 'CRITICAL') {
                    if (nullPct > 50) return `${displayName} has significant missing information that may prevent proper processing of your records.`;
                    if (issues.some(i => /duplicate/i.test(i))) return `${displayName} contains repeated entries that could cause confusion in record identification.`;
                    return `${displayName} requires correction before your data can be processed securely.`;
                }
                
                if (col.importance === 'WARNING') {
                    if (nullPct > 10) return `${displayName} has some missing information that may affect reporting accuracy.`;
                    return `${displayName} may benefit from review to ensure complete data quality.`;
                }
                
                return '';
            };

            // Helper: Generate user-friendly action
            const getUserAction = (col) => {
                const issues = col.issues || [];
                const nullPct = col.null_percentage || 0;
                
                if (col.importance === 'CRITICAL') {
                    if (nullPct > 50) return 'Please provide the missing information for this field.';
                    if (issues.some(i => /duplicate/i.test(i))) return 'Please review and correct any repeated entries.';
                    return 'Please review and update this information.';
                }
                
                if (col.importance === 'WARNING') {
                    if (nullPct > 10) return 'Consider filling in the missing entries if available.';
                    return 'Optional: Review this field for completeness.';
                }
                
                return '';
            };

            // ============================================================
            // UI OUTPUT: Build the banking-grade explanation
            // ============================================================
            let html = '';

            // 1. PURPOSE SECTION (Top ‚Äì 2 lines)
            html += `
                <div style="background: linear-gradient(135deg, #1a56db 0%, #0d47a1 100%); color: white; padding: 24px 28px; border-radius: 12px; margin-bottom: 24px;">
                    <h2 style="font-size: 1.3rem; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.5rem;">üè¶</span> Banking Data Verification Report
                    </h2>
                    <p style="font-size: 1rem; opacity: 0.95; line-height: 1.6; margin: 0;">
                        This data helps the bank verify customer information, process transactions securely, and maintain regulatory compliance.
                        <br>Your information is reviewed to ensure accurate record-keeping and protect your account.
                    </p>
                </div>
            `;

            // 2. DATA USAGE SECTION
            html += `
                <div style="background: #f0f5ff; border: 1px solid #c7d2fe; border-radius: 12px; padding: 20px 24px; margin-bottom: 24px;">
                    <h3 style="color: #3730a3; font-size: 1.1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span>üìã</span> How Your Data Is Used
                    </h3>
                    <ul style="color: #1e1b4b; font-size: 0.95rem; line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li><strong>Account Management:</strong> Keeping your records accurate and up-to-date</li>
                        <li><strong>Transaction Processing:</strong> Ensuring secure and reliable money transfers</li>
                        <li><strong>Compliance & Security:</strong> Meeting banking regulations and protecting your account</li>
                        <li><strong>Customer Service:</strong> Helping us serve you better with accurate information</li>
                    </ul>
                </div>
            `;

            // 3. SUMMARY CARD
            html += `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                    <h3 style="color: #1f2937; font-size: 1.15rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <span>üìä</span> Verification Summary
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                        <div style="text-align: center; padding: 16px; background: #e0e7ff; border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: 800; color: #3730a3;">${totalColumns}</div>
                            <div style="font-size: 0.85rem; color: #4338ca; margin-top: 4px;">Total Fields Checked</div>
                        </div>
                        ${criticalCount > 0 ? `
                        <div style="text-align: center; padding: 16px; background: #fee2e2; border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: 800; color: #dc2626;">üö© ${criticalCount}</div>
                            <div style="font-size: 0.85rem; color: #991b1b; margin-top: 4px;">Critical Issues</div>
                        </div>
                        ` : ''}
                        ${warningCount > 0 ? `
                        <div style="text-align: center; padding: 16px; background: #fef3c7; border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: 800; color: #d97706;">‚ö†Ô∏è ${warningCount}</div>
                            <div style="font-size: 0.85rem; color: #92400e; margin-top: 4px;">Warnings</div>
                        </div>
                        ` : ''}
                        <div style="text-align: center; padding: 16px; background: #d1fae5; border-radius: 10px;">
                            <div style="font-size: 2rem; font-weight: 800; color: #059669;">‚úÖ ${safeCount}</div>
                            <div style="font-size: 0.85rem; color: #065f46; margin-top: 4px;">Verified Successfully</div>
                        </div>
                    </div>
                </div>
            `;

            // 4. CRITICAL ISSUES SECTION (If any)
            if (criticalCount > 0) {
                html += `
                    <div style="background: #fef2f2; border: 2px solid #fecaca; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="color: #991b1b; font-size: 1.15rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.4rem;">üö©</span> Action Required - Critical Issues
                        </h3>
                        <p style="color: #7f1d1d; font-size: 0.95rem; margin-bottom: 20px; line-height: 1.6;">
                            The following items need your attention before processing can continue. Please review and correct them.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            ${criticalItems.map(col => {
                                const displayName = col.display_name || col.column_name || 'Field';
                                const impact = getBusinessImpact(col);
                                const action = getUserAction(col);
                                const sourceFile = col.source_file ? ` (${esc(col.source_file)})` : '';
                                
                                return `
                                    <div style="background: white; border-left: 4px solid #dc2626; border-radius: 8px; padding: 16px 20px;">
                                        <div style="font-weight: 700; color: #1f2937; font-size: 1.05rem; margin-bottom: 8px;">
                                            ${esc(displayName)}${sourceFile}
                                        </div>
                                        <div style="color: #4b5563; font-size: 0.95rem; line-height: 1.6; margin-bottom: 12px;">
                                            ${esc(impact)}
                                        </div>
                                        <div style="background: #fef2f2; padding: 12px; border-radius: 6px;">
                                            <div style="font-weight: 600; color: #991b1b; font-size: 0.9rem; margin-bottom: 4px;">What to do:</div>
                                            <div style="color: #7f1d1d; font-size: 0.9rem;">${esc(action)}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // 5. WARNING SECTION (If any)
            if (warningCount > 0) {
                html += `
                    <div style="background: #fffbeb; border: 2px solid #fde68a; border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="color: #92400e; font-size: 1.15rem; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.4rem;">‚ö†Ô∏è</span> Review Recommended - Warnings
                        </h3>
                        <p style="color: #78350f; font-size: 0.95rem; margin-bottom: 20px; line-height: 1.6;">
                            These items may affect data quality. Review is recommended but not required to continue.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 14px;">
                            ${warningItems.map(col => {
                                const displayName = col.display_name || col.column_name || 'Field';
                                const impact = getBusinessImpact(col);
                                const action = getUserAction(col);
                                const sourceFile = col.source_file ? ` (${esc(col.source_file)})` : '';
                                
                                return `
                                    <div style="background: white; border-left: 4px solid #f59e0b; border-radius: 8px; padding: 14px 18px;">
                                        <div style="font-weight: 700; color: #1f2937; font-size: 1rem; margin-bottom: 6px;">
                                            ${esc(displayName)}${sourceFile}
                                        </div>
                                        <div style="color: #4b5563; font-size: 0.9rem; line-height: 1.5; margin-bottom: 8px;">
                                            ${esc(impact)}
                                        </div>
                                        <div style="color: #92400e; font-size: 0.85rem; font-style: italic;">
                                            ${esc(action)}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            // 6. FINAL CONFIRMATION
            const allValidated = criticalCount === 0;
            html += `
                <div style="background: ${allValidated ? '#ecfdf5' : '#f9fafb'}; border: 1px solid ${allValidated ? '#a7f3d0' : '#e5e7eb'}; border-radius: 12px; padding: 24px; margin-bottom: 16px;">
                    <h3 style="color: ${allValidated ? '#065f46' : '#374151'}; font-size: 1.1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
                        <span style="font-size: 1.3rem;">${allValidated ? '‚úÖ' : 'üìù'}</span> 
                        ${allValidated ? 'Verification Complete' : 'Verification Status'}
                    </h3>
                    <div style="color: ${allValidated ? '#047857' : '#4b5563'}; font-size: 0.95rem; line-height: 1.8;">
                        ${allValidated ? `
                            <p style="margin-bottom: 8px;"><strong>All ${totalColumns} fields have been verified successfully.</strong></p>
                            <p style="margin-bottom: 8px;">Your data meets banking standards and is ready for processing.</p>
                        ` : `
                            <p style="margin-bottom: 8px;"><strong>${safeCount} of ${totalColumns} fields verified successfully.</strong></p>
                            <p style="margin-bottom: 8px;">Please address the critical issues above before proceeding.</p>
                        `}
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid ${allValidated ? '#a7f3d0' : '#e5e7eb'};">
                            <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">Background Validation:</div>
                            <p style="color: #6b7280; margin: 0;">
                                All fields have been validated against banking standards automatically.
                                Only items requiring your attention are shown above.
                                ${safeCount > 0 ? `<strong>${safeCount} additional fields</strong> passed verification and require no action.` : ''}
                            </p>
                        </div>
                    </div>
                </div>
            `;

            // Action buttons
            html += `
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                    ${!allValidated ? `
                        <button type="button" style="padding: 12px 24px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; color: #374151; font-size: 0.95rem; font-weight: 600; cursor: pointer;">
                            Download Report
                        </button>
                    ` : ''}
                    <button type="button" style="padding: 12px 24px; background: ${allValidated ? '#059669' : '#6b7280'}; border: none; border-radius: 8px; color: white; font-size: 0.95rem; font-weight: 600; cursor: ${allValidated ? 'pointer' : 'not-allowed'};" ${!allValidated ? 'disabled' : ''}>
                        ${allValidated ? 'Continue Processing' : 'Fix Issues to Continue'}
                    </button>
                </div>
            `;

            container.innerHTML = `<div style="max-width: 900px; margin: 0 auto;">${html}</div>`;
        }

        function loadApplicationStructure() {
            try {
                // Try to get application structure from sessionStorage
                const appStructureStr = sessionStorage.getItem('applicationStructure');
                let appStructure = null;

                if (appStructureStr) {
                    appStructure = JSON.parse(appStructureStr);
                } else {
                    // Fallback: try to get from result objects
                    const isMultiFile = sessionStorage.getItem('multiFileMode') === 'true';
                    if (isMultiFile) {
                        // For multi-file, structure should be in sessionStorage directly
                        const result = JSON.parse(sessionStorage.getItem('multiFileResult') || '{}');
                        appStructure = result.application_structure;
                    } else {
                        const result = JSON.parse(sessionStorage.getItem('uploadResult') || '{}');
                        appStructure = result.application_structure;
                    }
                }

                const structureContent = document.getElementById('applicationStructureContent');

                if (!appStructure || appStructure.error) {
                    structureContent.innerHTML = `
                        <div class="empty-state" style="text-align: center; padding: 48px; color: var(--text-muted);">
                            <div style="font-size: 3rem; margin-bottom: 16px;">üèóÔ∏è</div>
                            <h3 style="color: var(--primary); margin-bottom: 8px;">Application Structure Not Available</h3>
                            <p style="font-size: 1rem; margin-bottom: 8px;">${appStructure && appStructure.error ? appStructure.error : 'Upload banking data files to generate application structure.'}</p>
                        </div>
                    `;
                    return;
                }

                let html = '';

                // Application Type
                if (appStructure.application_type) {
                    const appType = appStructure.application_type;
                    html += `
                        <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div style="padding: 24px;">
                                <h3 style="margin-bottom: 12px; font-size: 1.5rem;">${appType.application_type || 'Banking Application'}</h3>
                                <p style="opacity: 0.9; margin-bottom: 8px;">${appType.description || 'Banking application structure'}</p>
                                <div style="display: flex; gap: 16px; margin-top: 16px;">
                                    <div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">Confidence</div>
                                        <div style="font-size: 1.5rem; font-weight: 700;">${appType.confidence || 0}%</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.85rem; opacity: 0.8;">Modules Detected</div>
                                        <div style="font-size: 1.5rem; font-weight: 700;">${(appType.detected_modules || []).length}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Structure Tree
                if (appStructure.structure_tree) {
                    const tree = appStructure.structure_tree;
                    html += `
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <h3 class="card-title">üìä Application Structure Tree</h3>
                            </div>
                            <div style="padding: 24px;">
                                <div style="font-family: 'Courier New', monospace; font-size: 1rem; line-height: 2;">
                                    <div style="font-weight: 700; color: var(--primary); margin-bottom: 16px; font-size: 1.2rem;">
                                        ${tree.application_type || 'Banking Application'}
                                    </div>
                    `;

                    // Render modules
                    if (tree.modules && tree.modules.length > 0) {
                        tree.modules.forEach((module, idx) => {
                            const isLast = idx === tree.modules.length - 1;
                            const connector = isLast ? '‚îî‚îÄ‚îÄ' : '‚îú‚îÄ‚îÄ';
                            const subConnector = isLast ? '    ' : '‚îÇ   ';

                            const statusColor = module.status === 'COMPLETE' ? 'var(--success)' :
                                module.status === 'PARTIAL' ? 'var(--warning)' : 'var(--danger)';
                            const statusIcon = module.status === 'COMPLETE' ? '‚úÖ' :
                                module.status === 'PARTIAL' ? '‚ö†Ô∏è' : '‚ùå';

                            html += `
                                <div style="margin-bottom: 12px;">
                                    <div style="color: var(--text-dark); font-weight: 600;">
                                        ${connector} ${module.name} 
                                        <span style="color: ${statusColor}; margin-left: 8px;">
                                            ${statusIcon} ${module.confidence}%
                                        </span>
                                    </div>
                            `;

                            // Render columns
                            if (module.columns && module.columns.length > 0) {
                                module.columns.forEach((col, colIdx) => {
                                    const isLastCol = colIdx === module.columns.length - 1;
                                    const colConnector = isLastCol ? '‚îî‚îÄ‚îÄ' : '‚îú‚îÄ‚îÄ';
                                    html += `
                                        <div style="color: var(--text-muted); margin-left: 20px; margin-top: 4px;">
                                            ${subConnector}${colConnector} ${col.name}
                                            <span style="color: var(--primary); font-size: 0.85rem; margin-left: 8px;">
                                                (${col.feature})
                                            </span>
                                        </div>
                                    `;
                                });
                            }

                            html += `</div>`;
                        });
                    }

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Modules with Details
                if (appStructure.modules) {
                    html += `
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <h3 class="card-title">üì¶ Modules & Confidence Scores</h3>
                            </div>
                            <div style="padding: 24px;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    `;

                    for (const [moduleName, moduleInfo] of Object.entries(appStructure.modules)) {
                        if (moduleInfo.confidence >= 30) {
                            const statusColor = moduleInfo.status === 'COMPLETE' ? 'var(--success)' :
                                moduleInfo.status === 'PARTIAL' ? 'var(--warning)' : 'var(--danger)';

                            html += `
                                <div class="business-rule-card">
                                    <div class="rule-header">
                                        <span class="rule-icon">üì¶</span>
                                        <span class="rule-title">${moduleName}</span>
                                    </div>
                                    <div class="rule-content">
                                        <div style="margin-bottom: 12px;">
                                            <strong>Confidence:</strong> 
                                            <span style="color: ${statusColor}; font-weight: 700;">${moduleInfo.confidence}%</span>
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            <strong>Status:</strong> ${moduleInfo.status}
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            <strong>Required Columns Found:</strong> ${moduleInfo.required_columns_found || 0}
                                        </div>
                                        <div style="margin-bottom: 12px;">
                                            <strong>Optional Columns Found:</strong> ${moduleInfo.optional_columns_found || 0}
                                        </div>
                                        ${moduleInfo.matched_columns && moduleInfo.matched_columns.length > 0 ? `
                                            <div>
                                                <strong>Matched Columns:</strong>
                                                <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;">
                                                    ${moduleInfo.matched_columns.slice(0, 5).map(col => {
                                const colName = col.includes('.') ? col.split('.').pop() : col;
                                return `<span class="rule-tag">${colName}</span>`;
                            }).join('')}
                                                    ${moduleInfo.matched_columns.length > 5 ? `<span class="rule-tag">+${moduleInfo.matched_columns.length - 5} more</span>` : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }
                    }

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Relationships
                if (appStructure.relationships && appStructure.relationships.length > 0) {
                    html += `
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <h3 class="card-title">üîó File Relationships</h3>
                            </div>
                            <div style="padding: 24px;">
                                <div style="display: grid; gap: 16px;">
                    `;

                    appStructure.relationships.forEach(rel => {
                        html += `
                            <div class="business-rule-card">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong>${rel.file1} ‚Üî ${rel.file2}</strong>
                                    <span class="rule-tag ${rel.overlap_ratio > 50 ? 'pass' : ''}">
                                        ${rel.overlap_ratio}% overlap
                                    </span>
                                </div>
                                <div style="color: var(--text-muted);">
                                    <strong>Common Column:</strong> ${rel.common_column}<br>
                                    <strong>Relationship Type:</strong> ${rel.relationship_type}<br>
                                    <strong>Explanation:</strong> ${rel.explanation}
                                </div>
                            </div>
                        `;
                    });

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Business Rules Suggestions
                if (appStructure.business_rules && appStructure.business_rules.length > 0) {
                    html += `
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <h3 class="card-title">üìã Suggested Business Rules</h3>
                            </div>
                            <div style="padding: 24px;">
                                <ul style="margin: 0; padding-left: 20px; list-style: disc;">
                                    ${appStructure.business_rules.map(rule => `<li style="margin-bottom: 8px;">${rule}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                // Corrections Applied
                if (appStructure.corrections_applied && appStructure.corrections_applied.length > 0) {
                    html += `
                        <div class="card" style="margin-bottom: 24px;">
                            <div class="card-header">
                                <h3 class="card-title">üîß Corrections Applied (${appStructure.total_corrections || appStructure.corrections_applied.length})</h3>
                            </div>
                            <div style="padding: 24px;">
                                <div style="background: #f0f5ff; border-left: 4px solid var(--primary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                    <strong style="color: var(--primary);">Balance & Correction Engine</strong>
                                    <p style="margin: 8px 0 0 0; color: var(--text-muted); font-size: 0.9rem;">
                                        The structure has been automatically corrected and balanced to improve accuracy and remove duplicates.
                                    </p>
                                </div>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <ul style="margin: 0; padding-left: 20px; list-style: disc;">
                                        ${appStructure.corrections_applied.map(correction => `
                                            <li style="margin-bottom: 8px; color: var(--text-dark);">
                                                ${correction}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }

                structureContent.innerHTML = html || `
                    <div class="empty-state" style="text-align: center; padding: 48px; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 16px;">üèóÔ∏è</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px;">No Structure Data Available</h3>
                        <p>Application structure data is not available for this analysis.</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading application structure:', error);
                document.getElementById('applicationStructureContent').innerHTML = `
                    <div class="empty-state" style="text-align: center; padding: 48px; color: var(--text-muted);">
                        <div style="font-size: 3rem; margin-bottom: 16px;">‚ö†Ô∏è</div>
                        <h3 style="color: var(--danger); margin-bottom: 8px;">Error Loading Structure</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function generateBusinessRulesSections(columns, validator) {
            const colLower = columns.map(c => c.toLowerCase());
            const sections = {};

            // Customer Details
            if (colLower.some(c => c.includes('customer') || c.includes('name') || c.includes('email') || c.includes('phone'))) {
                sections['Customer Details'] = {
                    icon: 'üë§',
                    rules: [
                        'Customer ID must be unique',
                        'Phone & email must be valid',
                        'Name must match government ID',
                        'Required for KYC compliance'
                    ]
                };
            }

            // Account Details
            if (colLower.some(c => c.includes('account') || c.includes('balance') || c.includes('ifsc'))) {
                sections['Account Details'] = {
                    icon: 'üè¶',
                    rules: [
                        'Account number must be unique',
                        'Balance cannot be below minimum',
                        'Account status must be Active for transactions',
                        'IFSC code required for transfers'
                    ]
                };
            }

            // Transaction Details
            if (colLower.some(c => c.includes('transaction') || c.includes('txn') || c.includes('debit') || c.includes('credit'))) {
                sections['Transaction Details'] = {
                    icon: 'üí∏',
                    rules: [
                        'Transaction ID must be unique',
                        'Amount must be available before transfer',
                        'Large amounts may trigger alerts',
                        'Date must be valid and not in future'
                    ]
                };
            }

            return sections;
        }
        // Business Rules Search and Filter Functionality
        function setupBusinessRulesSearchAndFilter() {
            const searchInput = document.getElementById('businessRulesSearch');
            const filterSelect = document.getElementById('businessRulesFilter');
            const container = document.getElementById('businessRulesContent');

            if (!searchInput || !filterSelect || !container) return;

            function filterAndSearch() {
                const searchTerm = (searchInput.value || '').toLowerCase().trim();
                const filterStatus = filterSelect.value || 'all';
                const cards = container.querySelectorAll('.column-rule-card');

                let visibleCount = 0;

                cards.forEach(card => {
                    // Get column name and status from the card
                    const titleElement = card.querySelector('.column-rule-title') || 
                                        card.querySelector('[style*="font-weight: 700"]') ||
                                        card.firstElementChild;
                    
                    const columnName = titleElement ? (titleElement.textContent || '').toLowerCase() : '';
                    const statusBadge = card.querySelector('.badge-success, .badge-warning, .badge-danger, .badge-primary');
                    // Get status from data attribute (more reliable)
                    const statusBadgeEl = card.querySelector('.badge-success, .badge-warning, .badge-danger, .badge-primary');
                    const badgeStatus = statusBadgeEl ? (statusBadgeEl.textContent || '').toUpperCase().trim() : '';
                    const cardStatus = (card.getAttribute('data-status') || badgeStatus || '').toUpperCase().trim();

                    // Get column name from data attribute
                    const dataColumnName = (card.getAttribute('data-column-name') || '').toLowerCase();
                    const dataFieldName = (card.getAttribute('data-field-name') || '').toLowerCase();

                    // Get all text content for search
                    const allText = card.textContent || '';
                    
                    // Check search term match
                    const matchesSearch = !searchTerm || 
                        dataColumnName.includes(searchTerm) || 
                        dataFieldName.includes(searchTerm) ||
                        columnName.includes(searchTerm) || 
                        allText.toLowerCase().includes(searchTerm);

                    // Check status filter match
                    const matchesFilter = filterStatus === 'all' ||
                        (filterStatus === 'VALID' && cardStatus === 'VALID') ||
                        (filterStatus === 'WARNING' && cardStatus === 'WARNING') ||
                        (filterStatus === 'INVALID' && cardStatus === 'INVALID');

                    if (matchesSearch && matchesFilter) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                // Show "No results" message if needed
                let noResultsMsg = container.querySelector('.no-results-message');
                if (visibleCount === 0 && cards.length > 0) {
                    if (!noResultsMsg) {
                        noResultsMsg = document.createElement('div');
                        noResultsMsg.className = 'no-results-message';
                        noResultsMsg.style.cssText = 'text-align: center; padding: 40px; color: var(--text-muted); background: #f9fafb; border-radius: 12px; margin: 20px 0;';
                        container.appendChild(noResultsMsg);
                    }
                    noResultsMsg.innerHTML = `
                        <div style="font-size: 3rem; margin-bottom: 16px;">üîç</div>
                        <h3 style="color: var(--text-dark); margin-bottom: 8px;">No Matching Business Rules</h3>
                        <p>Try adjusting your search term or filter criteria.</p>
                    `;
                } else if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            }

            // Add event listeners
            searchInput.addEventListener('input', filterAndSearch);
            filterSelect.addEventListener('change', filterAndSearch);
        }

    </script>
</body>

</html>