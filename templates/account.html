~<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Account Number Detection</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            border: none !important;
            outline: none !important;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #2d3748;
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            padding: 30px 20px;
            margin: 0;
            color: #2d3748;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2d3748;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            font-size: 1.1rem;
            color: #4a5568;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header p {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 400;
            letter-spacing: 0.3px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            padding: 30px;
            margin: 20px auto;
            width: 100%;
            max-width: 1200px;
        }
        
        .status-banner {
            padding: 24px;
            border-radius: 12px;
            margin: 0 0 25px 0;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 5px solid #667eea;
        }
        
        .status-banner.success {
            background: #f0fdf4;
            color: #166534;
            border-left-color: #22c55e;
        }
        
        .status-banner.error {
            background: #fef2f2;
            color: #b91c1c;
            border-left-color: #ef4444;
        }
        
        .status-banner.warning {
            background: #fffbeb;
            color: #92400e;
            border-left-color: #f59e0b;
        }
        
        .status-icon {
            font-size: 2.2rem;
            flex-shrink: 0;
        }
        
        .status-content h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 6px;
            color: #1a202c;
        }
        
        .status-content p {
            font-size: 1rem;
            color: #4a5568;
            line-height: 1.6;
        }
        
        .status-content strong {
            font-weight: 600;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .info-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }
        
        .info-card.success-bg {
            background: #f0fdf4;
            border-color: #bbf7d0;
        }
        
        .info-card.warning-bg {
            background: #fffbeb;
            border-color: #fde68a;
        }
        
        .info-card.error-bg {
            background: #fef2f2;
            border-color: #fecaca;
        }
        
        .info-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .info-card-icon {
            font-size: 1.4rem;
        }
        
        .info-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            font-size: 0.95rem;
            border-bottom: 1px solid #edf2f7;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #718096;
            font-weight: 500;
        }
        
        .info-value {
            color: #2d3748;
            font-weight: 600;
            text-align: right;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge.success {
            background: #48bb78;
            color: white;
        }
        
        .badge.error {
            background: #f56565;
            color: white;
        }
        
        .badge.warning {
            background: #ed8936;
            color: white;
        }
        
        .list-clean {
            list-style: none;
            padding: 0;
        }
        
        .list-clean li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .list-clean li::before {
            content: "‚Ä¢";
            color: #667eea;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
            margin: 24px 0;
        }
        
        .risk-assessment {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 24px;
            border-radius: 12px;
            margin: 0 0 24px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .risk-assessment.high {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            color: white;
        }
        
        .risk-assessment.low {
            background: linear-gradient(135deg, #55efc4 0%, #00b894 100%);
            color: white;
        }
        
        .action-box {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-top: 24px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .action-box h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }
        
        .col-card {
            margin-bottom: 24px;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .col-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .business-rules-card {
            margin-bottom: 25px;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #3b82f6;
            background: white;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }
        
        .business-rule-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }
        
        .business-rule-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            border-color: #d1d5db;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 25px;
            overflow-x: auto;
        }
        
        .tab-button {
            padding: 12px 24px;
            background: #f3f4f6;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6b7280;
            margin-right: 4px;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            background: #e5e7eb;
        }
        
        .tab-button.active {
            background: #3b82f6;
            color: white;
            border-bottom: 2px solid #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .validation-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 10px;
            border-left: 4px solid #3b82f6;
        }
        
        .validation-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .validation-section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .validation-section-content {
            padding: 15px 0;
        }

        .col-card h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #2d3748;
            line-height: 1.4;
        }

        .col-card p {
            margin: 10px 0;
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.7;
        }

        .col-card b {
            color: #2d3748;
            font-weight: 600;
        }

        .col-card ul {
            margin: 12px 0;
            padding-left: 24px;
        }

        .col-card li {
            margin: 8px 0;
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.6;
        }

        .col-card code {
            background: rgba(255, 255, 255, 0.8);
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .business-rule-item {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .business-rule-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }

        @media (max-width: 768px) {
            .card {
                padding: 24px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .header {
                padding: 24px 16px;
            }
            
            .status-banner {
                padding: 20px;
                flex-direction: column;
                text-align: center;
            }
            
            .col-card {
                padding: 16px;
            }
            
            .col-card h3 {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .card {
                padding: 16px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .status-banner {
                padding: 16px;
            }
            
            .info-card {
                padding: 16px;
            }
            
            .col-card {
                padding: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Banking Validation Dashboard</h1>
            <p>Detailed analysis of banking dataset validation and business rules compliance</p>
        </div>
        
        <div class="card">
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab(event, 'overview')">Overview</button>
                <button class="tab-button" onclick="switchTab(event, 'business-rules')">Business Rules</button>
                <button class="tab-button" onclick="switchTab(event, 'column-analysis')">Column Analysis</button>
                <button class="tab-button" onclick="switchTab(event, 'validation-details')">Validation Details</button>
            </div>
            
            <div id="overview" class="tab-content" style="display:block;">
                <div id="content-overview">
                    <div id="purposeChart" style="width:100%;height:320px;margin-bottom:24px;display:none;"></div>
                    <div id="content">Loading validation results...</div>
                </div>
            </div>
            
            <div id="business-rules" class="tab-content" style="display:none;">
                <div id="content-business-rules">
                    <p style="text-align: center; padding: 40px 20px; color: #718096;">Business Rules Analysis</p>
                </div>
            </div>
            
            <div id="column-analysis" class="tab-content" style="display:none;">
                <div id="content-column-analysis">
                    <p style="text-align: center; padding: 40px 20px; color: #718096;">Column-Level Analysis</p>
                </div>
            </div>
            
            <div id="validation-details" class="tab-content" style="display:none;">
                <div id="content-validation-details">
                    <p style="text-align: center; padding: 40px 20px; color: #718096;">Detailed Validation Report</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(evt, tabName) {
            // Declare all variables
            var i, tabcontent, tablinks;
            
            // Get all elements with class="tab-content" and hide them
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            
            // Get all elements with class="tab-button" and remove the class "active"
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            
            // Show the current tab, and add an "active" class to the button that opened the tab
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        function renderContent(data, checkData, statusData, missingData, balanceData, kycData, branchCodeData, customerIdData, transactionData, transactionTypeData, panData, debitCreditData, fraudData, foreignKeyData, purposeData, finalDecisionData, riskAssessmentData, columnPurposeReport, probabilityExplanationsData, bankingTransactionRulesData, validatorData) {
            // Use risk assessment and final decision from backend
            const riskLevel = riskAssessmentData?.risk_level || "HIGH";
            const decisionText = finalDecisionData?.decision || "REJECT";
            const reasonText = finalDecisionData?.reason || "Validation failed.";

            // Main status banner
            let statusBannerHtml = "";
            if (checkData) {
                const hasAccount = checkData.has_account_number_column;
                const decision = checkData.best_match_decision;
                const column = checkData.best_match_column;
                const probability = checkData.best_match_probability;
                
                if (hasAccount && decision === "match") {
                    statusBannerHtml = `
                        <div class="status-banner success">
                            <div class="status-icon">‚úÖ</div>
                            <div class="status-content">
                                <h3>Account Number Detected</h3>
                                <p><strong>Column:</strong> ${column || "-"} &nbsp;|&nbsp; <strong>Confidence:</strong> ${probability ?? "-"}%</p>
                            </div>
                        </div>
                    `;
                } else if (hasAccount && decision === "not_match") {
                    statusBannerHtml = `
                        <div class="status-banner error">
                            <div class="status-icon">‚ùå</div>
                            <div class="status-content">
                                <h3>Account Number Invalid</h3>
                                <p><strong>Column:</strong> ${column || "-"} &nbsp;|&nbsp; <strong>Confidence:</strong> ${probability ?? "-"}%</p>
                            </div>
                        </div>
                    `;
                } else {
                    statusBannerHtml = `
                        <div class="status-banner warning">
                            <div class="status-icon">‚ö†Ô∏è</div>
                            <div class="status-content">
                                <h3>No Account Number Column Detected</h3>
                                <p>The uploaded file does not contain a valid account number column.</p>
                            </div>
                        </div>
                    `;
                }
            }

            // Purpose Detection Display
            let purposeHtml = "";
            if (purposeData && purposeData.primary_purpose) {
                purposeHtml = `
                    <div class="col-card" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; margin-bottom:20px; border-left-color:#764ba2;">
                        <h3 style="color:white; margin-bottom:12px;">üéØ Dataset Purpose Detection</h3>
                        <p style="font-size:1.1rem; font-weight:600; margin-bottom:8px;"><b>Primary Purpose:</b> ${purposeData.primary_purpose}</p>
                        <p style="font-size:0.95rem; opacity:0.95; margin-bottom:8px;"><b>Confidence:</b> ${purposeData.purpose_confidence}%</p>
                        <p style="font-size:0.95rem; opacity:0.95; margin-top:12px;"><b>Purpose Statement:</b> ${purposeData.purpose_statement}</p>
                        ${purposeData.detected_purposes && purposeData.detected_purposes.length > 1 ? `
                            <p style="font-size:0.9rem; opacity:0.9; margin-top:12px;"><b>Other Detected Purposes:</b></p>
                            <ul style="margin-top:8px; padding-left:20px;">
                                ${purposeData.detected_purposes.map((p, idx) => 
                                    idx === 0 ? '' : `<li>${p} (${purposeData.confidence_scores[idx]}%)</li>`
                                ).filter(x => x).join("")}
                            </ul>
                        ` : ""}
                    </div>
                `;
            }

            // Column purpose explanations (Account / Customer / Transaction / Withdrawal‚ÄëDeposit‚ÄëTransfer)
            let columnPurposeHtml = "";
            if (columnPurposeReport && columnPurposeReport.explanations) {
                const ex = columnPurposeReport.explanations;
                columnPurposeHtml = `
                    <div class="col-card" style="background:#f7fafc;margin-bottom:20px;border-left:4px solid #667eea;">
                        <h3 style="margin-bottom:10px;">üìö Column Purpose Summary</h3>
                        <p style="font-size:0.95rem;margin-bottom:8px;"><b>Account / Customer Details:</b> ${ex.account_customer || ""}</p>
                        <p style="font-size:0.95rem;margin-bottom:8px;"><b>Transaction Columns:</b> ${ex.transaction || ""}</p>
                        <p style="font-size:0.95rem;margin-bottom:4px;"><b>Withdrawal / Deposit / Transfer:</b> ${ex.wdt || ""}</p>
                    </div>
                `;
            }

            // Account Number Validation Rules
            let accountRulesHtml = "";
            if (data && data.account_like_columns && Array.isArray(data.account_like_columns) && data.account_like_columns.length > 0) {
                data.account_like_columns.forEach((colData, idx) => {
                    const rules = colData.rules || {};
                    const digitsOnly = rules.digits_only_ratio !== undefined ? rules.digits_only_ratio : 0;
                    const lengthOk = rules.length_6_16_ratio !== undefined ? rules.length_6_16_ratio : 0;
                    const unique = rules.unique_ratio !== undefined ? rules.unique_ratio : 0;
                    const notNull = rules.not_null_ratio !== undefined ? rules.not_null_ratio : 0;
                    const noSymbols = rules.no_symbol_ratio !== undefined ? rules.no_symbol_ratio : 0;
                    const randomized = rules.randomized !== undefined ? rules.randomized : false;
                    
                    accountRulesHtml += `
                        <div class="col-card" style="background:#e6f7ff; border-left-color:#1890ff; margin-bottom:16px;">
                            <h3>üîπ STEP-2: Account Number Detection (ML + RULES) - ${colData.column || 'Unknown'}</h3>
                            <p><b>Column:</b> ${colData.column || 'N/A'}</p>
                            <p><b>Decision:</b> ${colData.decision === 'match' ? '‚úÖ MATCH' : '‚ùå NOT MATCH'}</p>
                            <p><b>Probability:</b> ${colData.probability_account_number || 0}%</p>
                            <p><b>Validation Rules:</b></p>
                            <ul class="list-clean" style="margin-top:8px;">
                                <li>‚úî Digits only: ${digitsOnly >= 0.9 ? '‚úÖ' : '‚ùå'} (${(digitsOnly * 100).toFixed(1)}%)</li>
                                <li>‚úî Length: 6‚Äì16: ${lengthOk >= 0.9 ? '‚úÖ' : '‚ùå'} (${(lengthOk * 100).toFixed(1)}%)</li>
                                <li>‚úî Unique: ${unique >= 0.85 ? '‚úÖ' : '‚ùå'} (${(unique * 100).toFixed(1)}%)</li>
                                <li>‚úî NOT NULL: ${notNull >= 0.95 ? '‚úÖ' : '‚ùå'} (${(notNull * 100).toFixed(1)}%)</li>
                                <li>‚úî No symbols: ${noSymbols >= 0.95 ? '‚úÖ' : '‚ùå'} (${(noSymbols * 100).toFixed(1)}%)</li>
                                <li>‚úî Randomized: ${randomized ? '‚úÖ' : '‚ùå'}</li>
                            </ul>
                            ${colData.sample_violations && Array.isArray(colData.sample_violations) && colData.sample_violations.length > 0 ? `
                                <p style="margin-top:12px;"><b>Sample Violations:</b></p>
                                <ul class="list-clean">
                                    ${colData.sample_violations.slice(0, 5).map(v => `<li>${v}</li>`).join("")}
                                </ul>
                            ` : ""}
                        </div>
                    `;
                });
            }

            // Info grid
            let infoGridHtml = '<div class="info-grid">';
            
            // Account Status Card
            if (statusData) {
                if (statusData.has_status_column) {
                    infoGridHtml += `
                        <div class="info-card success-bg">
                            <div class="info-card-header">
                                <span class="info-card-icon">üìä</span>
                                <span class="info-card-title">Account Status</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Status Column</span>
                                <span class="info-value">${statusData.status_column}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Active Accounts</span>
                                <span class="info-value">${statusData.active_count}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Inactive Accounts</span>
                                <span class="info-value">${statusData.inactive_count}</span>
                            </div>
                        </div>
                    `;
                } else {
                    infoGridHtml += `
                        <div class="info-card warning-bg">
                            <div class="info-card-header">
                                <span class="info-card-icon">‚ö†Ô∏è</span>
                                <span class="info-card-title">Account Status Missing</span>
                            </div>
                            <p style="color: #744210; font-size: 0.9rem;">No account status column (Active/Deactive) found in the file.</p>
                        </div>
                    `;
                }
            }
            
            // Mandatory Columns Check (STEP-5)
            if (missingData) {
                const mandatoryMissing = missingData.missing_mandatory || [];
                const optionalMissing = missingData.missing_optional || [];
                const allMandatoryPresent = missingData.all_mandatory_present;
                const cardClass = allMandatoryPresent ? 'success-bg' : 'error-bg';
                const icon = allMandatoryPresent ? '‚úÖ' : '‚ùå';
                infoGridHtml += `
                    <div class="info-card ${cardClass}">
                        <div class="info-card-header">
                            <span class="info-card-icon">${icon}</span>
                            <span class="info-card-title">Mandatory Columns Check</span>
                        </div>
                        ${allMandatoryPresent ? `
                            <p style="color: #155724; font-size: 0.9rem;">‚úÖ All mandatory columns present</p>
                        ` : `
                            <p style="color: #721c24; font-size: 0.9rem;"><b>Missing Mandatory:</b> ${mandatoryMissing.join(", ")}</p>
                        `}
                        ${optionalMissing.length > 0 ? `
                            <p style="color: #856404; font-size: 0.85rem; margin-top:8px;"><b>Missing Optional:</b> ${optionalMissing.join(", ")}</p>
                        ` : ''}
                    </div>
                `;
            }
            
            // Balance Card
            if (balanceData?.has_balance_column) {
                infoGridHtml += `
                    <div class="info-card success-bg">
                        <div class="info-card-header">
                            <span class="info-card-icon">üí∞</span>
                            <span class="info-card-title">Balance Analysis</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Balance Column</span>
                            <span class="info-value">${balanceData.balance_column}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Zero/Negative</span>
                            <span class="info-value">${balanceData.zero_or_negative_count} / ${balanceData.total_rows}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Percentage</span>
                            <span class="info-value">${balanceData.zero_or_negative_pct}%</span>
                        </div>
                    </div>
                `;
            } else {
                infoGridHtml += `
                    <div class="info-card warning-bg">
                        <div class="info-card-header">
                            <span class="info-card-icon">‚ö†Ô∏è</span>
                            <span class="info-card-title">Balance Column Missing</span>
                        </div>
                        <p style="color: #744210; font-size: 0.9rem;">Balance is required to evaluate transaction readiness.</p>
                    </div>
                `;
            }
            
            // KYC Card - REMOVED (KYC rules removed)
            
            // Customer ID Card
            if (customerIdData) {
                const cardClass = customerIdData.decision === 'found' ? 'success-bg' : 'warning-bg';
                const icon = customerIdData.decision === 'found' ? '‚úÖ' : '‚ö†Ô∏è';
                infoGridHtml += `
                    <div class="info-card ${cardClass}">
                        <div class="info-card-header">
                            <span class="info-card-icon">${icon}</span>
                            <span class="info-card-title">STEP-3: Customer ID Validation (7 Rules)</span>
                        </div>
                        ${customerIdData.column_exists ? `
                            <div class="info-item">
                                <span class="info-label">Column</span>
                                <span class="info-value">${customerIdData.column_name}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Confidence</span>
                                <span class="info-value">${customerIdData.probability_customer_id}%</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Rules Passed</span>
                                <span class="info-value">${customerIdData.rules_passed} / ${customerIdData.rules_total}</span>
                            </div>
                        ` : '<p style="font-size: 0.9rem;">Customer ID column not found</p>'}
                    </div>
                `;
            }
            
            infoGridHtml += '</div>';

            // Foreign Key / Linking Check (STEP-4)
            let foreignKeyHtml = "";
            if (foreignKeyData && foreignKeyData.can_check) {
                const fkMismatch = foreignKeyData.fk_mismatch || false;
                const linkingStatus = foreignKeyData.linking_valid ? 'success' : (fkMismatch ? 'error' : 'warning');
                const linkingIcon = foreignKeyData.linking_valid ? '‚úÖ' : (fkMismatch ? '‚ùå' : '‚ö†Ô∏è');
                const bgColor = foreignKeyData.linking_valid ? '#d4edda' : (fkMismatch ? '#f8d7da' : '#fff3cd');
                const borderColor = foreignKeyData.linking_valid ? '#28a745' : (fkMismatch ? '#dc3545' : '#ffc107');
                foreignKeyHtml = `
                    <div class="col-card" style="background:${bgColor}; border-left-color:${borderColor}; margin-bottom:20px;">
                        <h3>üîπ STEP-4: Foreign Key / Linking Check</h3>
                        <p><b>Account Column:</b> ${foreignKeyData.account_column || 'N/A'}</p>
                        <p><b>Customer Column:</b> ${foreignKeyData.customer_column || 'N/A'}</p>
                        <p><b>Relationship Type:</b> ${foreignKeyData.relationship_type || 'UNKNOWN'}</p>
                        <p><b>Total Accounts:</b> ${foreignKeyData.total_accounts}</p>
                        <p><b>Total Customers:</b> ${foreignKeyData.total_customers}</p>
                        ${foreignKeyData.accounts_per_customer ? `<p><b>Accounts per Customer:</b> ${foreignKeyData.accounts_per_customer}</p>` : ''}
                        <p><b>Missing Links:</b> ${foreignKeyData.missing_links_count}</p>
                        <p><b>FK Mismatch:</b> ${fkMismatch ? '‚ùå YES (HIGH RISK)' : '‚úÖ NO'}</p>
                        <p><b>Linking Status:</b> ${linkingIcon} ${foreignKeyData.linking_valid ? 'VALID' : 'INVALID'}</p>
                        ${fkMismatch && foreignKeyData.violations && foreignKeyData.violations.length > 0 ? `
                            <p style="margin-top:8px; color:#721c24;"><b>Violations:</b></p>
                            <ul style="margin-top:4px;">
                                ${foreignKeyData.violations.map(v => `<li style="color:#721c24;">${v}</li>`).join("")}
                            </ul>
                        ` : ''}
                        ${!foreignKeyData.linking_valid && !fkMismatch ? '<p style="margin-top:8px; color:#856404;">‚ö†Ô∏è Some accounts or customers have missing links.</p>' : ''}
                    </div>
                `;
            } else if (foreignKeyData && !foreignKeyData.can_check) {
                foreignKeyHtml = `
                    <div class="col-card" style="background:#f8d7da; border-left-color:#dc3545; margin-bottom:20px;">
                        <h3>üîπ STEP-4: Foreign Key / Linking Check</h3>
                        <p>‚ö†Ô∏è Cannot perform linking check - account number or customer ID columns are missing.</p>
                    </div>
                `;
            }

            // Transaction Type Validation
            let transactionTypeHtml = "";
            if (transactionTypeData) {
                const columnFound = transactionTypeData.column_found || false;
                const columnName = transactionTypeData.column_name || "N/A";
                const probability = transactionTypeData.probability_percentage || 0;
                const overallConfidence = transactionTypeData.overall_confidence || transactionTypeData.confidence_percentage || 0;
                const isValid = transactionTypeData.is_valid || false;
                const decision = transactionTypeData.decision || "unknown";
                const validCount = transactionTypeData.valid_count || 0;
                const invalidCount = transactionTypeData.invalid_count || 0;
                const totalRows = transactionTypeData.total_rows || 0;
                const validTypes = transactionTypeData.valid_types_found || [];
                const invalidTypes = transactionTypeData.invalid_types_found || [];
                
                    // Only show if confidence is above threshold (70%) or if it's a valid match
                if (columnFound && overallConfidence >= 70) {
                    const bgColor = isValid ? '#d4edda' : (probability >= 50 ? '#fff3cd' : '#f8d7da');
                    const borderColor = isValid ? '#28a745' : (probability >= 50 ? '#ffc107' : '#dc3545');
                    const icon = isValid ? '‚úÖ' : (probability >= 50 ? '‚ö†Ô∏è' : '‚ùå');
                    const statusText = isValid ? 'VALID' : (probability >= 50 ? 'PARTIAL' : 'INVALID');
                    
                    transactionTypeHtml = `
                        <div class="col-card" style="background:${bgColor}; border-left-color:${borderColor}; margin-bottom:20px;">
                            <h3>üîπ Transaction Type Validation</h3>
                            <p><b>Column:</b> ${columnName}</p>
                            <p><b>Status:</b> ${icon} ${statusText}</p>
                            <p><b>Probability:</b> <span style="font-size:1.2rem; font-weight:bold; color:${isValid ? '#28a745' : (probability >= 50 ? '#856404' : '#dc3545')};">${probability}%</span></p>
                            <p><b>Total Rows:</b> ${totalRows}</p>
                            <p><b>Valid Values:</b> ${validCount} (${validTypes.length > 0 ? validTypes.join(", ") : "None"})</p>
                            <p><b>Invalid Values:</b> ${invalidCount}</p>
                            ${validTypes.length > 0 ? `
                                <p style="margin-top:8px;"><b>Valid Types Found:</b></p>
                                <ul style="margin-top:4px; padding-left:20px;">
                                    ${validTypes.map(t => `<li style="color:#155724;">‚úÖ ${t}</li>`).join("")}
                                </ul>
                            ` : ''}
                            ${invalidTypes.length > 0 ? `
                                <p style="margin-top:8px; color:#721c24;"><b>Invalid Types Found (sample):</b></p>
                                <ul style="margin-top:4px; padding-left:20px;">
                                    ${invalidTypes.map(t => `<li style="color:#721c24;">‚ùå ${t}</li>`).join("")}
                                </ul>
                            ` : ''}
                            <p style="margin-top:12px; font-size:0.9rem; color:#495057;">
                                <b>Note:</b> Valid transaction types are: <b>Debit</b> or <b>Credit</b> only (case-insensitive).
                            </p>
                        </div>
                    `;
                } else if (columnFound && overallConfidence < 70) {
                    // Show a muted message when confidence is too low
                    transactionTypeHtml = `
                        <div class="col-card" style="background:#f8f9fa; border-left-color:#6c757d; margin-bottom:20px; opacity: 0.7;">
                            <h3>üîπ Transaction Type Validation</h3>
                            <p>‚ö†Ô∏è Low confidence match for column: ${columnName}</p>
                            <p>Overall confidence: ${overallConfidence}% (below 70% threshold)</p>
                            <p>This match was filtered out due to low confidence.</p>
                        </div>
                    `;
                } else {
                    transactionTypeHtml = `
                        <div class="col-card" style="background:#fff3cd; border-left-color:#ffc107; margin-bottom:20px;">
                            <h3>üîπ Transaction Type Validation</h3>
                            <p>‚ö†Ô∏è Transaction type column not found in the dataset.</p>
                            <p style="margin-top:8px; font-size:0.9rem; color:#856404;">
                                Expected column names: transaction_type, txn_type, trans_type, or type
                            </p>
                        </div>
                    `;
                }
            }

            // Branch Code Detection - REMOVED
            let branchCodeHtml = "";

            // PAN Number Validation - Only show if PAN data exists and column is found
            let panHtml = "";
            if (panData && panData.column_found) {
                const columnName = panData.column_name || "N/A";
                const probability = panData.probability_percentage || 0;
                const isValid = panData.is_valid || false;
                const validPanCount = panData.valid_pan_count || 0;
                const invalidPanCount = panData.invalid_pan_count || 0;
                const totalPanFound = panData.total_pan_found || 0;
                const totalRows = panData.total_rows || 0;
                const panList = panData.pan_list || [];
                const invalidPanList = panData.invalid_pan_list || [];
                
                const bgColor = isValid ? '#d4edda' : (probability >= 50 ? '#fff3cd' : '#f8d7da');
                const borderColor = isValid ? '#28a745' : (probability >= 50 ? '#ffc107' : '#dc3545');
                const icon = isValid ? '‚úÖ' : (probability >= 50 ? '‚ö†Ô∏è' : '‚ùå');
                const statusText = isValid ? 'VALID' : (probability >= 50 ? 'PARTIAL' : 'INVALID');
                
                panHtml = `
                    <div class="col-card" style="background:${bgColor}; border-left-color:${borderColor}; margin-bottom:20px;">
                        <h3>üîπ PAN Number Validation</h3>
                        <p><b>Column:</b> ${columnName}</p>
                        <p><b>Status:</b> ${icon} ${statusText}</p>
                        <p><b>Probability:</b> <span style="font-size:1.2rem; font-weight:bold; color:${isValid ? '#28a745' : (probability >= 50 ? '#856404' : '#dc3545')};">${probability}%</span></p>
                        <p><b>Total Rows:</b> ${totalRows}</p>
                        <p><b>Valid PAN Count:</b> <span style="font-size:1.1rem; font-weight:bold; color:#28a745;">${validPanCount}</span></p>
                        <p><b>Invalid PAN Count:</b> <span style="color:#dc3545;">${invalidPanCount}</span></p>
                        <p><b>Total PAN Found:</b> <span style="font-size:1.1rem; font-weight:bold;">${totalPanFound}</span></p>
                        
                        ${panList.length > 0 ? `
                            <div style="margin-top:16px;">
                                <p style="font-weight:600; margin-bottom:8px;"><b>Valid PAN Numbers Found (${panList.length}${panList.length >= 50 ? '+' : ''}):</b></p>
                                <div style="background:#f7fafc; padding:12px; border-radius:4px; max-height:300px; overflow-y:auto;">
                                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:8px; font-family:monospace; font-size:0.9rem;">
                                        ${panList.map(pan => `<div style="padding:4px; background:white; border:1px solid #d4edda; border-radius:3px; text-align:center;">${pan}</div>`).join("")}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${invalidPanList.length > 0 ? `
                            <div style="margin-top:16px;">
                                <p style="font-weight:600; margin-bottom:8px; color:#721c24;"><b>Invalid PAN Numbers (Sample - ${invalidPanList.length}${invalidPanList.length >= 20 ? '+' : ''}):</b></p>
                                <div style="background:#fff5f5; padding:12px; border-radius:4px; max-height:200px; overflow-y:auto;">
                                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:8px; font-family:monospace; font-size:0.9rem;">
                                        ${invalidPanList.map(pan => `<div style="padding:4px; background:white; border:1px solid #f8d7da; border-radius:3px; text-align:center; color:#721c24;">${pan}</div>`).join("")}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="margin-top:16px; padding:12px; background:#e6f7ff; border-left:4px solid #1890ff; border-radius:4px;">
                            <p style="font-weight:600; margin-bottom:8px; color:#0050b3;"><b>PAN Format Specification:</b></p>
                            <ul style="margin:0; padding-left:20px; color:#0050b3; font-size:0.9rem;">
                                <li>Total 10 characters</li>
                                <li>First 5 = letters (A-Z)</li>
                                <li>Next 4 = digits (0-9)</li>
                                <li>Last 1 = letter (A-Z)</li>
                                <li>Pattern: <code style="background:white; padding:2px 6px; border-radius:3px;">[A-Z]{5}[0-9]{4}[A-Z]{1}</code></li>
                                <li>Example: <code style="background:white; padding:2px 6px; border-radius:3px; font-weight:bold;">ABCDE1234F</code> ‚úÖ</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            const riskHtml = ``;

            // Final Decision - REMOVED
            const decisionHtml = ``;

            // Next Action
            const missingMandatory = missingData?.missing_mandatory || [];
            const missingItems = [];
            if (missingMandatory.includes("account_status")) missingItems.push("Account Status");
            if (missingMandatory.includes("balance")) missingItems.push("Balance");
            if (foreignKeyData?.fk_mismatch) missingItems.push("Fix Foreign Key Mismatch");
            
            const nextActionHtml = missingItems.length > 0 ? `
                <div class="action-box">
                    <h4>üìã Next Action Required</h4>
                    <ul class="list-clean">
                        ${missingItems.map(item => `<li>${item}</li>`).join("")}
                    </ul>
                </div>
            ` : decisionText === 'APPROVE' ? `
                <div class="action-box" style="background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
                    <h4>‚úÖ Approved</h4>
                    <p style="font-size: 0.9rem; color: #155724;">All validation checks passed. Dataset is ready for banking operations.</p>
                </div>
            ` : '';

            // Column Purpose Explanations Section (for matched columns with predefined patterns)
            let columnPurposeExplanationsHtml = "";
            let probabilityExplanationsHtml = "";  // Initialize variable
            if (probabilityExplanationsData && Object.keys(probabilityExplanationsData).length > 0) {
                // Create chart container
                const chartContainer = `
                    <div id="probabilityChart" style="width:100%;height:400px;margin-bottom:20px;"></div>
                `;
                // Filter for purpose explanations (columns that match predefined patterns)
                const purposeExplanations = {};
                const generalExplanations = {};
                
                for (const [key, explanationObj] of Object.entries(probabilityExplanationsData)) {
                    if (key.startsWith('purpose_')) {
                        purposeExplanations[key] = explanationObj;
                    } else {
                        generalExplanations[key] = explanationObj;
                    }
                }
                
                // Show purpose explanations (matched column patterns) in a dedicated section
                // Only show if confidence is high enough (threshold of 0.5 or 50%)
                if (Object.keys(purposeExplanations).length > 0) {
                    columnPurposeExplanationsHtml = `
                        <div class="col-card" style="background:white; border-left: 4px solid #007bff; margin-bottom:20px;">
                            <h3>üîç Column Purposes (Predefined Patterns)</h3>
                            <p style="color: #666; margin-top: 10px; margin-bottom: 15px;">The following columns were matched against predefined banking patterns:</p>
                            <div style="margin-top: 15px;">
                    `;
                    
                    for (const [key, explanationObj] of Object.entries(purposeExplanations)) {
                        // Skip if confidence is too low (less than 0.7 or 70%) - only show high confidence matches
                        if (explanationObj.confidence < 0.7) {
                            continue;
                        }
                        
                        const explanation = explanationObj.explanation || "No explanation available";
                        
                        // Extract column name from key (remove 'purpose_' prefix)
                        const columnName = key.replace('purpose_', '');
                        
                        // Extract the column type from the explanation (first word before colon)
                        const columnTypeMatch = explanation.match(/^([^:]+)/);
                        const columnType = columnTypeMatch ? columnTypeMatch[1].trim() : 'unknown';
                        
                        // Split the explanation into parts by commas and create bullet points
                        const explanationParts = explanation.split(',').map(part => part.trim());
                        
                        let explanationList = '';
                        for (const part of explanationParts) {
                            if (part) {
                                explanationList += `<li style="margin-bottom: 5px; font-size: 0.85rem; color: #555; line-height: 1.4;">‚Ä¢ ${part}</li>`;
                            }
                        }
                        
                        columnPurposeExplanationsHtml += `
                            <div style="margin-bottom: 15px; border: 1px solid #eee; border-radius: 6px; padding: 12px; background: white;">
                                <div style="margin-bottom: 8px;">
                                    <strong style="font-size: 1.0rem; color: #333;">Column: ${columnName}</strong>
                                    <div style="font-size: 0.9rem; color: #007bff; margin-top: 4px; font-weight: 500;">${columnType}</div>
                                </div>
                                <ul style="padding-left: 20px; margin: 10px 0 0 0;">${explanationList}</ul>
                            </div>
                        `;
                    }
                    
                    columnPurposeExplanationsHtml += `</div></div>`;
                }
                
                // Combine sections without general explanations
                probabilityExplanationsHtml = columnPurposeExplanationsHtml;
            }
            
            // If no specific purpose explanations, show general section
            if (!probabilityExplanationsHtml && probabilityExplanationsData && Object.keys(probabilityExplanationsData).length > 0) {
                probabilityExplanationsHtml = `
                    <div class="col-card" style="background:white; border-left: 4px solid #6c757d; margin-bottom:20px;">
                        <h3>üìä Data Points</h3>
                        <div style="margin-top: 15px;">
                `;
                
                for (const [key, explanationObj] of Object.entries(probabilityExplanationsData)) {
                    // Skip if confidence is too low (less than 0.7 or 70%) - only show high confidence matches
                    if (explanationObj.confidence < 0.7) {
                        continue;
                    }
                    
                    const explanation = explanationObj.explanation || "No explanation available";
                    
                        // Split the explanation into parts by commas and create bullet points
                        const explanationParts = explanation.split(',').map(part => part.trim());
                        
                        let explanationList = '';
                        for (const part of explanationParts) {
                            if (part) {
                                explanationList += `<li style="margin-bottom: 5px; font-size: 0.85rem; color: #555; line-height: 1.4;">‚Ä¢ ${part}</li>`;
                            }
                        }
                        
                        probabilityExplanationsHtml += `
                            <div style="margin-bottom: 12px; border: 1px solid #eee; border-radius: 4px; padding: 10px; background: #fafafa;">
                                <div style="margin-bottom: 5px;">
                                    <strong style="font-size: 0.95rem; color: #333;">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</strong>
                                </div>
                                <ul style="padding-left: 20px; margin: 10px 0 0 0;">${explanationList}</ul>
                            </div>
                        `;
                }
                
                probabilityExplanationsHtml += `</div></div>`;
            }
            
            // Multi-file information section (if multi-file mode)
            let multiFileHtml = "";
            const isMultiFileMode = sessionStorage.getItem("multiFileMode") === "true";
            if (isMultiFileMode) {
                try {
                    const multiFileRelationships = JSON.parse(sessionStorage.getItem("multiFileRelationships") || "null");
                    const multiFilePrimaryKeys = JSON.parse(sessionStorage.getItem("multiFilePrimaryKeys") || "null");
                    const multiFileForeignKeys = JSON.parse(sessionStorage.getItem("multiFileForeignKeys") || "null");
                    const multiFileDomainDetection = JSON.parse(sessionStorage.getItem("multiFileDomainDetection") || "null");
                    const multiFileTableResults = JSON.parse(sessionStorage.getItem("multiFileTableResults") || "null");
                    
                    if (multiFileRelationships || multiFilePrimaryKeys || multiFileForeignKeys) {
                        multiFileHtml = `
                            <div class="business-rules-card" style="background:linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); border-left:5px solid #2196F3; margin-bottom:24px;">
                                <h3 style="margin:0 0 16px 0; font-size:1.4rem; color:#1976D2; display:flex; align-items:center; gap:10px;">
                                    <span>üîó</span> Multi-File Analysis
                                </h3>
                        `;
                        
                        // Domain Detection
                        if (multiFileDomainDetection && multiFileDomainDetection.overall_domain) {
                            const overallDomain = multiFileDomainDetection.overall_domain;
                            multiFileHtml += `
                                <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; border:1px solid #e2e8f0;">
                                    <h4 style="margin:0 0 12px 0; color:#1976D2; font-size:1.1rem;">üìä Overall Domain Detection</h4>
                                    <p><b>Domain:</b> ${overallDomain.domain || 'Unknown'}</p>
                                    <p><b>Confidence:</b> ${overallDomain.confidence || 0}%</p>
                                    <p><b>Decision:</b> ${overallDomain.decision || 'UNKNOWN'}</p>
                                    <p><b>Tables Analyzed:</b> ${overallDomain.tables_analyzed || 0}</p>
                                </div>
                            `;
                        }
                        
                        // Primary Keys
                        if (multiFilePrimaryKeys) {
                            multiFileHtml += `
                                <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; border:1px solid #e2e8f0;">
                                    <h4 style="margin:0 0 12px 0; color:#1976D2; font-size:1.1rem;">üîë Primary Keys</h4>
                                    <ul style="margin:0; padding-left:20px;">
                                        ${Object.entries(multiFilePrimaryKeys).map(([table, pk]) => 
                                            `<li><b>${table}:</b> ${pk || 'Not detected'}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            `;
                        }
                        
                        // Foreign Keys
                        if (multiFileForeignKeys && multiFileForeignKeys.length > 0) {
                            multiFileHtml += `
                                <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; border:1px solid #e2e8f0;">
                                    <h4 style="margin:0 0 12px 0; color:#1976D2; font-size:1.1rem;">üîó Foreign Keys</h4>
                                    <div style="display:grid; gap:12px;">
                                        ${multiFileForeignKeys.map(fk => `
                                            <div style="padding:12px; background:#f5f5f5; border-radius:6px; border-left:3px solid #2196F3;">
                                                <p style="margin:4px 0;"><b>Parent:</b> ${fk.parent_table}.${fk.parent_column}</p>
                                                <p style="margin:4px 0;"><b>Child:</b> ${fk.child_table}.${fk.child_column}</p>
                                                <p style="margin:4px 0;"><b>Overlap:</b> ${(typeof fk.overlap_ratio === 'number' ? fk.overlap_ratio * 100 : parseFloat(fk.overlap_ratio || 0) * 100).toFixed(1)}%</p>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Enhanced ER Diagram Visualization with Parent-Child Relationships
                        if (multiFileTableResults && multiFileTableResults.length > 0) {
                            // Build table map for ER diagram
                            const tableMap = {};
                            const tableNames = [];
                            multiFileTableResults.forEach(table => {
                                if (table.table_name) {
                                    tableNames.push(table.table_name);
                                    tableMap[table.table_name] = {
                                        columns: table.columns || [],
                                        pk: multiFilePrimaryKeys ? multiFilePrimaryKeys[table.table_name] : null,
                                        banking_validator: table.banking_validator || null,
                                        total_rows: table.total_rows || 0,
                                        isParent: false,
                                        isChild: false,
                                        children: [],
                                        parents: []
                                    };
                                }
                            });
                            
                            // Identify parent and child tables based on relationships
                            if (multiFileRelationships && multiFileRelationships.length > 0) {
                                multiFileRelationships.forEach(rel => {
                                    if (tableMap[rel.parent_table]) {
                                        tableMap[rel.parent_table].isParent = true;
                                        if (!tableMap[rel.parent_table].children.includes(rel.child_table)) {
                                            tableMap[rel.parent_table].children.push(rel.child_table);
                                        }
                                    }
                                    if (tableMap[rel.child_table]) {
                                        tableMap[rel.child_table].isChild = true;
                                        if (!tableMap[rel.child_table].parents.includes(rel.parent_table)) {
                                            tableMap[rel.child_table].parents.push(rel.parent_table);
                                        }
                                    }
                                });
                            }
                            
                            // Sort tables: parents first, then children
                            const sortedTables = [...tableNames].sort((a, b) => {
                                const aIsParent = tableMap[a].isParent;
                                const bIsParent = tableMap[b].isParent;
                                if (aIsParent && !bIsParent) return -1;
                                if (!aIsParent && bIsParent) return 1;
                                return 0;
                            });
                            
                            multiFileHtml += `
                                <div style="background:white; padding:24px; border-radius:8px; margin-bottom:16px; border:1px solid #e2e8f0; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="margin-bottom:20px;">
                                        <h4 style="margin:0 0 8px 0; color:#1976D2; font-size:1.3rem; display:flex; align-items:center; gap:8px; font-weight:600;">
                                            <span>üìä</span> Entity-Relationship (ER) Diagram
                                        </h4>
                                        <div style="padding:12px; background:#e8f5e9; border-radius:6px; border-left:4px solid #4caf50; margin-top:12px;">
                                            <div style="font-weight:600; color:#2e7d32; margin-bottom:6px; font-size:0.95rem;">üí° How to Read This Diagram:</div>
                                            <div style="font-size:0.9rem; color:#388e3c; line-height:1.7;">
                                                <strong>Primary Key (PK) üîë</strong>: Unique identifier for each row in a table (shown in red).<br>
                                                <strong>Foreign Key (FK) üîó</strong>: Column that references the primary key of another table (shown in teal).<br>
                                                <strong>Parent Table</strong>: Contains the primary key that is referenced by other tables.<br>
                                                <strong>Child Table</strong>: Contains foreign keys that reference parent tables.<br>
                                                Tables are organized with parent tables first, showing the data hierarchy and relationships.
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:24px; position:relative;">
                                        ${sortedTables.map((tableName, idx) => {
                                            const tableInfo = tableMap[tableName];
                                            const pk = tableInfo.pk;
                                            const cols = tableInfo.columns || [];
                                            const fks = multiFileForeignKeys ? multiFileForeignKeys.filter(fk => 
                                                fk.parent_table === tableName || fk.child_table === tableName
                                            ) : [];
                                            const isParent = tableInfo.isParent;
                                            const isChild = tableInfo.isChild;
                                            const borderColor = isParent ? '#4caf50' : isChild ? '#2196F3' : '#9e9e9e';
                                            const headerBg = isParent ? '#4caf50' : isChild ? '#2196F3' : '#9e9e9e';
                                            
                                            return `
                                                <div style="background:#f8f9fa; border:3px solid ${borderColor}; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.15); position:relative; transition:transform 0.2s;">
                                                    ${isParent ? `
                                                        <div style="position:absolute; top:-12px; left:16px; background:#4caf50; color:white; padding:4px 12px; border-radius:12px; font-size:0.75rem; font-weight:600; z-index:10;">
                                                            PARENT TABLE
                                                        </div>
                                                    ` : ''}
                                                    ${isChild ? `
                                                        <div style="position:absolute; top:-12px; left:16px; background:#2196F3; color:white; padding:4px 12px; border-radius:12px; font-size:0.75rem; font-weight:600; z-index:10;">
                                                            CHILD TABLE
                                                        </div>
                                                    ` : ''}
                                                    
                                                    <div style="background:${headerBg}; color:white; padding:14px; font-weight:600; border-radius:7px 7px 0 0; font-size:1.1rem;">
                                                        <div style="display:flex; align-items:center; justify-content:space-between;">
                                                            <span>üìã ${tableName}</span>
                                                            ${pk ? `<span style="background:rgba(255,255,255,0.2); padding:4px 10px; border-radius:12px; font-size:0.8rem;">PK: ${pk}</span>` : ''}
                                                        </div>
                                                        <div style="font-size:0.85rem; font-weight:400; margin-top:6px; opacity:0.95;">
                                                            ${tableInfo.total_rows} rows ‚Ä¢ ${cols.length} columns
                                                        </div>
                                                    </div>
                                                    
                                                    <div style="padding:14px; max-height:450px; overflow-y:auto;">
                                                        ${cols.length > 0 ? cols.map(col => {
                                                            const isPK = pk && col === pk;
                                                            const fkInfo = fks.find(fk => 
                                                                (fk.parent_table === tableName && fk.parent_column === col) ||
                                                                (fk.child_table === tableName && fk.child_column === col)
                                                            );
                                                            const isFK = !!fkInfo;
                                                            const colColor = isPK ? '#ff6b6b' : isFK ? '#4ecdc4' : '#95a5a6';
                                                            const colBg = isPK ? '#ffe0e0' : isFK ? '#e0f7f5' : '#f5f5f5';
                                                            const colIcon = isPK ? 'üîë' : isFK ? 'üîó' : '‚Ä¢';
                                                            
                                                            // Show connection info for FK
                                                            let fkConnection = '';
                                                            if (isFK && fkInfo) {
                                                                const connectedTable = fkInfo.parent_table === tableName ? fkInfo.child_table : fkInfo.parent_table;
                                                                fkConnection = `<div style="font-size:0.7rem; color:#4ecdc4; margin-top:2px; font-style:italic;">‚Üí ${connectedTable}</div>`;
                                                            }
                                                            
                                                            return `
                                                                <div style="padding:8px 10px; margin:6px 0; background:${colBg}; border-left:4px solid ${colColor}; border-radius:5px; font-size:0.9rem;">
                                                                    <div style="display:flex; align-items:center; justify-content:space-between;">
                                                                        <div style="display:flex; align-items:center; gap:8px; flex:1;">
                                                                            <span style="font-size:1.1rem;">${colIcon}</span>
                                                                            <span style="font-weight:${isPK || isFK ? '600' : '500'}; color:#2d3748;">${col}</span>
                                                                        </div>
                                                                        <div style="display:flex; gap:4px;">
                                                                            ${isPK ? '<span style="background:#ff6b6b; color:white; padding:3px 8px; border-radius:10px; font-size:0.7rem; font-weight:600;">PK</span>' : ''}
                                                                            ${isFK ? '<span style="background:#4ecdc4; color:white; padding:3px 8px; border-radius:10px; font-size:0.7rem; font-weight:600;">FK</span>' : ''}
                                                                        </div>
                                                                    </div>
                                                                    ${fkConnection}
                                                                </div>
                                                            `;
                                                        }).join('') : '<div style="padding:12px; text-align:center; color:#999; font-size:0.9rem;">No columns available</div>'}
                                                    </div>
                                                    
                                                    ${tableInfo.children.length > 0 ? `
                                                        <div style="padding:10px 14px; background:#e8f5e9; border-top:2px solid #4caf50; border-radius:0 0 7px 7px;">
                                                            <div style="font-size:0.8rem; color:#2e7d32; font-weight:600; margin-bottom:4px;">Connected to:</div>
                                                            <div style="font-size:0.85rem; color:#388e3c;">
                                                                ${tableInfo.children.map(child => `<span style="background:white; padding:3px 8px; border-radius:8px; margin-right:6px; display:inline-block; margin-bottom:4px;">${child}</span>`).join('')}
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    
                                    <div style="margin-top:20px; padding:14px; background:#f0f8ff; border-radius:6px; border:1px solid #2196F3;">
                                        <div style="font-weight:600; color:#1976D2; margin-bottom:10px; font-size:0.95rem;">Legend:</div>
                                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; font-size:0.9rem;">
                                            <div style="display:flex; align-items:center; gap:8px;">
                                                <span style="background:#ff6b6b; color:white; padding:5px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">üîë PK</span>
                                                <span>Primary Key (Unique Identifier)</span>
                                            </div>
                                            <div style="display:flex; align-items:center; gap:8px;">
                                                <span style="background:#4ecdc4; color:white; padding:5px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">üîó FK</span>
                                                <span>Foreign Key (References Parent)</span>
                                            </div>
                                            <div style="display:flex; align-items:center; gap:8px;">
                                                <span style="background:#4caf50; color:white; padding:5px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">PARENT</span>
                                                <span>Parent Table (Has PK)</span>
                                            </div>
                                            <div style="display:flex; align-items:center; gap:8px;">
                                                <span style="background:#2196F3; color:white; padding:5px 10px; border-radius:12px; font-size:0.8rem; font-weight:600;">CHILD</span>
                                                <span>Child Table (Has FK)</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Relationships & Workflow
                        if (multiFileRelationships && multiFileRelationships.length > 0) {
                            multiFileHtml += `
                                <div style="background:white; padding:20px; border-radius:8px; margin-bottom:16px; border:1px solid #e2e8f0;">
                                    <h4 style="margin:0 0 16px 0; color:#1976D2; font-size:1.2rem; display:flex; align-items:center; gap:8px;">
                                        <span>üîÑ</span> Table Relationships & Data Flow
                                    </h4>
                                    <div style="display:grid; gap:16px;">
                                        ${multiFileRelationships.map((rel, idx) => {
                                            const overlapPercent = (typeof rel.overlap_ratio === 'number' ? rel.overlap_ratio * 100 : parseFloat(rel.overlap_ratio || 0) * 100).toFixed(1);
                                            return `
                                                <div style="padding:16px; background:linear-gradient(135deg, #f0f8ff 0%, #e3f2fd 100%); border-radius:8px; border-left:5px solid #2196F3; box-shadow:0 2px 8px rgba(33, 150, 243, 0.15);">
                                                    <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                                                        <span style="background:#2196F3; color:white; padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600;">${rel.relationship_type}</span>
                                                        <span style="background:white; color:#2196F3; padding:4px 10px; border-radius:15px; font-size:0.8rem; font-weight:600;">${overlapPercent}% Overlap</span>
                                                    </div>
                                                    <div style="font-family:monospace; font-size:0.95rem; color:#2d3748; margin:8px 0; padding:8px; background:white; border-radius:4px;">
                                                        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                                            <span style="font-weight:600; color:#1976D2;">${rel.parent_table}</span>
                                                            <span style="color:#666;">.</span>
                                                            <span style="color:#2196F3; font-weight:600;">${rel.parent_column}</span>
                                                            <span style="color:#666; margin:0 8px;">‚Üí</span>
                                                            <span style="font-weight:600; color:#1976D2;">${rel.child_table}</span>
                                                            <span style="color:#666;">.</span>
                                                            <span style="color:#2196F3; font-weight:600;">${rel.child_column}</span>
                                                        </div>
                                                    </div>
                                                    <div style="font-size:0.85rem; color:#666; margin-top:8px; padding-top:8px; border-top:1px solid rgba(33, 150, 243, 0.2);">
                                                        <strong>Description:</strong> ${rel.description || 'No description available'}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    <div style="margin-top:16px; padding:12px; background:#e8f5e9; border-radius:6px; border-left:4px solid #4caf50;">
                                        <div style="font-weight:600; color:#2e7d32; margin-bottom:4px; font-size:0.9rem;">üí° How It Works:</div>
                                        <div style="font-size:0.85rem; color:#388e3c; line-height:1.6;">
                                            The system analyzes all tables to detect connections through primary keys (PK) and foreign keys (FK). 
                                            Relationships are identified by matching column names and value overlaps between tables. 
                                            This creates a data flow map showing how tables are connected in your banking system.
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Individual Table Banking Rules
                        if (multiFileTableResults && multiFileTableResults.length > 0) {
                            multiFileHtml += `
                                <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; border:1px solid #e2e8f0;">
                                    <div style="margin-bottom:20px;">
                                        <h4 style="margin:0 0 8px 0; color:#1976D2; font-size:1.3rem; display:flex; align-items:center; gap:8px; font-weight:600;">
                                            <span>üíº</span> Banking Business Rules by Table
                                        </h4>
                                        <div style="padding:12px; background:#fff3cd; border-radius:6px; border-left:4px solid #ffc107; margin-top:12px;">
                                            <div style="font-weight:600; color:#856404; margin-bottom:6px; font-size:0.95rem;">üí° Banking Rules Explained:</div>
                                            <div style="font-size:0.9rem; color:#856404; line-height:1.7;">
                                                Each table is analyzed independently for banking compliance. The system validates columns against banking standards including:
                                                <strong>Account Numbers</strong> (numeric, unique), <strong>Customer IDs</strong> (unique identifiers), 
                                                <strong>Transactions</strong> (debit/credit validation), <strong>Balances</strong> (numeric, non-negative), 
                                                <strong>PAN</strong> (format validation), and more. Each column receives a status: <strong>MATCH</strong> (passed), 
                                                <strong>WARNING</strong> (minor issues), or <strong>FAIL</strong> (critical issues).
                                            </div>
                                        </div>
                                    </div>
                                    ${multiFileTableResults.map((table, idx) => {
                                        const tableValidator = table.banking_validator;
                                        if (!tableValidator || tableValidator.error) {
                                            return `
                                                <div style="padding:16px; background:#f8f9fa; border-radius:8px; margin-bottom:12px; border-left:4px solid #95a5a6;">
                                                    <h5 style="margin:0 0 8px 0; color:#2d3748; font-size:1.1rem;">${table.table_name}</h5>
                                                    <p style="margin:0; color:#666; font-size:0.9rem;">No banking validation data available</p>
                                                </div>
                                            `;
                                        }
                                        
                                        const columns = tableValidator.columns || [];
                                        const finalDecision = tableValidator.final_decision || 'UNKNOWN';
                                        const confidence = tableValidator.dataset_confidence || 0;
                                        const decisionColor = finalDecision === 'PASS' ? '#28a745' : finalDecision === 'PASS WITH WARNINGS' ? '#ffc107' : '#dc3545';
                                        
                                        return `
                                            <div style="padding:16px; background:#f8f9fa; border-radius:8px; margin-bottom:16px; border-left:4px solid ${decisionColor};">
                                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; flex-wrap:wrap; gap:8px;">
                                                    <h5 style="margin:0; color:#2d3748; font-size:1.1rem; font-weight:600;">üìã ${table.table_name}</h5>
                                                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                                        <span style="background:${decisionColor}; color:white; padding:4px 12px; border-radius:12px; font-size:0.85rem; font-weight:600;">${finalDecision}</span>
                                                        <span style="background:#2196F3; color:white; padding:4px 12px; border-radius:12px; font-size:0.85rem;">${confidence}%</span>
                                                    </div>
                                                </div>
                                                ${columns.length > 0 ? `
                                                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:10px; margin-top:12px;">
                                                        ${columns.map(col => {
                                                            const status = col.status || 'UNKNOWN';
                                                            const colColor = status === 'MATCH' ? '#28a745' : status === 'WARNING' ? '#ffc107' : '#dc3545';
                                                            const colBg = status === 'MATCH' ? '#f0fdf4' : status === 'WARNING' ? '#fffbeb' : '#fef2f2';
                                                            
                                                            return `
                                                                <div style="padding:10px; background:${colBg}; border-left:3px solid ${colColor}; border-radius:4px;">
                                                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
                                                                        <span style="font-weight:600; color:#2d3748; font-size:0.9rem;">${col.name || 'Unknown'}</span>
                                                                        <span style="background:${colColor}; color:white; padding:2px 8px; border-radius:10px; font-size:0.75rem; font-weight:600;">${status}</span>
                                                                    </div>
                                                                    <div style="font-size:0.8rem; color:#666; margin-top:4px;">
                                                                        <div>Meaning: ${col.meaning || 'N/A'}</div>
                                                                        <div>Confidence: ${col.confidence || 0}%</div>
                                                                    </div>
                                                                </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                ` : `
                                                    <p style="margin:8px 0 0 0; color:#666; font-size:0.9rem;">No columns validated</p>
                                                `}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        }
                        
                        multiFileHtml += `</div>`;
                    }
                } catch (e) {
                    console.error("Error parsing multi-file data:", e);
                }
            }
            
            // Banking Dataset Validator Results - Show Only Relevant Business Rules
            let validatorHtml = "";
            if (validatorData && !validatorData.error) {
                const finalDecision = validatorData.final_decision || 'UNKNOWN';
                const datasetConfidence = validatorData.dataset_confidence || 0;
                const decisionColor = finalDecision === 'PASS' ? '#28a745' : finalDecision === 'PASS WITH WARNINGS' ? '#ffc107' : '#dc3545';
                const decisionBg = finalDecision === 'PASS' ? '#d4edda' : finalDecision === 'PASS WITH WARNINGS' ? '#fff3cd' : '#f8d7da';
                            
                // Count different types of issues
                const totalColumns = validatorData.columns ? validatorData.columns.length : 0;
                const matchedColumns = validatorData.columns ? validatorData.columns.filter(col => col.status === 'MATCH').length : 0;
                const warningColumns = validatorData.columns ? validatorData.columns.filter(col => col.status === 'WARNING').length : 0;
                const failedColumns = validatorData.columns ? validatorData.columns.filter(col => col.status === 'FAIL').length : 0;
                            
                validatorHtml = `
                    <div class="business-rules-card" style="background:${decisionBg}; border-left:5px solid ${decisionColor}; margin-bottom:24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
                            <div>
                                <h3 style="margin:0 0 4px 0; font-size:1.4rem; color:${decisionColor}; display:flex; align-items:center; gap:10px;">
                                    <span>üíº</span> Banking Business Rules Validation
                                </h3>
                                <p style="margin:0; color:#555; font-size:0.95rem;">Showing only rules that apply to your data</p>
                            </div>
                            <div style="display:flex; gap:12px; flex-wrap:wrap;">
                                <span class="badge ${finalDecision === 'PASS' ? 'success' : finalDecision === 'PASS WITH WARNINGS' ? 'warning' : 'error'}" 
                                      style="padding:8px 16px; font-size:1rem; font-weight:600;">
                                    ${finalDecision}
                                </span>
                                <span style="background:#1890ff; color:white; padding:8px 16px; border-radius:20px; font-size:1rem; font-weight:600;">
                                    ${datasetConfidence}% Confidence
                                </span>
                            </div>
                        </div>
                                    
                        <div class="info-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin:16px 0;">
                            <div style="background:white; padding:12px; border-radius:8px; text-align:center; border:1px solid #e2e8f0;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#1890ff;">${totalColumns}</div>
                                <div style="font-size:0.8rem; color:#666;">Total Columns</div>
                            </div>
                            <div style="background:white; padding:12px; border-radius:8px; text-align:center; border:1px solid #e2e8f0;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#52c41a;">${matchedColumns}</div>
                                <div style="font-size:0.8rem; color:#666;">Passed</div>
                            </div>
                            <div style="background:white; padding:12px; border-radius:8px; text-align:center; border:1px solid #e2e8f0;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#faad14;">${warningColumns}</div>
                                <div style="font-size:0.8rem; color:#666;">With Warnings</div>
                            </div>
                            <div style="background:white; padding:12px; border-radius:8px; text-align:center; border:1px solid #e2e8f0;">
                                <div style="font-size:1.5rem; font-weight:bold; color:#ff4d4f;">${failedColumns}</div>
                                <div style="font-size:0.8rem; color:#666;">Failed</div>
                            </div>
                        </div>
                                    
                        <div style="background:white; padding:16px; border-radius:8px; margin:16px 0; border:1px solid #e2e8f0;">
                            <p style="margin:0; font-weight:600; color:#333; margin-bottom:8px; display:flex; align-items:center; gap:8px;">
                                <span>üìã</span> Validation Summary
                            </p>
                            <p style="margin:8px 0 0 0; line-height: 1.6; color:#555;">${validatorData.explanation || 'N/A'}</p>
                        </div>
                                    
                        ${validatorData.columns && validatorData.columns.length > 0 ? `
                            <div style="margin:24px 0;">
                                <h4 style="color:#2d3748; margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid #e2e8f0; display:flex; align-items:center; gap:10px;">
                                    <span>üîç</span> Applied Business Rules for Your Data (${validatorData.columns.length} columns analyzed)
                                </h4>
                                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                                    ${validatorData.columns.map(col => {
                                        const colStatusColor = col.status === 'MATCH' ? '#52c41a' : col.status === 'WARNING' ? '#faad14' : '#ff4d4f';
                                        const colBgColor = col.status === 'MATCH' ? '#f6ffed' : col.status === 'WARNING' ? '#fffbe6' : '#fff2f0';
                                        const colBorderColor = col.status === 'MATCH' ? '#b7eb8f' : col.status === 'WARNING' ? '#ffe58f' : '#ffccc7';
                                                    
                                        return `
                                            <div class="business-rule-item" style="background:${colBgColor}; border:1px solid ${colBorderColor}; border-radius:10px; padding:18px; transition: transform 0.2s ease;">
                                                <div style="display:flex; justify-content:space-between; align-items-start; margin-bottom:12px;">
                                                    <div style="flex:1;">
                                                        <h5 style="margin:0 0 4px 0; font-size:1.1rem; color:#2d3748; font-weight:600;">
                                                            <span style="display:inline-block; width:24px; height:24px; line-height:24px; text-align:center; background:${colStatusColor}; color:white; border-radius:50%; font-size:0.8rem; margin-right:8px;">
                                                                ${col.name.substring(0,1).toUpperCase()}
                                                            </span>
                                                            ${col.name}
                                                        </h5>
                                                        <div style="font-size:0.9rem; color:#666; margin-bottom:8px;">${col.meaning || 'N/A'}</div>
                                                    </div>
                                                    <span style="min-width:70px; text-align:center; background:${colStatusColor}; color:white; padding:6px 12px; border-radius:20px; font-size:0.85rem; font-weight:600;">
                                                        ${col.status}
                                                    </span>
                                                </div>
                                                            
                                                <div style="display:flex; justify-content:space-between; margin:10px 0; padding:8px 0; border-top:1px dashed #ddd; border-bottom:1px dashed #ddd;">
                                                    <div style="text-align:center;">
                                                        <div style="font-size:1.2rem; font-weight:bold; color:${colStatusColor};">${col.confidence}%</div>
                                                        <div style="font-size:0.8rem; color:#777;">Confidence</div>
                                                    </div>
                                                    <div style="text-align:center;">
                                                        <div style="font-size:1.2rem; font-weight:bold; color:#1890ff;">${col.rules_passed}/${col.rules_total}</div>
                                                        <div style="font-size:0.8rem; color:#777;">Rules Applied</div>
                                                    </div>
                                                </div>
                                                                                                
                                                <!-- Show the specific business rules that were applied -->
                                                ${col.applied_rules && col.applied_rules.length > 0 ? `
                                                    <div style="margin-top:12px; padding:10px; background:rgba(25, 118, 210, 0.08); border-radius:6px; border-left:3px solid #2196F3;">
                                                        <div style="font-weight:600; color:#1976D2; margin-bottom:6px; font-size:0.9rem; display:flex; align-items:center; gap:6px;">
                                                            <span>üìã</span> Applied Business Rules:
                                                        </div>
                                                        <div style="display:flex; flex-wrap:wrap; gap:6px;">
                                                            ${col.applied_rules.slice(0, 3).map(rule => `
                                                                <span style="background:#e3f2fd; color:#1976D2; padding:4px 8px; border-radius:12px; font-size:0.8rem; font-weight:500;">
                                                                    ${rule}
                                                                </span>
                                                            `).join('')}
                                                            ${col.applied_rules.length > 3 ? `<span style="background:#bbdefb; color:#1565c0; padding:4px 8px; border-radius:12px; font-size:0.8rem;">+${col.applied_rules.length - 3} more</span>` : ''}
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                
                                                <!-- Show the validation reasons -->
                                                ${col.reasons && col.reasons.length > 0 ? `
                                                    <div style="margin-top:10px; padding:10px; background:rgba(25, 118, 210, 0.05); border-radius:6px; border-left:3px solid #42A5F5;">
                                                        <div style="font-weight:600; color:#1E88E5; margin-bottom:6px; font-size:0.9rem; display:flex; align-items:center; gap:6px;">
                                                            <span>üí°</span> Validation Reasons:
                                                        </div>
                                                        <ul style="margin:0; padding-left:18px; font-size:0.85rem; color:#1565C0; line-height: 1.4;">
                                                            ${col.reasons.slice(0, 3).map(reason => `<li style="margin:3px 0; word-break:break-word;">${reason}</li>`).join('')}
                                                        </ul>
                                                    </div>
                                                ` : ''}
                                                                                                
                                                ${col.failures && col.failures.length > 0 ? `
                                                    <div style="margin-top:14px; padding:12px; background:rgba(255, 56, 96, 0.1); border-radius:6px; border-left:4px solid #ff4d4f;">
                                                        <div style="font-weight:600; color:#ff4d4f; margin-bottom:6px; font-size:0.95rem; display:flex; align-items:center; gap:6px;">
                                                            <span>‚ö†Ô∏è</span> Issues Found:
                                                        </div>
                                                        <ul style="margin:0; padding-left:18px; font-size:0.85rem; color:#a61d24; line-height: 1.5;">
                                                            ${col.failures.slice(0, 3).map(f => `<li style="margin:4px 0; word-break:break-word;">${f}</li>`).join('')}
                                                            ${col.failures.length > 3 ? `<li style="margin:4px 0; color:#777; font-style:italic;">+ ${col.failures.length - 3} more issues</li>` : ''}
                                                        </ul>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                                    
                        ${validatorData.relationships && validatorData.relationships.length > 0 ? `
                            <div style="margin:24px 0;">
                                <h4 style="color:#2d3748; margin-bottom:16px; padding-bottom:8px; border-bottom:2px solid #e2e8f0; display:flex; align-items:center; gap:10px;">
                                    <span>üîó</span> Cross-Column Relationship Checks (${validatorData.relationships.length} relationships)
                                </h4>
                                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 14px;">
                                    ${validatorData.relationships.map(rel => {
                                        const relKey = Object.keys(rel)[0];
                                        const relValue = rel[relKey];
                                        const relStatusColor = relValue === 'PASS' ? '#52c41a' : relValue === 'FAIL' ? '#ff4d4f' : '#faad14';
                                        const relBgColor = relValue === 'PASS' ? '#f6ffed' : relValue === 'FAIL' ? '#fff2f0' : '#fffbe6';
                                        const relBorderColor = relValue === 'PASS' ? '#b7eb8f' : relValue === 'FAIL' ? '#ffccc7' : '#ffe58f';
                                        const relIcon = relValue === 'PASS' ? '‚úÖ' : relValue === 'FAIL' ? '‚ùå' : '‚ö†Ô∏è';
                                                    
                                        return `
                                            <div style="background:${relBgColor}; border:1px solid ${relBorderColor}; border-radius:10px; padding:16px;">
                                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                                    <span style="font-weight:600; color:#2d3748; font-size:1rem;">
                                                        ${relKey}
                                                    </span>
                                                    <span style="display:inline-flex; align-items:center; gap:8px; font-weight:600; color:${relStatusColor}; font-size:0.95rem;">
                                                        <span>${relIcon}</span>
                                                        <span>${relValue}</span>
                                                    </span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : ''}
                                    
                        <div style="margin-top:24px; padding:16px; background:#f8f9fa; border-radius:8px; border:1px solid #e9ecef;">
                            <h5 style="margin:0 0 10px 0; color:#495057; display:flex; align-items:center; gap:8px;">
                                <span>üí°</span> Business Rules Applied
                            </h5>
                            <p style="margin:0; color:#6c757d; font-size:0.9rem; line-height: 1.6;">
                                The system automatically detects which business rules apply to your data based on column names and data types.
                                Only relevant rules are applied - no unnecessary checks are performed.
                            </p>
                        </div>
                    </div>
                `;
            }
            
            // For tabbed interface, return multi-file info + validatorHtml
            return multiFileHtml + validatorHtml;
        }

        (function init() {
            const content = document.getElementById("content");
            try {
                const parsedValidation = JSON.parse(sessionStorage.getItem("accountValidation") || "null");
                const parsedCheck = JSON.parse(sessionStorage.getItem("accountNumberCheck") || "null");
                const parsedStatus = JSON.parse(sessionStorage.getItem("accountStatus") || "null");
                const parsedMissing = JSON.parse(sessionStorage.getItem("missingColumns") || "null");
                const parsedBalance = JSON.parse(sessionStorage.getItem("balanceAnalysis") || "null");
                // KYC and Branch Code removed - no longer used
                const parsedKyc = null;
                const parsedBranchCode = null;
                const parsedCustomerId = JSON.parse(sessionStorage.getItem("customerIdValidation") || "null");
                const parsedTransaction = JSON.parse(sessionStorage.getItem("transactionValidation") || "null");
                const parsedTransactionType = JSON.parse(sessionStorage.getItem("transactionTypeValidation") || "null");
                const parsedPan = JSON.parse(sessionStorage.getItem("panValidation") || "null");
                const parsedDebitCredit = JSON.parse(sessionStorage.getItem("debitCreditValidation") || "null");
                const parsedFraud = JSON.parse(sessionStorage.getItem("fraudDetection") || "null");
                const parsedForeignKey = JSON.parse(sessionStorage.getItem("foreignKeyCheck") || "null");
                const parsedPurpose = JSON.parse(sessionStorage.getItem("purposeDetection") || "null");
                const parsedFinalDecision = JSON.parse(sessionStorage.getItem("finalDecision") || "null");
                const parsedRiskAssessment = JSON.parse(sessionStorage.getItem("riskAssessment") || "null");
                const parsedColumnPurpose = JSON.parse(sessionStorage.getItem("columnPurposeReport") || "null");
                const parsedDatasetValidator = JSON.parse(sessionStorage.getItem("bankingDatasetValidator") || "null");
                
                if (!parsedValidation && !parsedCheck) {
                    content.innerHTML = `
                        <div class="status-banner warning">
                            <div class="status-icon">‚ö†Ô∏è</div>
                            <div class="status-content">
                                <h3>No Data Available</h3>
                                <p>Please upload a banking file first to see account validation results.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Debug logging
                console.log("Purpose Detection:", parsedPurpose);
                console.log("Foreign Key Check:", parsedForeignKey);
                console.log("Final Decision:", parsedFinalDecision);
                console.log("Risk Assessment:", parsedRiskAssessment);
                console.log("Column Purpose Report:", parsedColumnPurpose);
                
                const parsedProbabilityExplanations = JSON.parse(sessionStorage.getItem("probabilityExplanations") || "null");
                const parsedBankingTransactionRules = JSON.parse(sessionStorage.getItem("bankingTransactionRules") || "null");
                
                // Pass validator data to renderContent function
                const validatorData = parsedDatasetValidator;
                
                // Populate all tabs with the rendered content
                const overviewContent = document.getElementById("content-overview");
                const businessRulesContent = document.getElementById("content-business-rules");
                const columnAnalysisContent = document.getElementById("content-column-analysis");
                const validationDetailsContent = document.getElementById("content-validation-details");
                
                // Get the rendered content
                const renderedContent = renderContent(parsedValidation, parsedCheck, parsedStatus, parsedMissing, parsedBalance, parsedKyc, parsedBranchCode, parsedCustomerId, parsedTransaction, parsedTransactionType, parsedPan, parsedDebitCredit, parsedFraud, parsedForeignKey, parsedPurpose, parsedFinalDecision, parsedRiskAssessment, parsedColumnPurpose, parsedProbabilityExplanations, parsedBankingTransactionRules, validatorData);
                
                // For now, put the main content in the overview tab
                overviewContent.innerHTML = renderedContent;
                
                // Populate each tab with specific content based on validator data
                
                // Business Rules Tab - Support Multi-Table
                const isMultiFileModeForTabs = sessionStorage.getItem("multiFileMode") === "true";
                const multiFileTableResultsForTabs = isMultiFileModeForTabs ? JSON.parse(sessionStorage.getItem("multiFileTableResults") || "[]") : [];
                
                if (isMultiFileModeForTabs && multiFileTableResultsForTabs.length > 0) {
                    // Multi-table mode: Show business rules for each table
                    let businessRulesHtml = `
                    <div class="section-header">
                        <h2 class="section-title">üíº Business Rules - Multi-Table Analysis</h2>
                    </div>
                    <div class="content-section">
                        <div style="margin-bottom:20px; padding:14px; background:#e8f5e9; border-radius:8px; border-left:4px solid #4caf50;">
                            <div style="font-weight:600; color:#2e7d32; margin-bottom:6px; font-size:0.95rem;">üí° Multi-Table Business Rules:</div>
                            <div style="font-size:0.9rem; color:#388e3c; line-height:1.7;">
                                Banking business rules are applied to each table independently. Each table's columns are validated against banking standards. 
                                Rules check data format, ranges, relationships, and business logic specific to banking operations.
                            </div>
                        </div>
                    `;
                    
                    multiFileTableResultsForTabs.forEach((table, idx) => {
                        const tableValidator = table.banking_validator;
                        if (!tableValidator || tableValidator.error) {
                            businessRulesHtml += `
                                <div style="margin-bottom:20px; padding:20px; background:#f8f9fa; border-radius:8px; border-left:4px solid #95a5a6;">
                                    <h3 style="margin:0 0 12px 0; color:#2d3748; font-size:1.2rem;">üìã ${table.table_name}</h3>
                                    <p style="margin:0; color:#666;">No banking validation data available for this table.</p>
                                </div>
                            `;
                            return;
                        }
                        
                        const columns = tableValidator.columns || [];
                        const finalDecision = tableValidator.final_decision || 'UNKNOWN';
                        const confidence = tableValidator.dataset_confidence || 0;
                        const decisionColor = finalDecision === 'PASS' ? '#28a745' : finalDecision === 'PASS WITH WARNINGS' ? '#ffc107' : '#dc3545';
                        const totalCols = columns.length;
                        const passedCols = columns.filter(c => c.status === 'MATCH').length;
                        const failedCols = columns.filter(c => c.status === 'FAIL').length;
                        const warningCols = columns.filter(c => c.status === 'WARNING').length;
                        
                        businessRulesHtml += `
                            <div style="margin-bottom:24px; padding:20px; background:white; border-radius:8px; border-left:5px solid ${decisionColor}; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; flex-wrap:wrap; gap:12px;">
                                    <h3 style="margin:0; color:#2d3748; font-size:1.3rem; font-weight:600;">üìã ${table.table_name}</h3>
                                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                        <span style="background:${decisionColor}; color:white; padding:6px 14px; border-radius:20px; font-size:0.9rem; font-weight:600;">${finalDecision}</span>
                                        <span style="background:#2196F3; color:white; padding:6px 14px; border-radius:20px; font-size:0.9rem;">${confidence}%</span>
                                    </div>
                                </div>
                                
                                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:20px;">
                                    <div style="padding:12px; background:#f0f8ff; border-radius:6px; text-align:center;">
                                        <div style="font-size:1.5rem; font-weight:bold; color:#2196F3;">${totalCols}</div>
                                        <div style="font-size:0.85rem; color:#666;">Total Columns</div>
                                    </div>
                                    <div style="padding:12px; background:#f0fdf4; border-radius:6px; text-align:center;">
                                        <div style="font-size:1.5rem; font-weight:bold; color:#28a745;">${passedCols}</div>
                                        <div style="font-size:0.85rem; color:#666;">Passed</div>
                                    </div>
                                    <div style="padding:12px; background:#fffbe6; border-radius:6px; text-align:center;">
                                        <div style="font-size:1.5rem; font-weight:bold; color:#ffc107;">${warningCols}</div>
                                        <div style="font-size:0.85rem; color:#666;">Warnings</div>
                                    </div>
                                    <div style="padding:12px; background:#fef2f2; border-radius:6px; text-align:center;">
                                        <div style="font-size:1.5rem; font-weight:bold; color:#dc3545;">${failedCols}</div>
                                        <div style="font-size:0.85rem; color:#666;">Failed</div>
                                    </div>
                                </div>
                                
                                ${columns.length > 0 ? `
                                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:12px;">
                                        ${columns.map(col => {
                                            const status = col.status || 'UNKNOWN';
                                            const colColor = status === 'MATCH' ? '#28a745' : status === 'WARNING' ? '#ffc107' : '#dc3545';
                                            const colBg = status === 'MATCH' ? '#f0fdf4' : status === 'WARNING' ? '#fffbeb' : '#fef2f2';
                                            
                                            return `
                                                <div style="padding:12px; background:${colBg}; border-left:3px solid ${colColor}; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,0.08);">
                                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                                                        <span style="font-weight:600; color:#2d3748; font-size:0.95rem;">${col.name || 'Unknown'}</span>
                                                        <span style="background:${colColor}; color:white; padding:3px 10px; border-radius:12px; font-size:0.75rem; font-weight:600;">${status}</span>
                                                    </div>
                                                    <div style="font-size:0.85rem; color:#666; margin-top:6px; padding-top:6px; border-top:1px solid rgba(0,0,0,0.1);">
                                                        <div style="margin-bottom:4px;"><b>Meaning:</b> ${col.meaning || 'N/A'}</div>
                                                        <div style="margin-bottom:4px;"><b>Confidence:</b> ${col.confidence || 0}%</div>
                                                        ${col.rules_passed !== undefined ? `<div style="margin-bottom:4px;"><b>Rules:</b> ${col.rules_passed}/${col.rules_total || 1} passed</div>` : ''}
                                                    </div>
                                                    ${col.applied_rules && col.applied_rules.length > 0 ? `
                                                        <div style="margin-top:8px; padding:6px; background:rgba(33, 150, 243, 0.1); border-radius:4px; border-left:2px solid #2196F3;">
                                                            <div style="font-weight:600; color:#1976D2; font-size:0.8rem; margin-bottom:3px;">Applied Rules:</div>
                                                            <div style="font-size:0.75rem; color:#1976D2;">${col.applied_rules.slice(0, 2).join(', ')}${col.applied_rules.length > 2 ? '...' : ''}</div>
                                                        </div>
                                                    ` : ''}
                                                    ${col.failures && col.failures.length > 0 ? `
                                                        <div style="margin-top:6px; padding:6px; background:rgba(220, 53, 69, 0.1); border-radius:4px; border-left:2px solid #dc3545;">
                                                            <div style="font-weight:600; color:#dc3545; font-size:0.8rem; margin-bottom:3px;">Issues:</div>
                                                            <div style="font-size:0.75rem; color:#dc3545;">${col.failures.slice(0, 2).join('; ')}${col.failures.length > 2 ? '...' : ''}</div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p style="color:#666;">No columns validated</p>'}
                            </div>
                        `;
                    });
                    
                    businessRulesHtml += `</div>`;
                    businessRulesContent.innerHTML = businessRulesHtml;
                } else if (validatorData && !validatorData.error) {
                    // Single table mode
                    const businessRulesHtml = `
                    <div class="section-header">
                        <h2 class="section-title">üíº Business Rules</h2>
                    </div>
                    <div class="content-section">
                        <div class="status-summary-card">
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <span class="stat-number">${validatorData.columns ? validatorData.columns.length : 0}</span>
                                    <span class="stat-label">Total Columns</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${validatorData.columns ? validatorData.columns.filter(col => col.status === 'MATCH').length : 0}</span>
                                    <span class="stat-label">Passed</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${validatorData.columns ? validatorData.columns.filter(col => col.status === 'FAIL').length : 0}</span>
                                    <span class="stat-label">Failed</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number">${validatorData.dataset_confidence}%</span>
                                    <span class="stat-label">Confidence</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <h3>Applied Business Rules Summary</h3>
                            <p>${validatorData.explanation || 'Business rules applied based on detected column types.'}</p>
                            <div class="rules-grid">
                                ${validatorData.columns ? validatorData.columns.map(col => `
                                <div class="rule-item">
                                    <div class="rule-header">
                                        <span class="rule-name">${col.name || 'Unknown'}</span>
                                        <span class="rule-purpose">(${col.meaning || 'N/A'})</span>
                                        <span class="status-badge ${col.status.toLowerCase()}">${col.status}</span>
                                    </div>
                                    <div class="rule-details">
                                        <div class="rule-applied">
                                            <strong>Rule Applied:</strong> ${col.applied_rules && col.applied_rules.length > 0 ? col.applied_rules[0] : 'General Rule'}
                                        </div>
                                        <div class="confidence">
                                            <strong>Confidence:</strong> ${col.confidence}%
                                        </div>
                                        ${col.failures && col.failures.length > 0 ? `
                                        <div class="failures">
                                            <strong>Issues:</strong>
                                            <ul>
                                                ${col.failures.slice(0, 3).map(issue => `<li>${issue}</li>`).join('')}
                                                ${col.failures.length > 3 ? `<li>...and ${col.failures.length - 3} more</li>` : ''}
                                            </ul>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                `).join('') : 'No column data available'}
                            </div>
                        </div>
                    </div>
                    `;
                    businessRulesContent.innerHTML = businessRulesHtml;
                } else {
                    businessRulesContent.innerHTML = `<div class="section-header"><h2 class="section-title">üíº Business Rules</h2></div><p>No business rules data available.</p>`;
                }
                
                // Column Analysis Tab
                if (validatorData && !validatorData.error) {
                    const columnAnalysisHtml = `
                    <div class="section-header">
                        <h2 class="section-title">üîç Column Analysis</h2>
                    </div>
                    <div class="content-section">
                        <div class="section-card">
                            <h3>Detailed Column Analysis</h3>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Column Name</th>
                                            <th>Meaning</th>
                                            <th>Status</th>
                                            <th>Confidence</th>
                                            <th>Rules Applied</th>
                                            <th>Issues</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${validatorData.columns ? validatorData.columns.map(col => `
                                        <tr>
                                            <td>${col.name || 'Unknown'}</td>
                                            <td>${col.meaning || 'N/A'}</td>
                                            <td><span class="status-badge ${col.status.toLowerCase()}">${col.status}</span></td>
                                            <td>${col.confidence}%</td>
                                            <td>${col.applied_rules && col.applied_rules.length > 0 ? col.applied_rules[0] : 'General Rule'}</td>
                                            <td>${col.failures && col.failures.length > 0 ? col.failures.slice(0, 2).join('<br>') : 'None'}</td>
                                        </tr>
                                        `).join('') : '<tr><td colspan="6">No column data available</td></tr>'}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    `;
                    columnAnalysisContent.innerHTML = columnAnalysisHtml;
                } else {
                    columnAnalysisContent.innerHTML = `<div class="section-header"><h2 class="section-title">üîç Column Analysis</h2></div><p>No column analysis data available.</p>`;
                }
                
                // Validation Details Tab - Support Multi-Table
                if (isMultiFileModeForTabs && multiFileTableResultsForTabs.length > 0) {
                    let validationDetailsHtml = `
                    <div class="section-header">
                        <h2 class="section-title">üìã Validation Details - Multi-Table</h2>
                    </div>
                    <div class="content-section">
                        <div style="margin-bottom:20px; padding:14px; background:#fff3cd; border-radius:8px; border-left:4px solid #ffc107;">
                            <div style="font-weight:600; color:#856404; margin-bottom:6px; font-size:0.95rem;">üí° Validation Details Explained:</div>
                            <div style="font-size:0.9rem; color:#856404; line-height:1.7;">
                                Each table is validated independently. The validation process checks data quality, business rule compliance, and identifies issues. 
                                Review the details for each table to understand validation results and recommendations.
                            </div>
                        </div>
                    `;
                    
                    multiFileTableResultsForTabs.forEach((table, idx) => {
                        const tableValidator = table.banking_validator;
                        if (!tableValidator || tableValidator.error) {
                            validationDetailsHtml += `
                                <div style="margin-bottom:20px; padding:20px; background:#f8f9fa; border-radius:8px; border-left:4px solid #95a5a6;">
                                    <h3 style="margin:0 0 12px 0; color:#2d3748; font-size:1.2rem;">üìã ${table.table_name}</h3>
                                    <p style="margin:0; color:#666;">No validation data available for this table.</p>
                                </div>
                            `;
                            return;
                        }
                        
                        const finalDecision = tableValidator.final_decision || 'UNKNOWN';
                        const confidence = tableValidator.dataset_confidence || 0;
                        const decisionColor = finalDecision === 'PASS' ? '#28a745' : finalDecision === 'PASS WITH WARNINGS' ? '#ffc107' : '#dc3545';
                        const decisionBg = finalDecision === 'PASS' ? '#d4edda' : finalDecision === 'PASS WITH WARNINGS' ? '#fff3cd' : '#f8d7da';
                        const columns = tableValidator.columns || [];
                        
                        validationDetailsHtml += `
                            <div style="margin-bottom:24px; padding:20px; background:white; border-radius:8px; border:1px solid #e2e8f0; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                                <h3 style="margin:0 0 16px 0; color:#2d3748; font-size:1.3rem; font-weight:600; padding-bottom:12px; border-bottom:2px solid #e2e8f0;">üìã ${table.table_name}</h3>
                                
                                <div style="padding:16px; background:${decisionBg}; border-radius:8px; border-left:4px solid ${decisionColor}; margin-bottom:16px;">
                                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                                        <div>
                                            <div style="font-size:0.85rem; color:#666; margin-bottom:4px;">Final Decision</div>
                                            <div style="font-size:1.1rem; font-weight:600; color:${decisionColor};">${finalDecision}</div>
                                        </div>
                                        <div>
                                            <div style="font-size:0.85rem; color:#666; margin-bottom:4px;">Dataset Confidence</div>
                                            <div style="font-size:1.1rem; font-weight:600; color:#2196F3;">${confidence}%</div>
                                        </div>
                                        <div>
                                            <div style="font-size:0.85rem; color:#666; margin-bottom:4px;">Total Records</div>
                                            <div style="font-size:1.1rem; font-weight:600; color:#2d3748;">${table.total_rows || tableValidator.total_records || 0}</div>
                                        </div>
                                        <div>
                                            <div style="font-size:0.85rem; color:#666; margin-bottom:4px;">Columns Validated</div>
                                            <div style="font-size:1.1rem; font-weight:600; color:#2d3748;">${columns.length}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="padding:16px; background:#f8f9fa; border-radius:8px; margin-bottom:16px;">
                                    <div style="font-weight:600; color:#2d3748; margin-bottom:8px; font-size:1rem;">Explanation:</div>
                                    <div style="color:#666; line-height:1.6; font-size:0.95rem;">${tableValidator.explanation || 'No explanation available.'}</div>
                                </div>
                                
                                ${columns.length > 0 ? `
                                    <div>
                                        <h4 style="margin:0 0 16px 0; color:#2d3748; font-size:1.1rem; font-weight:600;">Column-wise Validation Details</h4>
                                        ${columns.map(col => {
                                            const statusColor = col.status === 'MATCH' ? '#28a745' : col.status === 'WARNING' ? '#ffc107' : '#dc3545';
                                            const statusBg = col.status === 'MATCH' ? '#f0fdf4' : col.status === 'WARNING' ? '#fffbeb' : '#fef2f2';
                                            return `
                                                <div style="padding:16px; background:${statusBg}; border-left:3px solid ${statusColor}; border-radius:6px; margin-bottom:12px;">
                                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                                        <h5 style="margin:0; color:#2d3748; font-size:1rem; font-weight:600;">${col.name || 'Unknown Column'} (${col.meaning || 'N/A'})</h5>
                                                        <span style="background:${statusBg}; color:${statusColor}; padding:4px 12px; border-radius:12px; font-size:0.85rem; font-weight:600; border:1px solid ${statusColor};">${col.status}</span>
                                                    </div>
                                                    <div style="color:#666; font-size:0.9rem; line-height:1.6;">
                                                        <p style="margin:4px 0;"><strong>Confidence:</strong> ${col.confidence || 0}%</p>
                                                        <p style="margin:4px 0;"><strong>Rules Applied:</strong> ${col.applied_rules && col.applied_rules.length > 0 ? col.applied_rules.join(', ') : 'General Rule'}</p>
                                                        ${col.failures && col.failures.length > 0 ? `
                                                            <div style="margin-top:8px; padding:8px; background:#fff2f0; border-radius:4px;">
                                                                <strong style="color:#dc3545;">Issues Found:</strong>
                                                                <ul style="margin:8px 0 0 20px; color:#dc3545;">
                                                                    ${col.failures.map(issue => `<li>${issue}</li>`).join('')}
                                                                </ul>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    validationDetailsHtml += `</div>`;
                    validationDetailsContent.innerHTML = validationDetailsHtml;
                } else if (validatorData && !validatorData.error) {
                    // Single table mode
                    const validationDetailsHtml = `
                    <div class="section-header">
                        <h2 class="section-title">üìã Validation Details</h2>
                    </div>
                    <div class="content-section">
                        <div class="status-summary-card">
                            <div class="summary-info">
                                <h3>Validation Summary</h3>
                                <p><strong>Final Decision:</strong> <span class="badge ${validatorData.final_decision === 'PASS' ? 'success' : validatorData.final_decision === 'PASS WITH WARNINGS' ? 'warning' : 'error'}">${validatorData.final_decision}</span></p>
                                <p><strong>Dataset Confidence:</strong> ${validatorData.dataset_confidence}%</p>
                                <p><strong>Total Records:</strong> ${validatorData.total_records || 0}</p>
                                <p><strong>Explanation:</strong> ${validatorData.explanation || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="section-card">
                            <h3>Column-wise Validation Details</h3>
                            ${validatorData.columns ? validatorData.columns.map(col => `
                            <div class="validation-detail-item">
                                <div class="detail-header">
                                    <h4>${col.name || 'Unknown Column'} (${col.meaning || 'N/A'})</h4>
                                    <span class="status-badge ${col.status.toLowerCase()}">${col.status}</span>
                                </div>
                                <div class="detail-content">
                                    <p><strong>Confidence:</strong> ${col.confidence}%</p>
                                    <p><strong>Rule Applied:</strong> ${col.applied_rules && col.applied_rules.length > 0 ? col.applied_rules[0] : 'General Rule'}</p>
                                    ${col.reasons && col.reasons.length > 0 ? `
                                    <p><strong>Reasons:</strong> ${col.reasons.join(', ')}</p>
                                    ` : ''}
                                    ${col.failures && col.failures.length > 0 ? `
                                    <div class="failures-section">
                                        <p><strong>Issues Found:</strong></p>
                                        <ul>
                                            ${col.failures.map(issue => `<li>${issue}</li>`).join('')}
                                        </ul>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                            `).join('') : 'No column validation details available'}
                        </div>
                        
                        ${validatorData.relationships && validatorData.relationships.length > 0 ? `
                        <div class="section-card">
                            <h3>Cross-Column Relationships</h3>
                            <ul class="relationships-list">
                                ${validatorData.relationships.map(rel => `<li>${rel.issue || rel.rule_description || rel}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    `;
                    validationDetailsContent.innerHTML = validationDetailsHtml;
                } else {
                    validationDetailsContent.innerHTML = `<div class="section-header"><h2 class="section-title">üìã Validation Details</h2></div><p>No validation details available.</p>`;
                }

                // Render PyCharts / ECharts column‚Äëpurpose chart
                if (parsedColumnPurpose && parsedColumnPurpose.category_counts) {
                    const chartDom = document.getElementById("purposeChart");
                    const counts = parsedColumnPurpose.category_counts;
                    
                    // Filter out zero values but keep them for percentage calculation
                    const seriesData = Object.keys(counts)
                        .map(k => ({
                            name: k,
                            value: counts[k] || 0  // Ensure value is a number, not undefined
                        }))
                        .filter(item => item.value > 0);  // Only show non-zero in chart
                    
                    // Calculate total for percentage display
                    const total = Object.values(counts).reduce((sum, val) => sum + (val || 0), 0);
                    
                    // Always show chart if we have category_counts data
                    if (total > 0 || Object.keys(counts).length > 0) {
                        chartDom.style.display = "block";
                        const chart = echarts.init(chartDom);
                        
                        const option = {
                            title: {
                                text: "Banking Column Purpose Distribution",
                                left: "center",
                                textStyle: { fontSize: 14 }
                            },
                            tooltip: {
                                trigger: "item",
                                formatter: function(params) {
                                    const value = params.value || 0;
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${params.name}: ${value} cols (${percentage}%)`;
                                }
                            },
                            legend: {
                                bottom: 0,
                                data: Object.keys(counts).map(k => k)
                            },
                            series: [{
                                name: "Columns",
                                type: "pie",
                                radius: "55%",
                                center: ["50%", "50%"],
                                data: seriesData.length > 0 ? seriesData : Object.keys(counts).map(k => ({
                                    name: k,
                                    value: counts[k] || 0
                                })),
                                label: {
                                    show: true,
                                    formatter: function(params) {
                                        const value = params.value || 0;
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${params.name}\n${percentage}%`;
                                    }
                                },
                                labelLine: {
                                    show: true
                                },
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: "rgba(0, 0, 0, 0.5)"
                                    }
                                }
                            }]
                        };
                        chart.setOption(option);
                    } else {
                        chartDom.style.display = "none";
                    }
                }
                
                // Render probability explanations chart
                if (parsedProbabilityExplanations && Object.keys(parsedProbabilityExplanations).length > 0) {
                    const probChartDom = document.getElementById("probabilityChart");
                    if (probChartDom) {
                        probChartDom.style.display = "block";
                        const probChart = echarts.init(probChartDom);
                        
                        // Prepare data for the chart
                        const probData = Object.entries(parsedProbabilityExplanations).map(([key, obj]) => ({
                            name: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            value: obj.probability || 0
                        }));
                        
                        const probOption = {
                            title: {
                                text: "Probability Distribution",
                                left: "center",
                                textStyle: { fontSize: 16 }
                            },
                            tooltip: {
                                trigger: "axis",
                                axisPointer: {
                                    type: "shadow"
                                },
                                formatter: function(params) {
                                    const param = params[0];
                                    return `${param.name}: ${param.value}%`;
                                }
                            },
                            xAxis: {
                                type: "category",
                                data: probData.map(item => item.name),
                                axisLabel: {
                                    rotate: 45,
                                    fontSize: 12
                                }
                            },
                            yAxis: {
                                type: "value",
                                name: "Probability %",
                                min: 0,
                                max: 100
                            },
                            series: [{
                                data: probData.map(item => item.value),
                                type: "bar",
                                itemStyle: {
                                    color: function(params) {
                                        const value = params.value;
                                        if (value >= 70) return '#27ae60';
                                        if (value >= 50) return '#f39c12';
                                        return '#e74c3c';
                                    }
                                },
                                label: {
                                    show: true,
                                    position: "top",
                                    formatter: "{c}%"
                                }
                            }]
                        };
                        
                        probChart.setOption(probOption);
                        
                        // Make chart responsive
                        window.addEventListener('resize', function() {
                            probChart.resize();
                        });
                    }
                } else {
                    const probChartDom = document.getElementById("probabilityChart");
                    if (probChartDom) {
                        probChartDom.style.display = "none";
                    }
                }
            } catch (e) {
                console.error("Error:", e);
                content.innerHTML = `
                    <div class="status-banner error">
                        <div class="status-icon">‚ùå</div>
                        <div class="status-content">
                            <h3>Error Loading Data</h3>
                            <p>${e.message}</p>
                        </div>
                    </div>
                `;
            }
        })();
    </script>
</body>
</html>