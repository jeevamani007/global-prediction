<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: #fff;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 { text-align: center; margin-bottom: 20px; }

        .upload-area {
            border: 3px dashed #667eea;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
        }

        .upload-area.dragover {
            background: #eef;
        }

        input[type=file] { display: none; }

        .file-info { margin-top: 15px; display: none; }
        .file-info.show { display: block; }

        .upload-btn {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none;
        }

        .upload-btn.show { display: block; }

        .loading { display: none; text-align: center; margin-top: 15px; }
        .loading.show { display: block; }

        .response {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
        }

        .response.show { display: block; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }

        .result-box {
            margin-top: 20px;
            background: #f5f6ff;
            padding: 15px;
            border-radius: 10px;
        }

        .domain-section {
            margin-bottom: 25px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .domain-section.banking {
            background: #e8f4f8;
            border-left-color: #2196F3;
        }

        .domain-section.financial {
            background: #f0f8e8;
            border-left-color: #4CAF50;
        }

        .domain-title {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #333;
        }

        .confidence-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }

        .confidence-high {
            background: #4CAF50;
            color: white;
        }

        .confidence-medium {
            background: #FF9800;
            color: white;
        }

        .confidence-low {
            background: #f44336;
            color: white;
        }

        ul { margin-left: 20px; margin-top: 5px; }
        pre {
            background: #eee;
            padding: 10px;
            overflow-x: auto;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <h1>üìÅ File Upload</h1>

    <div class="upload-area" id="uploadArea">
        <p>Click or Drag & Drop</p>
        <small>.sql, .csv, .xlsx, .xls</small>
    </div>

    <input type="file" id="fileInput" accept=".sql,.csv,.xlsx,.xls">

    <div class="file-info" id="fileInfo">
        <p id="fileName"></p>
        <p id="fileSize"></p>
    </div>

    <button class="upload-btn" id="uploadBtn">Upload</button>

    <div class="loading" id="loading">Uploading...</div>

    <div class="response" id="response"></div>

    <!-- üî• RESULT UI -->
    <div id="resultBox"></div>
</div>

<script>
const uploadArea = document.getElementById("uploadArea");
const fileInput = document.getElementById("fileInput");
const fileInfo = document.getElementById("fileInfo");
const fileName = document.getElementById("fileName");
const fileSize = document.getElementById("fileSize");
const uploadBtn = document.getElementById("uploadBtn");
const loading = document.getElementById("loading");
const response = document.getElementById("response");
const resultBox = document.getElementById("resultBox");

let selectedFile = null;

/* ---------------- Upload Handling ---------------- */

uploadArea.onclick = () => fileInput.click();

fileInput.onchange = e => handleFile(e.target.files[0]);

uploadArea.ondragover = e => {
    e.preventDefault();
    uploadArea.classList.add("dragover");
};

uploadArea.ondragleave = () => uploadArea.classList.remove("dragover");

uploadArea.ondrop = e => {
    e.preventDefault();
    uploadArea.classList.remove("dragover");
    handleFile(e.dataTransfer.files[0]);
};

function handleFile(file) {
    if (!file) return;

    selectedFile = file;
    fileName.textContent = "üìÑ " + file.name;
    fileSize.textContent = "Size: " + formatFileSize(file.size);

    fileInfo.classList.add("show");
    uploadBtn.classList.add("show");
}

function formatFileSize(bytes) {
    const sizes = ["Bytes", "KB", "MB"];
    let i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(2) + " " + sizes[i];
}

/* ---------------- Upload API Call ---------------- */

uploadBtn.onclick = async () => {
    const formData = new FormData();
    formData.append("file", selectedFile);

    uploadBtn.disabled = true;
    loading.classList.add("show");
    resultBox.innerHTML = "";

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 second timeout

        const res = await fetch("http://localhost:8000/upload", {
            method: "POST",
            body: formData,
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
            let errorMsg = "Upload failed";
            try {
                const errorData = await res.json();
                errorMsg = errorData.detail || errorMsg;
            } catch (e) {
                errorMsg = `Server error: ${res.status} ${res.statusText}`;
            }
            showResponse(errorMsg, "error");
            return;
        }

        const data = await res.json();

        showResponse("Upload Success ‚úÖ", "success");

        // Display both banking and financial results
        if (data.banking || data.financial) {
            showDomainResults(data.banking, data.financial);
        } else {
            showResponse("Analysis data not found in response", "error");
        }

    } catch (err) {
        let errorMsg = "Failed to fetch";
        if (err.name === "AbortError") {
            errorMsg = "Request timeout - server took too long to respond";
        } else if (err.message) {
            errorMsg = `Network error: ${err.message}`;
        } else if (err instanceof TypeError) {
            errorMsg = "Cannot connect to server. Make sure the server is running on http://localhost:8000";
        }
        showResponse(errorMsg, "error");
        console.error("Upload error:", err);
    } finally {
        uploadBtn.disabled = false;
        loading.classList.remove("show");
    }
};

function showResponse(msg, type) {
    response.textContent = msg;
    response.className = `response ${type} show`;
}

/* ---------------- RESULT UI ---------------- */

function getConfidenceClass(confidence) {
    if (confidence >= 70) return "confidence-high";
    if (confidence >= 50) return "confidence-medium";
    return "confidence-low";
}

function showDomainResults(bankingResult, financialResult) {
    let html = '<div class="results-grid">';
    
    // Banking Results
    if (bankingResult) {
        html += `
            <div class="domain-section banking">
                <h3 class="domain-title">üè¶ Banking Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(bankingResult.confidence_percentage)}">
                        ${bankingResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${bankingResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${bankingResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${bankingResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${bankingResult.confidence_percentage}% 
                    (${bankingResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${bankingResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(bankingResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${bankingResult.matched_keywords && bankingResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${bankingResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${bankingResult.matched_columns && bankingResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${bankingResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }
    
    // Financial Results
    if (financialResult) {
        html += `
            <div class="domain-section financial">
                <h3 class="domain-title">üí∞ Financial Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(financialResult.confidence_percentage)}">
                        ${financialResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${financialResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${financialResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${financialResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${financialResult.confidence_percentage}% 
                    (${financialResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${financialResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(financialResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${financialResult.matched_keywords && financialResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${financialResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${financialResult.matched_columns && financialResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${financialResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    resultBox.innerHTML = html;
}
</script>
</body>
</html>
