<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Upload System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            line-height: 1.6;
            color: #333;
        }

        .container {
            background: #fff;
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 1000px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin: 20px 0;
        }

        h1 { 
            text-align: center; 
            margin-bottom: 30px; 
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            letter-spacing: -0.5px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            padding: 50px 30px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #5568d3;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #4a5bc4;
            transform: scale(1.02);
        }

        .upload-area p {
            font-size: 1.1rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .upload-area small {
            font-size: 0.9rem;
            color: #718096;
            display: block;
        }

        input[type=file] { 
            display: none; 
        }

        .file-info { 
            margin-top: 20px; 
            display: none;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .file-info.show { 
            display: block; 
        }

        .file-info p {
            margin: 8px 0;
            font-size: 0.95rem;
            color: #2d3748;
        }

        .upload-btn {
            width: 100%;
            padding: 14px 24px;
            margin-top: 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: none;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .upload-btn:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
        }

        .upload-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .upload-btn.show { 
            display: block; 
        }

        .upload-btn.secondary {
            background: #2196F3;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        }

        .upload-btn.secondary:hover:not(:disabled) {
            background: #1976D2;
            box-shadow: 0 4px 8px rgba(33, 150, 243, 0.4);
        }

        .loading { 
            display: none; 
            text-align: center; 
            margin-top: 20px;
            padding: 16px;
            font-size: 1rem;
            color: #667eea;
            font-weight: 500;
        }

        .loading.show { 
            display: block; 
        }

        .response {
            display: none;
            margin-top: 20px;
            padding: 16px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            border-left: 4px solid;
        }

        .response.show { 
            display: block; 
        }

        .response.success { 
            background: #d4edda; 
            color: #155724;
            border-left-color: #28a745;
        }

        .response.error { 
            background: #f8d7da; 
            color: #721c24;
            border-left-color: #dc3545;
        }

        .result-box {
            margin-top: 30px;
        }

        .domain-section {
            margin-bottom: 30px;
            padding: 24px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            background: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .domain-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .domain-section.banking {
            background: linear-gradient(135deg, #e8f4f8 0%, #ffffff 100%);
            border-left-color: #2196F3;
        }
        
        .domain-section.banking-priority {
            transform: scale(1.02);
            border-left: 5px solid #2196F3;
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.3);
            animation: highlightGlow 2s infinite alternate;
        }
        
        .business-rules-summary {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            border-left: 4px solid #2196F3;
        }
        
        @keyframes highlightGlow {
            from { box-shadow: 0 6px 16px rgba(33, 150, 243, 0.3); }
            to { box-shadow: 0 6px 24px rgba(33, 150, 243, 0.5); }
        }

        .domain-section.financial {
            background: linear-gradient(135deg, #f0f8e8 0%, #ffffff 100%);
            border-left-color: #4CAF50;
        }

        .domain-section.insurance {
            background: linear-gradient(135deg, #fff6e5 0%, #ffffff 100%);
            border-left-color: #ff9800;
        }

        .domain-section.government {
            background: linear-gradient(135deg, #f5e8ff 0%, #ffffff 100%);
            border-left-color: #9c27b0;
        }

        .domain-section.healthcare {
            background: linear-gradient(135deg, #e8f5e9 0%, #ffffff 100%);
            border-left-color: #1b5e20;
        }

        .domain-section.retail {
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
            border-left-color: #e91e63;
        }

        .domain-section.space {
            background: linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%);
            border-left-color: #3f51b5;
        }

        .domain-section.human-resource {
            background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);
            border-left-color: #ff6f00;
        }

        .domain-title {
            font-size: 1.5rem;
            margin-bottom: 16px;
            color: #2d3748;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .domain-section p {
            margin: 12px 0;
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.7;
        }

        .domain-section p b {
            color: #2d3748;
            font-weight: 600;
            min-width: 140px;
            display: inline-block;
        }

        .domain-section h4 {
            margin: 20px 0 12px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .confidence-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-left: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .confidence-high {
            background: #48bb78;
            color: white;
        }

        .confidence-medium {
            background: #ed8936;
            color: white;
        }

        .confidence-low {
            background: #f56565;
            color: white;
        }

        ul { 
            margin: 12px 0 12px 24px; 
            line-height: 1.8;
        }

        ul li {
            margin: 6px 0;
            color: #4a5568;
            font-size: 0.95rem;
        }

        pre {
            background: #f7fafc;
            padding: 16px;
            overflow-x: auto;
            border-radius: 8px;
            font-size: 0.875rem;
            border: 1px solid #e2e8f0;
            color: #2d3748;
            line-height: 1.6;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 24px;
                margin: 10px 0;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 24px;
            }

            .upload-area {
                padding: 40px 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .domain-section {
                padding: 20px;
            }

            .domain-title {
                font-size: 1.3rem;
            }

            .domain-section p b {
                min-width: 100px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }

            .upload-area {
                padding: 30px 15px;
            }

            .upload-area p {
                font-size: 1rem;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <h1>üìÅ File Upload</h1>

    <div class="upload-area" id="uploadArea">
        <p>Click or Drag & Drop</p>
        <small>.sql, .csv, .xlsx, .xls (Multiple files supported)</small>
    </div>

    <input type="file" id="fileInput" accept=".sql,.csv,.xlsx,.xls" multiple>

    <div class="file-info" id="fileInfo">
        <p id="fileName"></p>
        <p id="fileSize"></p>
    </div>

    <button class="upload-btn" id="uploadBtn">Upload</button>

    <div class="loading" id="loading">Uploading...</div>

    <div class="response" id="response"></div>

    <!-- üî• RESULT UI -->
    <div id="resultBox"></div>

    <button class="upload-btn secondary" id="accountBtn" style="margin-top: 20px; display: none;">
        View Account Number Detection
    </button>
</div>

<script>
const uploadArea = document.getElementById("uploadArea");
const fileInput = document.getElementById("fileInput");
const fileInfo = document.getElementById("fileInfo");
const fileName = document.getElementById("fileName");
const fileSize = document.getElementById("fileSize");
const uploadBtn = document.getElementById("uploadBtn");
const loading = document.getElementById("loading");
const response = document.getElementById("response");
const resultBox = document.getElementById("resultBox");
const accountBtn = document.getElementById("accountBtn");

let selectedFiles = [];

/* ---------------- Upload Handling ---------------- */

uploadArea.onclick = () => fileInput.click();

fileInput.onchange = e => handleFiles(e.target.files);

uploadArea.ondragover = e => {
    e.preventDefault();
    uploadArea.classList.add("dragover");
};

uploadArea.ondragleave = () => uploadArea.classList.remove("dragover");

uploadArea.ondrop = e => {
    e.preventDefault();
    uploadArea.classList.remove("dragover");
    handleFiles(e.dataTransfer.files);
};

function handleFiles(files) {
    if (!files || files.length === 0) return;

    selectedFiles = Array.from(files);
    
    if (selectedFiles.length === 1) {
        fileName.textContent = "üìÑ " + selectedFiles[0].name;
        fileSize.textContent = "Size: " + formatFileSize(selectedFiles[0].size);
    } else {
        fileName.textContent = `üìÑ ${selectedFiles.length} files selected`;
        const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
        fileSize.innerHTML = "Total Size: " + formatFileSize(totalSize) + "<br>" +
            selectedFiles.map(f => `  ‚Ä¢ ${f.name} (${formatFileSize(f.size)})`).join('<br>');
    }

    fileInfo.classList.add("show");
    uploadBtn.classList.add("show");
}

function formatFileSize(bytes) {
    const sizes = ["Bytes", "KB", "MB"];
    let i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(2) + " " + sizes[i];
}

/* ---------------- Upload API Call ---------------- */

uploadBtn.onclick = async () => {
    const formData = new FormData();
    
    // Use multi-file endpoint if multiple files, otherwise single-file endpoint
    const isMultiFile = selectedFiles.length > 1;
    const endpoint = isMultiFile ? "http://localhost:8000/upload-multiple" : "http://localhost:8000/upload";
    
    if (isMultiFile) {
        // Multi-file mode
        selectedFiles.forEach(file => {
            formData.append("files", file);
        });
    } else {
        // Single file mode (backward compatible)
        formData.append("file", selectedFiles[0]);
    }

    uploadBtn.disabled = true;
    loading.classList.add("show");
    resultBox.innerHTML = "";

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 120000); // 120 second timeout for multi-file

        const res = await fetch(endpoint, {
            method: "POST",
            body: formData,
            signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!res.ok) {
            let errorMsg = "Upload failed";
            try {
                const errorData = await res.json();
                errorMsg = errorData.detail || errorMsg;
            } catch (e) {
                errorMsg = `Server error: ${res.status} ${res.statusText}`;
            }
            showResponse(errorMsg, "error");
            return;
        }

        const data = await res.json();

        showResponse("Upload Success ‚úÖ", "success");

        // Store account validation data for account.html page
        if (data.banking_account_validation) {
            sessionStorage.setItem("accountValidation", JSON.stringify(data.banking_account_validation));
        }
        if (data.banking_account_check) {
            sessionStorage.setItem("accountNumberCheck", JSON.stringify(data.banking_account_check));
        } else if (data.banking && data.banking.account_number_check) {
            sessionStorage.setItem("accountNumberCheck", JSON.stringify(data.banking.account_number_check));
        }
        if (data.banking_account_status) {
            sessionStorage.setItem("accountStatus", JSON.stringify(data.banking_account_status));
        }
        if (data.banking_missing_columns) {
            sessionStorage.setItem("missingColumns", JSON.stringify(data.banking_missing_columns));
        }
        if (data.banking_balance_analysis) {
            sessionStorage.setItem("balanceAnalysis", JSON.stringify(data.banking_balance_analysis));
        }
        // KYC and Branch Code removed - no longer storing in sessionStorage
        if (data.banking_customer_id_validation) {
            sessionStorage.setItem("customerIdValidation", JSON.stringify(data.banking_customer_id_validation));
        }
        if (data.banking_transaction_validation) {
            sessionStorage.setItem("transactionValidation", JSON.stringify(data.banking_transaction_validation));
        }
        if (data.banking_transaction_type_validation) {
            sessionStorage.setItem("transactionTypeValidation", JSON.stringify(data.banking_transaction_type_validation));
        }
        if (data.banking_pan_validation) {
            sessionStorage.setItem("panValidation", JSON.stringify(data.banking_pan_validation));
        }
        if (data.banking_debit_credit_validation) {
            sessionStorage.setItem("debitCreditValidation", JSON.stringify(data.banking_debit_credit_validation));
        }
        if (data.banking_fraud_detection) {
            sessionStorage.setItem("fraudDetection", JSON.stringify(data.banking_fraud_detection));
        }
        if (data.banking_foreign_key_check) {
            sessionStorage.setItem("foreignKeyCheck", JSON.stringify(data.banking_foreign_key_check));
        }
        if (data.banking_purpose_detection) {
            sessionStorage.setItem("purposeDetection", JSON.stringify(data.banking_purpose_detection));
        }
        if (data.banking_final_decision) {
            sessionStorage.setItem("finalDecision", JSON.stringify(data.banking_final_decision));
        }
        if (data.banking_risk_assessment) {
            sessionStorage.setItem("riskAssessment", JSON.stringify(data.banking_risk_assessment));
        }
        if (data.banking_column_purpose_report) {
            sessionStorage.setItem("columnPurposeReport", JSON.stringify(data.banking_column_purpose_report));
        }
        if (data.banking_probability_explanations) {
            sessionStorage.setItem("probabilityExplanations", JSON.stringify(data.banking_probability_explanations));
        }
        if (data.banking_transaction_rules) {
            sessionStorage.setItem("bankingTransactionRules", JSON.stringify(data.banking_transaction_rules));
        }
        if (data.banking_dataset_validator) {
            sessionStorage.setItem("bankingDatasetValidator", JSON.stringify(data.banking_dataset_validator));
        }
        if (data.core_banking_validator) {
            sessionStorage.setItem("coreBankingValidator", JSON.stringify(data.core_banking_validator));
        }
        
        // Store multi-file metadata if available
        if (data.multi_file_mode) {
            sessionStorage.setItem("multiFileMode", "true");
            if (data.relationships) {
                sessionStorage.setItem("multiFileRelationships", JSON.stringify(data.relationships));
            }
            if (data.primary_keys) {
                sessionStorage.setItem("multiFilePrimaryKeys", JSON.stringify(data.primary_keys));
            }
            if (data.foreign_keys) {
                sessionStorage.setItem("multiFileForeignKeys", JSON.stringify(data.foreign_keys));
            }
            if (data.domain_detection) {
                sessionStorage.setItem("multiFileDomainDetection", JSON.stringify(data.domain_detection));
            }
            if (data.table_results) {
                sessionStorage.setItem("multiFileTableResults", JSON.stringify(data.table_results));
            }
        } else {
            sessionStorage.setItem("multiFileMode", "false");
        }

        // Display domain results on index.html page
        // Always show results if any domain data exists
        if (data.banking || data.financial || data.insurance || data.government || data.healthcare || data.retail || data.space || data.human_resource) {
            console.log("Banking data:", data.banking);
            console.log("Banking account validation:", data.banking_account_validation);
            
            showDomainResults(
                data.banking,
                data.banking_account_validation,
                data.financial,
                data.insurance,
                data.government,
                data.healthcare,
                data.retail,
                data.space,
                data.human_resource,
                data.banking_dataset_validator,
                data.core_banking_validator
            );

            // Show account button with HIGH PRIORITY when banking domain is detected
            if (data.banking && data.banking !== null) {
                // Check if this is a high-priority banking detection
                const isHighPriority = data.banking.decision && data.banking.decision.toLowerCase() !== 'unknown' && (data.banking.confidence_percentage || 0) > 70;
                
                accountBtn.style.display = "block";
                console.log("Account button should be visible");
                
                // Update button text for high priority detections
                if (isHighPriority) {
                    accountBtn.innerHTML = "View Banking Validation Results (HIGH PRIORITY)";
                    accountBtn.style.background = "linear-gradient(135deg, #1976D2 0%, #0D47A1 100%)";
                    accountBtn.style.boxShadow = "0 4px 12px rgba(25, 118, 210, 0.4)";
                } else {
                    accountBtn.innerHTML = "View Account Number Detection";
                    accountBtn.style.background = "linear-gradient(135deg, #2196F3 0%, #1976D2 100%)";
                    accountBtn.style.boxShadow = "0 2px 4px rgba(33, 150, 243, 0.3)";
                }
            } else {
                accountBtn.style.display = "none";
                console.log("Account button hidden - no banking data");
            }
        } else {
            showResponse("Analysis data not found in response", "error");
            accountBtn.style.display = "none";
        }

    } catch (err) {
        let errorMsg = "Failed to fetch";
        if (err.name === "AbortError") {
            errorMsg = "Request timeout - server took too long to respond";
        } else if (err.message) {
            errorMsg = `Network error: ${err.message}`;
        } else if (err instanceof TypeError) {
            errorMsg = "Cannot connect to server. Make sure the server is running on http://localhost:8000";
        }
        showResponse(errorMsg, "error");
        console.error("Upload error:", err);
    } finally {
        uploadBtn.disabled = false;
        loading.classList.remove("show");
    }
};

accountBtn.onclick = () => {
    window.location.href = "/account";
};

function showResponse(msg, type) {
    response.textContent = msg;
    response.className = `response ${type} show`;
}

/* ---------------- RESULT UI ---------------- */

function getConfidenceClass(confidence) {
    if (confidence >= 70) return "confidence-high";
    if (confidence >= 50) return "confidence-medium";
    return "confidence-low";
}

function buildColumnExplanation(col) {
    const name = col.name || "Unknown column";
    const meaning = col.meaning || "";
    const status = (col.status || "").toUpperCase();
    const confidence = typeof col.confidence === "number" ? `${col.confidence}%` : "unknown confidence";
    const rules = Array.isArray(col.applied_rules) ? col.applied_rules.filter(Boolean) : [];
    const issues = Array.isArray(col.failures) ? col.failures.filter(Boolean) : [];

    let intro = `The column "${name}" is treated as ${meaning ? `"${meaning}"` : "a banking-related field"}. `;

    let ruleText = "";
    if (rules.length === 1) {
        ruleText = `The validator applied the following business rule: ${rules[0]}. `;
    } else if (rules.length > 1) {
        ruleText = `The validator applied multiple business rules, including: ${rules.join(", ")}. `;
    } else {
        ruleText = "The validator applied standard banking pattern checks for this column (format, consistency, and missing values). ";
    }

    let resultText = `Overall, this column ${status === "MATCH" ? "meets" : status === "WARNING" ? "mostly meets" : "does not fully meet"} the expected behaviour with a confidence of ${confidence}. `;

    let issueText = "";
    if (issues.length > 0) {
        issueText = `The main issues detected are: ${issues.join("; ")}. `;
    } else if (status !== "MATCH") {
        issueText = "Some values do not fully follow the expected business behaviour, so you may want to review this column in more detail. ";
    } else {
        issueText = "No major issues were detected in this column based on the applied rules. ";
    }

    return intro + ruleText + resultText + issueText;
}

function renderRuleList(rules) {
    if (!rules) return "";
    return `
        <ul>
            <li>Digits only: ${rules.digits_only_ratio ?? "N/A"}</li>
            <li>Length 6-16: ${rules.length_6_16_ratio ?? "N/A"}</li>
            <li>Unique: ${rules.unique_ratio ?? "N/A"}</li>
            <li>Not null: ${rules.not_null_ratio ?? "N/A"}</li>
            <li>No symbols: ${rules.no_symbol_ratio ?? "N/A"}</li>
            <li>Randomized: ${rules.randomized ?? "N/A"}</li>
        </ul>
    `;
}

function renderAccountValidation(accountValidation) {
    if (!accountValidation || !accountValidation.account_like_columns || accountValidation.account_like_columns.length === 0) {
        return "<p>No account-like columns detected.</p>";
    }

    const best = accountValidation.summary?.best_match;
    const cards = accountValidation.account_like_columns.map(item => `
        <div style="margin-bottom:12px;padding:10px;border-radius:8px;background:#f0f4ff;">
            <p><b>Column:</b> ${item.column}</p>
            <p><b>Decision:</b> ${item.decision}</p>
            <p><b>Probability:</b> ${item.probability_account_number}%</p>
            <p><b>Rules:</b></p>
            ${renderRuleList(item.rules)}
            ${item.sample_violations && item.sample_violations.length ? `
                <p><b>Sample violations:</b></p>
                <ul>${item.sample_violations.map(v => `<li>${v}</li>`).join("")}</ul>
            ` : ""}
        </div>
    `).join("");

    return `
        <div style="margin-top:10px;">
            ${best ? `<p><b>Best match:</b> ${best.column} (${best.probability_account_number}% - ${best.decision})</p>` : ""}
            ${cards}
        </div>
    `;
}

function showDomainResults(bankingResult, bankingAccountValidation, financialResult, insuranceResult, governmentResult, healthcareResult, retailResult, spaceResult, humanResourceResult, bankingValidatorResult, coreBankingValidatorResult) {
    let html = '<div class="results-grid">';
    
    // Banking Results - ALWAYS SHOW FIRST with HIGH PRIORITY when banking data exists
    if (bankingResult && bankingResult !== null && typeof bankingResult === 'object') {
        const bankingConfidence = bankingResult.confidence_percentage || 0;
        // Highlight banking domain with special prominence when keywords match
        const isHighPriority = bankingResult.decision && bankingResult.decision.toLowerCase() !== 'unknown' && bankingConfidence > 70;
        const bankingSectionClass = isHighPriority ? 'domain-section banking banking-priority' : 'domain-section banking';
        
        html += `
            <div class="${bankingSectionClass}" style="${isHighPriority ? 'transform: scale(1.02); border-left: 5px solid #2196F3; box-shadow: 0 6px 16px rgba(33, 150, 243, 0.3);' : ''}">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                    <h3 class="domain-title">
                        <span style="font-size:1.8rem; margin-right:10px;">üè¶</span> Banking Domain Detection
                        <span class="confidence-badge ${getConfidenceClass(bankingConfidence)}">
                            ${bankingConfidence}%
                        </span>
                    </h3>
                    ${isHighPriority ? `<span style="background:#2196F3; color:white; padding:6px 12px; border-radius:20px; font-size:0.9rem; font-weight:600;">HIGH PRIORITY</span>` : ''}
                </div>
                
                <div class="info-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin:16px 0;">
                    <div style="background:white; padding:12px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.8rem; font-weight:bold; color:${bankingConfidence >= 70 ? '#4CAF50' : bankingConfidence >= 50 ? '#FF9800' : '#f44336'};">${bankingConfidence}%</div>
                        <div style="font-size:0.9rem; color:#666; font-weight:600;">BANKING DOMAIN CONFIDENCE</div>
                    </div>
                    <div style="background:white; padding:12px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.8rem; font-weight:bold; color:#2196F3;">${bankingResult.decision || "N/A"}</div>
                        <div style="font-size:0.9rem; color:#666; font-weight:600;">FINAL DECISION</div>
                    </div>
                    <div style="background:white; padding:12px; border-radius:8px; text-align:center;">
                        <div style="font-size:1.8rem; font-weight:bold; color:#673AB7;">${bankingResult.total_columns || 0}</div>
                        <div style="font-size:0.9rem; color:#666; font-weight:600;">TOTAL COLUMNS</div>
                    </div>
                </div>
                
                <div class="business-rules-summary" style="margin:16px 0;">
                    <div style="display:flex; justify-content:space-around; text-align:center; flex-wrap:wrap; gap:16px;">
                        <div style="min-width:120px;">
                            <div style="font-size:1.4rem; font-weight:bold; color:#2196F3;">${bankingResult.domain || "Unknown"}</div>
                            <div style="font-size:0.85rem; color:#666;">Domain Detected</div>
                        </div>
                        <div style="min-width:120px;">
                            <div style="font-size:1.4rem; font-weight:bold; color:#673AB7;">${bankingResult.qualitative || "N/A"}</div>
                            <div style="font-size:0.85rem; color:#666;">Strength</div>
                        </div>
                        <div style="min-width:120px;">
                            <div style="font-size:1.4rem; font-weight:bold; color:#FF9800;">${bankingResult.confidence_out_of_10 || 0}/10</div>
                            <div style="font-size:0.85rem; color:#666;">Rating</div>
                        </div>
                    </div>
                    <p style="text-align:center; margin:12px 0 0 0; font-size:0.9rem; color:#666;"><b>Empty Columns:</b> ${(bankingResult.empty_columns || []).join(", ") || "None"}</p>
                </div>
                
                ${bankingResult.matched_keywords && bankingResult.matched_keywords.length > 0 ? `
                    <div style="margin:16px 0;">
                        <h4 style="color:#2196F3; margin-bottom:8px; display:flex; align-items:center;">
                            <span style="margin-right:8px;">üîç</span> Matched Keywords (${bankingResult.matched_keywords.length})
                        </h4>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            ${bankingResult.matched_keywords.map(k => `<span style="background:#e3f2fd; padding:6px 12px; border-radius:20px; font-size:0.85rem; color:#1976D2;">${k}</span>`).join("")}
                        </div>
                    </div>
                ` : ''}
                
                ${bankingResult.matched_columns && bankingResult.matched_columns.length > 0 ? `
                    <div style="margin:16px 0;">
                        <h4 style="color:#2196F3; margin-bottom:8px; display:flex; align-items:center;">
                            <span style="margin-right:8px;">üìã</span> Matched Columns (${bankingResult.matched_columns.length})
                        </h4>
                        <div style="display:flex; flex-wrap:wrap; gap:8px;">
                            ${bankingResult.matched_columns.map(c => `<span style="background:#e3f2fd; padding:6px 12px; border-radius:20px; font-size:0.85rem; color:#1976D2; font-family:monospace;">${c}</span>`).join("")}
                        </div>
                    </div>
                ` : ''}
                
                ${bankingAccountValidation ? `
                    <div style="margin:20px 0; padding:16px; background:#fff8e1; border-radius:8px; border-left:4px solid #ffc107;">
                        <h4 style="color:#e65100; margin-top:0; margin-bottom:12px; display:flex; align-items:center;">
                            <span style="margin-right:8px;">üí≥</span> Account Number Detection
                        </h4>
                        ${renderAccountValidation(bankingAccountValidation)}
                    </div>
                ` : '<p style="margin:20px 0; padding:12px; background:#f8f9ff; border-radius:8px;">Account validation data not available.</p>'}
                
                ${bankingValidatorResult && !bankingValidatorResult.error ? `
                    <div style="margin:20px 0; padding:20px; background:#f0f8ff; border-radius:12px; border-left:5px solid #2196F3; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
                            <h4 style="margin:0; color:#1976D2; display:flex; align-items:center;">
                                <span style="margin-right:8px; font-size:1.2rem;">‚öñÔ∏è</span> Banking Dataset Validator Results
                            </h4>
                            <span style="padding:6px 12px; border-radius:20px; font-weight:600; ${bankingValidatorResult.final_decision === 'PASS' ? 'background:#4CAF50; color:white;' : bankingValidatorResult.final_decision === 'PASS WITH WARNINGS' ? 'background:#FF9800; color:white;' : 'background:#f44336; color:white;'}">
                                ${bankingValidatorResult.final_decision}
                            </span>
                        </div>
                        
                        <div style="display:flex; gap:16px; margin:16px 0; flex-wrap:wrap;">
                            <div style="flex:1; min-width:150px; background:white; padding:12px; border-radius:8px; text-align:center;">
                                <div style="font-size:1.4rem; font-weight:bold; color:#2196F3;">${bankingValidatorResult.dataset_confidence}%</div>
                                <div style="font-size:0.8rem; color:#666;">Dataset Confidence</div>
                            </div>
                            <div style="flex:1; min-width:150px; background:white; padding:12px; border-radius:8px; text-align:center;">
                                <div style="font-size:1.4rem; font-weight:bold; color:#4CAF50;">${bankingValidatorResult.columns ? bankingValidatorResult.columns.length : 0}</div>
                                <div style="font-size:0.8rem; color:#666;">Columns Validated</div>
                            </div>
                            <div style="flex:1; min-width:150px; background:white; padding:12px; border-radius:8px; text-align:center;">
                                <div style="font-size:1.4rem; font-weight:bold; color:#9C27B0;">${bankingValidatorResult.relationships ? bankingValidatorResult.relationships.length : 0}</div>
                                <div style="font-size:0.8rem; color:#666;">Relationships Checked</div>
                            </div>
                        </div>
                        
                        <p><b>Explanation:</b> ${bankingValidatorResult.explanation || 'N/A'}</p>
                        
                        ${bankingValidatorResult.columns && bankingValidatorResult.columns.length > 0 ? `
                            <div style="margin-top:20px;">
                                <h5 style="color:#1976D2; font-weight:600; margin-bottom:12px; font-size:1.1rem; display:flex; align-items:center; gap:8px;">
                                    <span>üìä</span> Column-Level Validation Explanation (${bankingValidatorResult.columns.length} columns)
                                </h5>
                                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px;">
                                    ${bankingValidatorResult.columns.map(col => `
                                        <div style="padding:14px; background:white; border-radius:8px; border:1px solid ${col.status === 'MATCH' ? '#4CAF50' : col.status === 'WARNING' ? '#FF9800' : '#f44336'}; border-left:4px solid ${col.status === 'MATCH' ? '#4CAF50' : col.status === 'WARNING' ? '#FF9800' : '#f44336'}; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                                            <div style="display:flex; justify-content:space-between; align-items-start; margin-bottom:8px;">
                                                <div style="flex:1;">
                                                    <b style="font-size:1.05rem; color:#2d3748; display:block;">${col.name}</b>
                                                    <div style="font-size:0.85rem; color:#666; margin-top:4px;">Meaning: ${col.meaning || 'N/A'}</div>
                                                </div>
                                                <span style="padding:4px 10px; border-radius:12px; font-size:0.8rem; font-weight:600; ${col.status === 'MATCH' ? 'background:#4CAF50; color:white;' : col.status === 'WARNING' ? 'background:#FF9800; color:white;' : 'background:#f44336; color:white;'}">
                                                    ${col.status}
                                                </span>
                                            </div>
                                            <p style="margin-top:8px; font-size:0.9rem; color:#4a5568; line-height:1.6;">
                                                ${buildColumnExplanation(col)}
                                            </p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                
                <!-- Core Banking Validator only shown in account.html, not in index.html -->
            </div>
        `;
    } else if (bankingResult !== null && bankingResult !== undefined) {
        // Fallback: show basic banking info even if structure is unexpected
        html += `
            <div class="domain-section banking">
                <h3 class="domain-title">üè¶ Banking Domain Detection</h3>
                <p>Banking data received but format may be unexpected.</p>
                <pre>${JSON.stringify(bankingResult, null, 2).substring(0, 200)}</pre>
            </div>
        `;
    }
    
    // Financial Results (hide if explicitly skipped after banking success)
    if (financialResult && financialResult.decision !== "SKIPPED") {
        html += `
            <div class="domain-section financial">
                <h3 class="domain-title">üí∞ Financial Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(financialResult.confidence_percentage)}">
                        ${financialResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${financialResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${financialResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${financialResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${financialResult.confidence_percentage}% 
                    (${financialResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${financialResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(financialResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${financialResult.matched_keywords && financialResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${financialResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${financialResult.matched_columns && financialResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${financialResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }

    // Insurance Results
    if (insuranceResult) {
        html += `
            <div class="domain-section insurance">
                <h3 class="domain-title">üõ°Ô∏è Insurance Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(insuranceResult.confidence_percentage)}">
                        ${insuranceResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${insuranceResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${insuranceResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${insuranceResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${insuranceResult.confidence_percentage}% 
                    (${insuranceResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${insuranceResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(insuranceResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${insuranceResult.matched_keywords && insuranceResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${insuranceResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${insuranceResult.matched_columns && insuranceResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${insuranceResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }

    // Government Results
    if (governmentResult) {
        html += `
            <div class="domain-section government">
                <h3 class="domain-title">üèõÔ∏è Government Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(governmentResult.confidence_percentage)}">
                        ${governmentResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${governmentResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${governmentResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${governmentResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${governmentResult.confidence_percentage}% 
                    (${governmentResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${governmentResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(governmentResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${governmentResult.matched_keywords && governmentResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${governmentResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${governmentResult.matched_columns && governmentResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${governmentResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }

    // Healthcare Results
    if (healthcareResult) {
        html += `
            <div class="domain-section healthcare">
                <h3 class="domain-title">ü©∫ Healthcare Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(healthcareResult.confidence_percentage)}">
                        ${healthcareResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${healthcareResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${healthcareResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${healthcareResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${healthcareResult.confidence_percentage}% 
                    (${healthcareResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${healthcareResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(healthcareResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${healthcareResult.matched_keywords && healthcareResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${healthcareResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${healthcareResult.matched_columns && healthcareResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${healthcareResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }

    // Retail Results
    if (retailResult) {
        html += `
            <div class="domain-section retail">
                <h3 class="domain-title">üõçÔ∏è Retail Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(retailResult.confidence_percentage)}">
                        ${retailResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${retailResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${retailResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${retailResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${retailResult.confidence_percentage}% 
                    (${retailResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${retailResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(retailResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${retailResult.matched_keywords && retailResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${retailResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${retailResult.matched_columns && retailResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${retailResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }

    // Space Results
    if (spaceResult) {
        html += `
            <div class="domain-section space">
                <h3 class="domain-title">üöÄ Space Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(spaceResult.confidence_percentage)}">
                        ${spaceResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${spaceResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${spaceResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${spaceResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${spaceResult.confidence_percentage}% 
                    (${spaceResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${spaceResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(spaceResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${spaceResult.matched_keywords && spaceResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${spaceResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${spaceResult.matched_columns && spaceResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${spaceResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }

    // Human Resource Results
    if (humanResourceResult) {
        html += `
            <div class="domain-section human-resource">
                <h3 class="domain-title">üë• Human Resource Domain Detection
                    <span class="confidence-badge ${getConfidenceClass(humanResourceResult.confidence_percentage)}">
                        ${humanResourceResult.confidence_percentage}%
                    </span>
                </h3>
                <p><b>Domain:</b> ${humanResourceResult.domain || "Unknown"}</p>
                <p><b>Decision:</b> ${humanResourceResult.decision || "N/A"}</p>
                <p><b>Strength:</b> ${humanResourceResult.qualitative || "N/A"}</p>
                <p><b>Confidence:</b> ${humanResourceResult.confidence_percentage}% 
                    (${humanResourceResult.confidence_out_of_10}/10)</p>
                <p><b>Total Columns:</b> ${humanResourceResult.total_columns || 0}</p>
                <p><b>Empty Columns:</b> ${(humanResourceResult.empty_columns || []).join(", ") || "None"}</p>
                
                ${humanResourceResult.matched_keywords && humanResourceResult.matched_keywords.length > 0 ? `
                    <h4>Matched Keywords</h4>
                    <ul>${humanResourceResult.matched_keywords.map(k => `<li>${k}</li>`).join("")}</ul>
                ` : ''}
                
                ${humanResourceResult.matched_columns && humanResourceResult.matched_columns.length > 0 ? `
                    <h4>Matched Columns</h4>
                    <ul>${humanResourceResult.matched_columns.map(c => `<li>${c}</li>`).join("")}</ul>
                ` : ''}
            </div>
        `;
    }
    
    html += '</div>';
    resultBox.innerHTML = html;
}

/* ---------------- CORE BANKING VALIDATOR RENDERER ---------------- */

function renderCoreBankingValidator(result) {
    if (!result || result.error) return '';
    
    const decision = result.final_decision || 'UNKNOWN';
    const decisionColor = decision === 'PASS' ? '#4CAF50' : decision === 'PASS WITH WARNINGS' ? '#FF9800' : '#f44336';
    const decisionIcon = decision === 'PASS' ? '‚úÖ' : decision === 'PASS WITH WARNINGS' ? '‚ö†Ô∏è' : '‚ùå';
    
    let html = `
        <div style="margin-top:30px; padding:24px; background:linear-gradient(135deg, #e3f2fd 0%, #ffffff 100%); border-radius:12px; border-left:5px solid ${decisionColor}; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px;">
                <h3 style="margin:0; font-size:1.5rem; color:#1976D2; font-weight:700;">
                    üîê Core Banking Dataset Validation Engine
                </h3>
                <span style="padding:8px 16px; border-radius:20px; background:${decisionColor}; color:white; font-weight:bold; font-size:0.95rem;">
                    ${decisionIcon} ${decision}
                </span>
            </div>
            
            <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <p style="margin:8px 0; font-size:1rem;"><b style="color:#424242;">Final Reason:</b> <span style="color:#616161;">${result.final_reason || 'N/A'}</span></p>
            </div>
    `;
    
    // Domain Detection
    if (result.detected_domain) {
        const domain = result.detected_domain;
        html += `
            <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="margin:0 0 12px 0; color:#1976D2; font-size:1.1rem; font-weight:600;">üìã Domain Detection</h4>
                <p style="margin:6px 0;"><b>Domain:</b> ${domain.domain || 'N/A'}</p>
                <p style="margin:6px 0;"><b>Confidence:</b> <span style="padding:4px 8px; background:#e3f2fd; border-radius:4px; font-weight:600;">${domain.confidence || 0}%</span></p>
                <p style="margin:6px 0;"><b>Purpose:</b> ${domain.purpose || 'N/A'}</p>
            </div>
        `;
    }
    
    // Column Identification
    if (result.column_identification) {
        const colId = result.column_identification;
        const identifiedCols = Object.entries(colId.identified_columns || {}).filter(([k, v]) => v !== null);
        
        html += `
            <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="margin:0 0 12px 0; color:#1976D2; font-size:1.1rem; font-weight:600;">üîç Column Identification</h4>
                <p style="margin:6px 0;"><b>Total Columns:</b> ${colId.total_columns || 0}</p>
                <p style="margin:6px 0;"><b>Identified:</b> ${colId.identified_count || 0}</p>
                <details style="margin-top:12px;">
                    <summary style="cursor:pointer; color:#1976D2; font-weight:600; padding:8px; background:#f5f5f5; border-radius:4px;">View Identified Columns</summary>
                    <div style="margin-top:8px; max-height:300px; overflow-y:auto;">
                        ${identifiedCols.map(([col, role]) => `
                            <div style="margin:6px 0; padding:8px; background:#f5f5f5; border-radius:4px; border-left:3px solid #2196F3;">
                                <b>${col}</b> ‚Üí <span style="color:#1976D2; font-weight:600;">${role}</span>
                            </div>
                        `).join('')}
                    </div>
                </details>
            </div>
        `;
    }
    
    // Critical Rules
    if (result.critical_rules && result.critical_rules.length > 0) {
        html += `
            <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="margin:0 0 12px 0; color:#d32f2f; font-size:1.1rem; font-weight:600;">üö® CRITICAL Rules</h4>
        `;
        
        result.critical_rules.forEach(rule => {
            const ruleStatus = rule.status || 'UNKNOWN';
            const ruleColor = ruleStatus === 'PASS' ? '#4CAF50' : '#f44336';
            const ruleIcon = ruleStatus === 'PASS' ? '‚úÖ' : '‚ùå';
            
            html += `
                <div style="margin:12px 0; padding:12px; background:#fafafa; border-radius:6px; border-left:4px solid ${ruleColor};">
                    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                        <h5 style="margin:0; font-size:1rem; font-weight:600; color:#424242;">${ruleIcon} ${rule.rule_name}</h5>
                        <span style="padding:4px 10px; border-radius:12px; background:${ruleColor}; color:white; font-weight:600; font-size:0.85rem;">
                            ${ruleStatus}
                        </span>
                    </div>
                    ${rule.violations && rule.violations.length > 0 ? `
                        <div style="margin-top:8px;">
                            <p style="margin:4px 0; color:#d32f2f; font-weight:600; font-size:0.9rem;">Violations (${rule.violation_count || 0}):</p>
                            <ul style="margin:4px 0 0 20px; color:#616161; font-size:0.9rem;">
                                ${rule.violations.slice(0, 5).map(v => `<li>${v}</li>`).join('')}
                                ${rule.violations.length > 5 ? `<li><em>... and ${rule.violations.length - 5} more</em></li>` : ''}
                            </ul>
                        </div>
                    ` : '<p style="margin:4px 0; color:#4CAF50; font-size:0.9rem;">‚úì No violations found</p>'}
                </div>
            `;
        });
        
        html += `</div>`;
    }
    
    // Warning Rules
    if (result.warning_rules && result.warning_rules.length > 0) {
        html += `
            <div style="background:white; padding:16px; border-radius:8px; margin-bottom:16px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="margin:0 0 12px 0; color:#ff9800; font-size:1.1rem; font-weight:600;">‚ö†Ô∏è WARNING Rules</h4>
        `;
        
        result.warning_rules.forEach(warning => {
            html += `
                <div style="margin:8px 0; padding:10px; background:#fff3e0; border-radius:6px; border-left:3px solid #ff9800;">
                    <p style="margin:4px 0; font-weight:600; color:#e65100;">${warning.rule_name}</p>
                    <p style="margin:4px 0; color:#616161; font-size:0.9rem;"><b>Column:</b> ${warning.column || 'N/A'}</p>
                    <p style="margin:4px 0; color:#616161; font-size:0.9rem;"><b>Issue:</b> ${warning.issue || 'N/A'}</p>
                </div>
            `;
        });
        
        html += `</div>`;
    }
    
    // Dataset Summary
    if (result.dataset_summary) {
        const summary = result.dataset_summary;
        html += `
            <div style="background:white; padding:16px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <h4 style="margin:0 0 12px 0; color:#1976D2; font-size:1.1rem; font-weight:600;">üìä Dataset Summary</h4>
                <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px;">
                    <div style="padding:12px; background:#e3f2fd; border-radius:6px; text-align:center;">
                        <p style="margin:0; font-size:1.5rem; font-weight:700; color:#1976D2;">${summary.total_rows || 0}</p>
                        <p style="margin:4px 0 0 0; font-size:0.85rem; color:#616161;">Total Rows</p>
                    </div>
                    <div style="padding:12px; background:#e3f2fd; border-radius:6px; text-align:center;">
                        <p style="margin:0; font-size:1.5rem; font-weight:700; color:#1976D2;">${summary.total_columns || 0}</p>
                        <p style="margin:4px 0 0 0; font-size:0.85rem; color:#616161;">Total Columns</p>
                    </div>
                    <div style="padding:12px; background:#ffebee; border-radius:6px; text-align:center;">
                        <p style="margin:0; font-size:1.5rem; font-weight:700; color:#d32f2f;">${summary.critical_violations || 0}</p>
                        <p style="margin:4px 0 0 0; font-size:0.85rem; color:#616161;">Critical Violations</p>
                    </div>
                    <div style="padding:12px; background:#fff3e0; border-radius:6px; text-align:center;">
                        <p style="margin:0; font-size:1.5rem; font-weight:700; color:#ff9800;">${summary.warning_count || 0}</p>
                        <p style="margin:4px 0 0 0; font-size:0.85rem; color:#616161;">Warnings</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    html += `</div>`;
    return html;
}
</script>
</body>
</html>
